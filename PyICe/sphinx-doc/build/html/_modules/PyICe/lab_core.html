<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>PyICe.lab_core &mdash; PyICe 9000 documentation</title>
    
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '9000',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="shortcut icon" href="../../_static/tssop.ico"/>
    <link rel="top" title="PyICe 9000 documentation" href="../../PyICe.html" />
    <link rel="up" title="Module code" href="../index.html" />
   
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9">

  </head>
  <body role="document">  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for PyICe.lab_core</h1><div class="highlight"><pre>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">Channel and Threading Core Framework</span>
<span class="sd">====================================</span>

<span class="sd">changes to this file should be minimal!</span>

<span class="sd">&#39;&#39;&#39;</span>

<span class="kn">import</span> <span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;..&#39;</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">PyICe</span> <span class="kn">import</span> <span class="n">logo</span>
<span class="n">logo</span><span class="o">.</span><span class="n">display</span><span class="p">()</span>
<span class="kn">from</span> <span class="nn">PyICe</span> <span class="kn">import</span> <span class="n">lab_interfaces</span>
<span class="kn">from</span> <span class="nn">PyICe</span> <span class="kn">import</span> <span class="n">lab_utils</span>
<span class="kn">import</span> <span class="nn">sqlite3</span>
<span class="kn">import</span> <span class="nn">Queue</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">thread</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">import</span> <span class="nn">multiprocessing.managers</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">atexit</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">numbers</span>


<div class="viewcode-block" id="delegator"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_core.html#PyICe.lab_core.delegator">[docs]</a><span class="k">class</span> <span class="nc">delegator</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;base class for a read delegator, this is the lowest level class in the library.</span>
<span class="sd">    You will probably never use it directly.&#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_delegator</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_threadable</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_interfaces</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">def</span> <span class="nf">set_delegator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">delegator</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_delegator</span> <span class="o">=</span> <span class="n">delegator</span>
    <span class="k">def</span> <span class="nf">get_delegator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_delegator</span>
    <span class="k">def</span> <span class="nf">set_allow_threading</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">state</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_threadable</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">def</span> <span class="nf">threadable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_threadable</span>
    <span class="k">def</span> <span class="nf">resolve_delegator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_delegator</span> <span class="o">==</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_delegator</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_delegator</span><span class="o">.</span><span class="n">resolve_delegator</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">add_interface</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">interface</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_interfaces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">interface</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">get_interfaces</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_delegator</span><span class="p">()</span> <span class="o">==</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_interfaces</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolve_delegator</span><span class="p">()</span><span class="o">.</span><span class="n">get_interfaces</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">lock_interfaces</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">interface</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_interfaces</span><span class="p">:</span>
            <span class="n">interface</span><span class="o">.</span><span class="n">lock</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">unlock_interfaces</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">interface</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_interfaces</span><span class="p">:</span>
            <span class="n">interface</span><span class="o">.</span><span class="n">unlock</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">write_delegated_channel_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">channel_value_list</span><span class="p">):</span>
        <span class="c"># (NOT IMPLEMENTED YET)</span>
        <span class="c">#OVERLOAD THIS FUNCTION </span>
        <span class="c"># takes a list of (channels, value) tuples</span>
        <span class="c"># writes each channel to its corresponding value</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lock_interfaces</span><span class="p">()</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">channel</span><span class="p">,</span><span class="n">value</span><span class="p">)</span> <span class="ow">in</span> <span class="n">channel_value_list</span><span class="p">:</span>
                <span class="n">channel</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unlock_interfaces</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unlock_interfaces</span><span class="p">()</span>
            <span class="k">raise</span> <span class="n">e</span>
    <span class="k">def</span> <span class="nf">_read_delegated_channel_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">channel_list</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lock_interfaces</span><span class="p">()</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_delegated_channel_list</span><span class="p">(</span><span class="n">channel_list</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unlock_interfaces</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">data</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unlock_interfaces</span><span class="p">()</span>
            <span class="k">raise</span> <span class="n">e</span>
    <span class="k">def</span> <span class="nf">read_delegated_channel_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">channel_list</span><span class="p">):</span>
        <span class="c">#OVERLOAD THIS FUNCTION</span>
        <span class="c"># takes a list of channels</span>
        <span class="c"># returns a dictionary of read data by channel name</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="n">channel_list</span><span class="p">:</span>
            <span class="n">results</span><span class="p">[</span><span class="n">channel</span><span class="o">.</span><span class="n">get_name</span><span class="p">()]</span> <span class="o">=</span> <span class="n">channel</span><span class="o">.</span><span class="n">read_without_delegator</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">results</span>
        </div>
<div class="viewcode-block" id="channel"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_core.html#PyICe.lab_core.channel">[docs]</a><span class="k">class</span> <span class="nc">channel</span><span class="p">(</span><span class="n">delegator</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;This is the basic channel object, it can be read and/or written. attributes can also be stored in it, for</span>
<span class="sd">        example channel number in a multi channel instrument&#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">read_function</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">write_function</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">delegator</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_name</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">read_function</span> <span class="ow">and</span> <span class="n">write_function</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;There may only be a single read OR write function&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_read</span> <span class="o">=</span> <span class="n">read_function</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_write</span> <span class="o">=</span> <span class="n">write_function</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_value</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_attributes</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_read_access</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_category</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_write_delay</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_write_min</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_write_max</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_write_callbacks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_read_callbacks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">write_function</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_write_access</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span> <span class="c"># write channel</span>
        <span class="k">elif</span> <span class="n">read_function</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_write_access</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span> <span class="c">#read channel</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_write_access</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span> <span class="c">#dummy channels</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_description</span><span class="p">(</span><span class="s">&quot;No Description&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_display_format_str</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;channel Object: {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_name</span><span class="p">())</span>
<div class="viewcode-block" id="channel.get_name"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_core.html#PyICe.lab_core.channel.get_name">[docs]</a>    <span class="k">def</span> <span class="nf">get_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;return channel name&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span></div>
<div class="viewcode-block" id="channel.set_name"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_core.html#PyICe.lab_core.channel.set_name">[docs]</a>    <span class="k">def</span> <span class="nf">set_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">name</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;rename channel&#39;&#39;&#39;</span>
        <span class="n">name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">&quot;[_A-Za-z][_a-zA-Z0-9]*$&quot;</span><span class="p">,</span><span class="n">name</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">ChannelNameException</span><span class="p">(</span><span class="s">&#39;Bad Channel Name &quot;{}&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span></div>
<div class="viewcode-block" id="channel.set_write_delay"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_core.html#PyICe.lab_core.channel.set_write_delay">[docs]</a>    <span class="k">def</span> <span class="nf">set_write_delay</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">delay</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;sets the automatic delay in seconds after channel write&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_write_delay</span> <span class="o">=</span> <span class="n">delay</span></div>
<div class="viewcode-block" id="channel.get_write_delay"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_core.html#PyICe.lab_core.channel.get_write_delay">[docs]</a>    <span class="k">def</span> <span class="nf">get_write_delay</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;return automatic delay after channel write&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_write_delay</span></div>
<div class="viewcode-block" id="channel.get_description"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_core.html#PyICe.lab_core.channel.get_description">[docs]</a>    <span class="k">def</span> <span class="nf">get_description</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;return channel description string.&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_description</span></div>
<div class="viewcode-block" id="channel.set_description"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_core.html#PyICe.lab_core.channel.set_description">[docs]</a>    <span class="k">def</span> <span class="nf">set_description</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">description</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;sets the channel description. argument is string&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_description</span> <span class="o">=</span> <span class="n">description</span></div>
    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c">#setting delegate to false is reserved for the delegator and should never be used otherwise</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_readable</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">ChannelAccessException</span><span class="p">(</span><span class="s">&#39;Read a non-readable channel&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lock_interfaces</span><span class="p">()</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolve_delegator</span><span class="p">()</span><span class="o">.</span><span class="n">_read_delegated_channel_list</span><span class="p">([</span><span class="bp">self</span><span class="p">])[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unlock_interfaces</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">data</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unlock_interfaces</span><span class="p">()</span>
            <span class="k">raise</span> <span class="n">e</span>
    <span class="k">def</span> <span class="nf">read_without_delegator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># do not use this function unless you are the delegator</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lock_interfaces</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_value</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">print</span> <span class="s">&quot;Read error in channel {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="k">print</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">unlock_interfaces</span><span class="p">()</span>
                <span class="k">raise</span> <span class="n">e</span>
        <span class="k">for</span> <span class="n">callback</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_callbacks</span><span class="p">:</span>
            <span class="n">callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">result</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unlock_interfaces</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_writeable</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">ChannelAccessException</span><span class="p">(</span><span class="s">&#39;Wrote a non-writeable channel&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lock_interfaces</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_write_min</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">value</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_write_min</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">unlock_interfaces</span><span class="p">()</span>
                <span class="k">raise</span> <span class="n">ChannelValueException</span><span class="p">(</span><span class="s">&#39;Cannot write {} to {}. Minimum is {}.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span><span class="n">value</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_write_min</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_write_max</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_write_max</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">unlock_interfaces</span><span class="p">()</span>
                <span class="k">raise</span> <span class="n">ChannelValueException</span><span class="p">(</span><span class="s">&#39;Cannot write {} to {}. Maximum is {}.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span><span class="n">value</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_write_max</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_write</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_write</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">print</span> <span class="s">&quot;Write error in channel {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="k">print</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">unlock_interfaces</span><span class="p">()</span>
                <span class="k">raise</span> <span class="n">e</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_write_delay</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_write_delay</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span>
                <span class="n">lab_utils</span><span class="o">.</span><span class="n">egg_timer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_write_delay</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_write_delay</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">callback</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_write_callbacks</span><span class="p">:</span>
            <span class="n">callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">value</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_value</span> <span class="o">=</span> <span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unlock_interfaces</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">value</span>
<div class="viewcode-block" id="channel.write_unformatted"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_core.html#PyICe.lab_core.channel.write_unformatted">[docs]</a>    <span class="k">def</span> <span class="nf">write_unformatted</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;bypass unformatting stub. Only useful for integer and register channels. intended for use by GUI.&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></div>
    <span class="k">def</span> <span class="nf">_set_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">value</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;private method to set channel cached value without actualy _write call or any checking for writability, limits, etc.&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_value</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">return</span> <span class="n">value</span>
<div class="viewcode-block" id="channel.set_attribute"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_core.html#PyICe.lab_core.channel.set_attribute">[docs]</a>    <span class="k">def</span> <span class="nf">set_attribute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">attribute_name</span><span class="p">,</span><span class="n">value</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;set attribute_name to value</span>
<span class="sd">        value can br retrived later with get_attribute(attribute_name)&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_attributes</span><span class="p">[</span><span class="n">attribute_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">return</span> <span class="bp">self</span></div>
<div class="viewcode-block" id="channel.get_attribute"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_core.html#PyICe.lab_core.channel.get_attribute">[docs]</a>    <span class="k">def</span> <span class="nf">get_attribute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">attribute_name</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;retrieve value previously set with set_attribute(attribute_name, value)&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">attribute_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_attributes</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">ChannelAttributeError</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_attributes</span><span class="p">[</span><span class="n">attribute_name</span><span class="p">]</span></div>
<div class="viewcode-block" id="channel.get_attributes"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_core.html#PyICe.lab_core.channel.get_attributes">[docs]</a>    <span class="k">def</span> <span class="nf">get_attributes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;return dictionary of all channel attributes previously set with set_attribute(attribute_name, value)&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_attributes</span><span class="p">)</span></div>
<div class="viewcode-block" id="channel.set_category"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_core.html#PyICe.lab_core.channel.set_category">[docs]</a>    <span class="k">def</span> <span class="nf">set_category</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">category</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;each channel may be a member of a single category for sorting purposes. category argument is usually a string&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">category</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&quot;Category must be a string&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_category</span> <span class="o">=</span> <span class="n">category</span>
        <span class="k">return</span> <span class="bp">self</span></div>
<div class="viewcode-block" id="channel.get_category"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_core.html#PyICe.lab_core.channel.get_category">[docs]</a>    <span class="k">def</span> <span class="nf">get_category</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;returns category membership.  should be a string.&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_category</span></div>
<div class="viewcode-block" id="channel.is_readable"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_core.html#PyICe.lab_core.channel.is_readable">[docs]</a>    <span class="k">def</span> <span class="nf">is_readable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;return register readability boolean&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_readable</span></div>
<div class="viewcode-block" id="channel.set_read_access"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_core.html#PyICe.lab_core.channel.set_read_access">[docs]</a>    <span class="k">def</span> <span class="nf">set_read_access</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">readable</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;set or unset register read access&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_readable</span> <span class="o">=</span> <span class="n">readable</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s">&quot;readable&quot;</span><span class="p">,</span><span class="n">readable</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>
<div class="viewcode-block" id="channel.is_writeable"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_core.html#PyICe.lab_core.channel.is_writeable">[docs]</a>    <span class="k">def</span> <span class="nf">is_writeable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;return register writability boolean&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_writeable</span></div>
<div class="viewcode-block" id="channel.set_write_access"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_core.html#PyICe.lab_core.channel.set_write_access">[docs]</a>    <span class="k">def</span> <span class="nf">set_write_access</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">writeable</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;set or unset register write access&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_writeable</span> <span class="o">=</span> <span class="n">writeable</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s">&quot;writeable&quot;</span><span class="p">,</span><span class="n">writeable</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>
<div class="viewcode-block" id="channel.set_max_write_limit"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_core.html#PyICe.lab_core.channel.set_max_write_limit">[docs]</a>    <span class="k">def</span> <span class="nf">set_max_write_limit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="nb">max</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;set channel&#39;s maximum writable value. None disables limit&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="nb">max</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_write_max</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span> 
                <span class="bp">self</span><span class="o">.</span><span class="n">_write_max</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="nb">max</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;Maximum value for a channels write must be a number&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>
<div class="viewcode-block" id="channel.set_min_write_limit"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_core.html#PyICe.lab_core.channel.set_min_write_limit">[docs]</a>    <span class="k">def</span> <span class="nf">set_min_write_limit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="nb">min</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;set channel&#39;s minimum writable value. None disables limit&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="nb">min</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_write_min</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span> 
                <span class="bp">self</span><span class="o">.</span><span class="n">_write_min</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="nb">min</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;Minimum value for a channels write must be a number&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>
<div class="viewcode-block" id="channel.get_max_write_limit"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_core.html#PyICe.lab_core.channel.get_max_write_limit">[docs]</a>    <span class="k">def</span> <span class="nf">get_max_write_limit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;return max writable channel value.&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_write_max</span></div>
<div class="viewcode-block" id="channel.get_min_write_limit"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_core.html#PyICe.lab_core.channel.get_min_write_limit">[docs]</a>    <span class="k">def</span> <span class="nf">get_min_write_limit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">formatted</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;return min writable channel value.&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_write_min</span></div>
<div class="viewcode-block" id="channel.format_display"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_core.html#PyICe.lab_core.channel.format_display">[docs]</a>    <span class="k">def</span> <span class="nf">format_display</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">data</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;converts data to string according to string formatting rule set by self.set_display_format_str()&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_display_format_str</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data</span><span class="p">)</span></div>
<div class="viewcode-block" id="channel.set_display_format_str"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_core.html#PyICe.lab_core.channel.set_display_format_str">[docs]</a>    <span class="k">def</span> <span class="nf">set_display_format_str</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fmt_str</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="n">prefix</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="n">suffix</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;format string to alter how data is displayed.  example &#39;3.2f&#39;, &#39;04X&#39;, &#39;#06X&#39;, &#39;#18b&#39;, &#39;.2%&#39;</span>
<span class="sd">        prefix will be displayed immediately before the channel data, example &#39;0x&#39;</span>
<span class="sd">        suffix will be displayed immediately after the channel data, example &#39; A&#39; or &#39; V&#39;</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_display_format_str</span> <span class="o">=</span> <span class="s">u&#39;{prefix}{{:{fmt_str}}}{suffix}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">,</span><span class="n">fmt_str</span><span class="o">=</span><span class="n">fmt_str</span><span class="p">,</span><span class="n">suffix</span><span class="o">=</span><span class="n">suffix</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>
<div class="viewcode-block" id="channel.set_display_format_function"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_core.html#PyICe.lab_core.channel.set_display_format_function">[docs]</a>    <span class="k">def</span> <span class="nf">set_display_format_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">function</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;abandon string formatting and pass data through custom user-supplied function&#39;&#39;&#39;</span>
        <span class="c">#self.format_display = lambda self,data: function(data)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">format_display</span> <span class="o">=</span> <span class="n">function</span>
        <span class="k">return</span> <span class="bp">self</span></div>
<div class="viewcode-block" id="channel.add_write_callback"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_core.html#PyICe.lab_core.channel.add_write_callback">[docs]</a>    <span class="k">def</span> <span class="nf">add_write_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">write_callback</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Adds a write callback. This is a function that will be called any time the channel is written. the callback function takes two arguments (channel_object, data)&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_write_callbacks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">write_callback</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>
<div class="viewcode-block" id="channel.add_read_callback"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_core.html#PyICe.lab_core.channel.add_read_callback">[docs]</a>    <span class="k">def</span> <span class="nf">add_read_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">read_callback</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Adds a read callback. This is a function that will be called any time the channel is read. the callback function takes two arguments (channel_object, data)&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_read_callbacks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">read_callback</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>
</div></div>
<span class="k">class</span> <span class="nc">ChannelException</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>
<span class="k">class</span> <span class="nc">ChannelAccessException</span><span class="p">(</span><span class="n">ChannelException</span><span class="p">):</span>
    <span class="k">pass</span>
<span class="k">class</span> <span class="nc">ChannelNameException</span><span class="p">(</span><span class="n">ChannelException</span><span class="p">):</span>
    <span class="k">pass</span>
<span class="k">class</span> <span class="nc">ChannelAttributeError</span><span class="p">(</span><span class="n">ChannelException</span><span class="p">):</span>
    <span class="k">pass</span>
<span class="k">class</span> <span class="nc">ChannelValueException</span><span class="p">(</span><span class="n">ChannelException</span><span class="p">):</span>
    <span class="k">pass</span>

<div class="viewcode-block" id="integer_channel"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_core.html#PyICe.lab_core.integer_channel">[docs]</a><span class="k">class</span> <span class="nc">integer_channel</span><span class="p">(</span><span class="n">channel</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;channel limited to writing integer values. Adds presets and formats but retains channel class&#39;s read/write restrictions.&#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">read_function</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">write_function</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">channel</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">read_function</span><span class="o">=</span><span class="n">read_function</span><span class="p">,</span><span class="n">write_function</span><span class="o">=</span><span class="n">write_function</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">numbers</span><span class="o">.</span><span class="n">Integral</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">size</span> <span class="o">&gt;=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_size</span> <span class="o">=</span> <span class="n">size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_min_write_limit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_max_write_limit</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="n">size</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s">&quot;size&quot;</span><span class="p">,</span><span class="n">size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s">&quot;min&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s">&quot;max&quot;</span><span class="p">,</span><span class="mi">2</span><span class="o">**</span><span class="n">size</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_formats</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_presets</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_presets_reverse</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_format</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_use_presets_read</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_use_presets_write</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_default_formats</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;integer_channel Object: {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_name</span><span class="p">())</span>
    <span class="k">def</span> <span class="nf">_add_default_formats</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">check_sign</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">numbers</span><span class="o">.</span><span class="n">Number</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">data</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;Negative binary/hex values not allowed.&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">data</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_size</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_format</span><span class="p">(</span><span class="s">&#39;dec&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_format</span><span class="p">(</span><span class="s">&#39;hex&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">data</span> <span class="p">:</span> <span class="s">&#39;0x{{:0{}X}}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_size</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">4</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">check_sign</span><span class="p">(</span><span class="n">data</span><span class="p">)),</span> <span class="k">lambda</span> <span class="n">data</span> <span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">),</span><span class="mi">16</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_format</span><span class="p">(</span><span class="s">&#39;bin&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">data</span> <span class="p">:</span> <span class="s">&#39;0b{{:0{}b}}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_size</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">check_sign</span><span class="p">(</span><span class="n">data</span><span class="p">)),</span> <span class="k">lambda</span> <span class="n">data</span> <span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">),</span><span class="mi">2</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_format</span><span class="p">(</span><span class="s">&#39;signed dec&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="n">signed</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="c">#self.add_preset(&#39;Minimum&#39;, self.get_attribute(&quot;min&quot;)) #this is wrong for two&#39;s-comp channels. Not sure how to deal with signed data here since that&#39;s handled by formatting...</span>
            <span class="c">#self.add_preset(&#39;Maximum&#39;, self.get_attribute(&quot;max&quot;)) #this is wrong for two&#39;s-comp channels. Not sure how to deal with signed data here since that&#39;s handled by formatting...</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c">#single bit default presets</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_preset</span><span class="p">(</span><span class="s">&#39;True&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_preset</span><span class="p">(</span><span class="s">&#39;False&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
<div class="viewcode-block" id="integer_channel.get_max_write_limit"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_core.html#PyICe.lab_core.integer_channel.get_max_write_limit">[docs]</a>    <span class="k">def</span> <span class="nf">get_max_write_limit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">formatted</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;return max writable channel value. If formatted, return max writeable value in transformed units accorting to set_format(format) active format.&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">formatted</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_write_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_write_max</span><span class="p">)</span></div>
<div class="viewcode-block" id="integer_channel.get_min_write_limit"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_core.html#PyICe.lab_core.integer_channel.get_min_write_limit">[docs]</a>    <span class="k">def</span> <span class="nf">get_min_write_limit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">formatted</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;return min writable channel value. If formatted, return min writeable value in transformed units accorting to set_format(format) active format.&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">formatted</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_write_min</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_write_min</span><span class="p">)</span></div>
<div class="viewcode-block" id="integer_channel.add_preset"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_core.html#PyICe.lab_core.integer_channel.add_preset">[docs]</a>    <span class="k">def</span> <span class="nf">add_preset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">preset_name</span><span class="p">,</span> <span class="n">preset_value</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Adds a preset named preset_name with value preset_value&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_size</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_presets</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="s">&#39;True&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_presets</span> <span class="ow">and</span> <span class="s">&#39;False&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_presets</span><span class="p">:</span>
            <span class="c">#remove True/False presets if custom presets are added</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_presets</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_presets_reverse</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_preset</span><span class="p">(</span><span class="n">preset_name</span><span class="p">,</span> <span class="n">preset_value</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>
    <span class="k">def</span> <span class="nf">_add_preset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">preset_name</span><span class="p">,</span> <span class="n">preset_value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">preset_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_presets</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;Preset name duplicated: {}.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">preset_name</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">preset_value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_presets_reverse</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&#39;WARNING: Preset value: {} of register: {} ambiguous name lookup:[{}, {}].&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">preset_value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_name</span><span class="p">(),</span> <span class="n">preset_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_presets_reverse</span><span class="p">[</span><span class="n">preset_value</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_presets</span><span class="p">[</span><span class="n">preset_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">preset_value</span>  
        <span class="bp">self</span><span class="o">.</span><span class="n">_presets_reverse</span><span class="p">[</span><span class="n">preset_value</span><span class="p">]</span> <span class="o">=</span> <span class="n">preset_name</span>
<div class="viewcode-block" id="integer_channel.set_format"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_core.html#PyICe.lab_core.integer_channel.set_format">[docs]</a>    <span class="k">def</span> <span class="nf">set_format</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">format</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;set active transformation format. reads and writes happen in transformed (real) units instead of native integer.</span>
<span class="sd">        Set to None to disable formatting.&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">format</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">format</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_formats</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;Invalid format &quot;{}&quot; for {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">format</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">get_name</span><span class="p">()))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_format</span> <span class="o">=</span> <span class="n">format</span>
        <span class="k">return</span> <span class="bp">self</span></div>
<div class="viewcode-block" id="integer_channel.get_format"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_core.html#PyICe.lab_core.integer_channel.get_format">[docs]</a>    <span class="k">def</span> <span class="nf">get_format</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;return active format as set by set_format(format)&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format</span></div>
<div class="viewcode-block" id="integer_channel.use_presets_read"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_core.html#PyICe.lab_core.integer_channel.use_presets_read">[docs]</a>    <span class="k">def</span> <span class="nf">use_presets_read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="nb">bool</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;enable replacement of integer value with named enum when reading channel&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_use_presets_read</span> <span class="o">=</span> <span class="nb">bool</span>
        <span class="k">return</span> <span class="bp">self</span></div>
<div class="viewcode-block" id="integer_channel.use_presets_write"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_core.html#PyICe.lab_core.integer_channel.use_presets_write">[docs]</a>    <span class="k">def</span> <span class="nf">use_presets_write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="nb">bool</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;enable replacement of named enum with integer value when writing channel&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_use_presets_write</span> <span class="o">=</span> <span class="nb">bool</span>
        <span class="k">return</span> <span class="bp">self</span></div>
<div class="viewcode-block" id="integer_channel.using_presets_read"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_core.html#PyICe.lab_core.integer_channel.using_presets_read">[docs]</a>    <span class="k">def</span> <span class="nf">using_presets_read</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;return boolean denoting last setting of use_presets_read()&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_presets_read</span></div>
<div class="viewcode-block" id="integer_channel.using_presets_write"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_core.html#PyICe.lab_core.integer_channel.using_presets_write">[docs]</a>    <span class="k">def</span> <span class="nf">using_presets_write</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;return boolean denoting last setting of use_presets_write()&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_presets_write</span></div>
<div class="viewcode-block" id="integer_channel.get_presets"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_core.html#PyICe.lab_core.integer_channel.get_presets">[docs]</a>    <span class="k">def</span> <span class="nf">get_presets</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Returns a list of preset names&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_presets</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span></div>
<div class="viewcode-block" id="integer_channel.get_presets_dict"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_core.html#PyICe.lab_core.integer_channel.get_presets_dict">[docs]</a>    <span class="k">def</span> <span class="nf">get_presets_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Returns a dictionary of preset names and value&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_presets</span><span class="p">)</span></div>
<div class="viewcode-block" id="integer_channel.add_format"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_core.html#PyICe.lab_core.integer_channel.add_format">[docs]</a>    <span class="k">def</span> <span class="nf">add_format</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">format_name</span><span class="p">,</span> <span class="n">format_function</span><span class="p">,</span> <span class="n">unformat_function</span><span class="p">,</span> <span class="n">signed</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Add a format to this register.  Formats convert a raw number into a more meaningful string and vice versa </span>
<span class="sd">            Formats can be generic hex, bin, etc, or can be more complicated.</span>
<span class="sd">            format_name is the name of the format</span>
<span class="sd">            format_function transforms from integer data to real</span>
<span class="sd">            unformat_function transforms from real data to integer</span>
<span class="sd">            format_function and unformat_function should be reversible</span>
<span class="sd">            signed treats integer data as two&#39;s complement with self.size bit width</span>
<span class="sd">            units optionally appended to formatted (real) data when displayed by GUI&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_formats</span><span class="p">[</span><span class="n">format_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">signed</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_formats</span><span class="p">[</span><span class="n">format_name</span><span class="p">][</span><span class="s">&#39;format_function&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">format_function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">twosComplementToSigned</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_formats</span><span class="p">[</span><span class="n">format_name</span><span class="p">][</span><span class="s">&#39;unformat_function&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">signedToTwosComplement</span><span class="p">(</span><span class="n">unformat_function</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_formats</span><span class="p">[</span><span class="n">format_name</span><span class="p">][</span><span class="s">&#39;format_function&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">format_function</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_formats</span><span class="p">[</span><span class="n">format_name</span><span class="p">][</span><span class="s">&#39;unformat_function&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">unformat_function</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_formats</span><span class="p">[</span><span class="n">format_name</span><span class="p">][</span><span class="s">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">units</span>
        <span class="k">return</span> <span class="bp">self</span></div>
<div class="viewcode-block" id="integer_channel.remove_format"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_core.html#PyICe.lab_core.integer_channel.remove_format">[docs]</a>    <span class="k">def</span> <span class="nf">remove_format</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">format_name</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;remove format_name from dictionary of available formats&#39;&#39;&#39;</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_formats</span><span class="p">[</span><span class="n">format_name</span><span class="p">]</span></div>
<div class="viewcode-block" id="integer_channel.get_formats"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_core.html#PyICe.lab_core.integer_channel.get_formats">[docs]</a>    <span class="k">def</span> <span class="nf">get_formats</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Return a list of format_names associate with this register.</span>
<span class="sd">            The format_string elements of the returned list may be passed to the format or unformat methods&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_formats</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span></div>
<div class="viewcode-block" id="integer_channel.format"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_core.html#PyICe.lab_core.integer_channel.format">[docs]</a>    <span class="k">def</span> <span class="nf">format</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">format</span><span class="p">,</span> <span class="n">use_presets</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;take in integer data, pass through specified formatting function, and return string/real representation.&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="bp">True</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="n">use_presets</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_presets_reverse</span><span class="p">[</span><span class="n">data</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">if</span> <span class="n">format</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">format</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_formats</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">RegisterFormatException</span><span class="p">(</span><span class="s">&#39;Register {} has no format {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span><span class="n">format</span><span class="p">))</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_formats</span><span class="p">[</span><span class="n">format</span><span class="p">][</span><span class="s">&#39;format_function&#39;</span><span class="p">](</span><span class="n">data</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span></div>
<div class="viewcode-block" id="integer_channel.unformat"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_core.html#PyICe.lab_core.integer_channel.unformat">[docs]</a>    <span class="k">def</span> <span class="nf">unformat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">string</span><span class="p">,</span> <span class="n">format</span><span class="p">,</span> <span class="n">use_presets</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;take in formatted string / real, pass through specified unformatting function, and return integer representation.&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">string</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="n">use_presets</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_presets</span><span class="p">[</span><span class="n">string</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">if</span> <span class="n">format</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">format</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_formats</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">RegisterFormatException</span><span class="p">(</span><span class="s">&#39;Register {} has no format {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span><span class="n">format</span><span class="p">))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_formats</span><span class="p">[</span><span class="n">format</span><span class="p">][</span><span class="s">&#39;unformat_function&#39;</span><span class="p">](</span><span class="n">string</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="c">#formats intended for real data will get switched to strings in the GUI. Make an attempt here to fix.</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">string</span><span class="p">,</span><span class="nb">int</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">string</span><span class="p">,</span><span class="nb">float</span><span class="p">)</span> <span class="ow">or</span> <span class="n">string</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">e</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">formatted_data</span> <span class="o">=</span>  <span class="nb">int</span><span class="p">(</span><span class="n">string</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="c">#automatically select base</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">formatted_data</span> <span class="o">=</span>  <span class="nb">float</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e2</span><span class="p">:</span>
                        <span class="k">print</span> <span class="n">e2</span>
                        <span class="k">raise</span> <span class="n">e</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_formats</span><span class="p">[</span><span class="n">format</span><span class="p">][</span><span class="s">&#39;unformat_function&#39;</span><span class="p">](</span><span class="n">formatted_data</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">string</span> <span class="ow">is</span> <span class="bp">True</span> <span class="ow">or</span> <span class="n">string</span> <span class="o">==</span> <span class="s">&#39;True&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">if</span> <span class="n">string</span> <span class="ow">is</span> <span class="bp">False</span> <span class="ow">or</span> <span class="n">string</span> <span class="o">==</span> <span class="s">&#39;False&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">string</span><span class="p">)</span> <span class="k">if</span> <span class="nb">float</span><span class="p">(</span><span class="n">string</span><span class="p">)</span> <span class="o">==</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">string</span><span class="p">))</span> <span class="k">else</span> <span class="nb">float</span><span class="p">(</span><span class="n">string</span><span class="p">)</span> <span class="c">#return int(float(string))...???</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;WARNING: Channel: {} write data: {} failed numeric conversion.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_name</span><span class="p">(),</span> <span class="n">string</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">string</span></div>
<div class="viewcode-block" id="integer_channel.get_units"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_core.html#PyICe.lab_core.integer_channel.get_units">[docs]</a>    <span class="k">def</span> <span class="nf">get_units</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">format</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;return real units string for specified format. ex &#39;A&#39; or &#39;V&#39;&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_formats</span><span class="p">[</span><span class="n">format</span><span class="p">][</span><span class="s">&#39;units&#39;</span><span class="p">]</span></div>
<div class="viewcode-block" id="integer_channel.format_read"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_core.html#PyICe.lab_core.integer_channel.format_read">[docs]</a>    <span class="k">def</span> <span class="nf">format_read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">raw_data</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;transform from integer to real units according to using_presets_read() and active format&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_presets_read</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">raw_data</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_format</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_use_presets_read</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">raw_data</span></div>
<div class="viewcode-block" id="integer_channel.format_write"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_core.html#PyICe.lab_core.integer_channel.format_write">[docs]</a>    <span class="k">def</span> <span class="nf">format_write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">value</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;transform from real units to integer according to using_presets_write() and active format&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">unformat</span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_format</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_use_presets_write</span><span class="p">)</span></div>
<div class="viewcode-block" id="integer_channel.twosComplementToSigned"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_core.html#PyICe.lab_core.integer_channel.twosComplementToSigned">[docs]</a>    <span class="k">def</span> <span class="nf">twosComplementToSigned</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">binary</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;transform two&#39;s complement formatted binary number to signed integer.  Requires register&#39;s size attribute to be set in __init__&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="n">lab_utils</span><span class="o">.</span><span class="n">twosComplementToSigned</span><span class="p">(</span><span class="n">binary</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_size</span><span class="p">)</span></div>
<div class="viewcode-block" id="integer_channel.signedToTwosComplement"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_core.html#PyICe.lab_core.integer_channel.signedToTwosComplement">[docs]</a>    <span class="k">def</span> <span class="nf">signedToTwosComplement</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">signed</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;transform signed integer to two&#39;s complement formatted binary number.  Requires register&#39;s size attribute to be set in __init__&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="n">lab_utils</span><span class="o">.</span><span class="n">signedToTwosComplement</span><span class="p">(</span><span class="n">signed</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_size</span><span class="p">)</span></div>
<div class="viewcode-block" id="integer_channel.write"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_core.html#PyICe.lab_core.integer_channel.write">[docs]</a>    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">value</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;write intercept to apply formats/presets before channel write. Coerce to integer and warn about rounding error. Also accepts None&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_size</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c">#allow True,False values</span>
            <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">True</span><span class="p">:</span>
                <span class="n">channel</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="bp">True</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="k">elif</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">:</span>
                <span class="n">channel</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="bp">False</span><span class="p">)</span>
                <span class="k">return</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">raw_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_write</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="n">int_data</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">raw_data</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">int_data</span> <span class="o">!=</span> <span class="n">raw_data</span><span class="p">:</span>
                <span class="k">print</span> <span class="s">&quot;WARNING: Channel: {} write: {} unformatted to: {} and rounded to: {}.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_name</span><span class="p">(),</span> <span class="n">value</span><span class="p">,</span> <span class="n">raw_data</span><span class="p">,</span> <span class="n">int_data</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">int_data</span> <span class="o">=</span> <span class="n">value</span>
        <span class="n">channel</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">int_data</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">int_data</span></div>
<div class="viewcode-block" id="integer_channel.write_unformatted"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_core.html#PyICe.lab_core.integer_channel.write_unformatted">[docs]</a>    <span class="k">def</span> <span class="nf">write_unformatted</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;bypass unformatting. intended for use by GUI.&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_size</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c">#allow True,False values</span>
            <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">True</span><span class="p">:</span>
                <span class="n">channel</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="bp">True</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="k">elif</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">:</span>
                <span class="n">channel</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="bp">False</span><span class="p">)</span>
                <span class="k">return</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">int_data</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">int_data</span> <span class="o">!=</span> <span class="n">value</span><span class="p">:</span>
                <span class="k">print</span> <span class="s">&quot;WARNING: Channel: {} write_unformatted: {} rounded to: {}.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_name</span><span class="p">(),</span> <span class="n">value</span><span class="p">,</span> <span class="n">int_data</span><span class="p">)</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">int_data</span>
        <span class="n">channel</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">value</span></div>
<div class="viewcode-block" id="integer_channel.read_without_delegator"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_core.html#PyICe.lab_core.integer_channel.read_without_delegator">[docs]</a>    <span class="k">def</span> <span class="nf">read_without_delegator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;read intercept to apply formats/presets to channel (raw) read&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_read</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_value</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_read</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_read</span><span class="p">())</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">print</span> <span class="s">&quot;Read error in channel {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="k">print</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                <span class="k">raise</span> <span class="n">e</span>
        <span class="k">for</span> <span class="n">callback</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_callbacks</span><span class="p">:</span>
            <span class="n">callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">result</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>
</div></div>
<div class="viewcode-block" id="register"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_core.html#PyICe.lab_core.register">[docs]</a><span class="k">class</span> <span class="nc">register</span><span class="p">(</span><span class="n">integer_channel</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Register primitive superclass, inherits from integer_channel and channel. Allows read and write access to integer data with presets and formats.&#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">read_function</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">write_function</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;if subclass overloads __init__, it should also call this one&#39;&#39;&#39;</span>
        <span class="c">#channel doesn&#39;t allow both read and write so just do one, then force in the other</span>
        <span class="n">integer_channel</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">,</span> <span class="n">read_function</span><span class="o">=</span><span class="n">read_function</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">write_function</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_write</span> <span class="o">=</span> <span class="n">write_function</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_write_access</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;Register Object: {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_name</span><span class="p">())</span>
</div>
<span class="k">class</span> <span class="nc">RegisterFormatException</span><span class="p">(</span><span class="n">ChannelException</span><span class="p">):</span>
    <span class="k">pass</span>
    
<span class="k">class</span> <span class="nc">channel_group</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&#39;Unnamed Channel Group&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_name</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_channel_dict</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>  <span class="c"># a dictionary of channel objects, keyed by name, contained by this channel_group</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sub_channel_groups</span> <span class="o">=</span> <span class="p">[]</span>                   <span class="c"># a list of other groups contained by this object</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_threaded</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_partial_delegation_results</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_self_delegation_channels</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;channel_group Object: {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_name</span><span class="p">())</span>
    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_all_channels_list</span><span class="p">():</span>
            <span class="k">yield</span> <span class="n">channel</span> <span class="c">#this is inconsistent with dictionaries, which yield their keys when iterated!</span>
    <span class="k">def</span> <span class="nf">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_all_channels_list</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">channel_name</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_channel</span><span class="p">(</span><span class="n">channel_name</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">get_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span>
    <span class="k">def</span> <span class="nf">set_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">sort</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">deep</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="s">&#39;key&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;key&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">kv_tuple</span><span class="p">:</span> <span class="n">kv_tuple</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c">#sort by channel name by default</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_channel_dict</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_channel_dict</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">deep</span><span class="p">:</span> <span class="c">#should this go deep and sort sub channel groups too?</span>
            <span class="k">for</span> <span class="n">scg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sub_channel_groups</span><span class="p">:</span>
                <span class="n">scg</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">channel_or_group</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">channel_or_group</span><span class="p">,</span><span class="n">channel</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_channel</span><span class="p">(</span><span class="n">channel_or_group</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">channel_or_group</span><span class="p">,</span><span class="n">channel_group</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_sub_channel_group</span><span class="p">(</span><span class="n">channel_or_group</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">Attempted to add something other than a channel or channel_group to a channel_group&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_add_channel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">channel_object</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">channel_object</span><span class="p">,</span><span class="n">channel</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">Attempted to add a non-channel to a channel_group&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">channel_object</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_channel_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">print</span> <span class="s">&quot;WARNING: Re-defined channel {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">channel_object</span><span class="o">.</span><span class="n">get_name</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_channel_dict</span><span class="p">[</span><span class="n">channel_object</span><span class="o">.</span><span class="n">get_name</span><span class="p">()]</span> <span class="o">=</span> <span class="n">channel_object</span>
        <span class="k">return</span> <span class="n">channel_object</span>
    <span class="k">def</span> <span class="nf">merge_in_channel_group</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">channel_group_object</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;merges in a channel group&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">channel_group_object</span><span class="p">,</span><span class="n">channel_group</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">Attempted to merge a non-channel_group to a channel_group&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">channel_object</span> <span class="ow">in</span> <span class="n">channel_group_object</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_channel</span><span class="p">(</span><span class="n">channel_object</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_add_sub_channel_group</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">channel_group_object</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">channel_group_object</span><span class="p">,</span><span class="n">channel_group</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">Attempted to add a &quot;{}&quot; to a channel_group as a sub group&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">channel_group_object</span><span class="p">))</span>
        <span class="n">channel_name_conflicts</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_channel_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">channel_group_object</span><span class="o">.</span><span class="n">get_all_channel_names</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">channel_name_conflict</span> <span class="ow">in</span> <span class="n">channel_name_conflicts</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_channel_dict</span><span class="p">[</span><span class="n">channel_name_conflict</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">channel_group_object</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">Channel name conflict for &quot;{}&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">channel_name_conflict</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sub_channel_groups</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">channel_group_object</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">channel_name</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_channel</span><span class="p">(</span><span class="n">channel_name</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">channel_name</span><span class="p">,</span><span class="n">value</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_channel</span><span class="p">(</span><span class="n">channel_name</span><span class="p">,</span><span class="n">value</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">read_channel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">channel_name</span><span class="p">):</span>
        <span class="n">channel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_channel</span><span class="p">(</span><span class="n">channel_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">channel</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ChannelAccessException</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">Unable to read channel &quot;{}&quot;, did you create it or is it a typo?&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">channel_name</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_channel_list</span><span class="p">([</span><span class="n">channel</span><span class="p">])[</span><span class="n">channel_name</span><span class="p">]</span>
    <span class="k">def</span> <span class="nf">read_channels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">item_list</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;item list is a list of channel objects, names or channel_groups&#39;&#39;&#39;</span>
        <span class="n">channel_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolve_channel_list</span><span class="p">(</span><span class="n">item_list</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_channel_list</span><span class="p">(</span><span class="n">channel_list</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">write_channel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">channel_name</span><span class="p">,</span><span class="n">value</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_channel</span><span class="p">(</span><span class="n">channel_name</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">get_channel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">channel_name</span><span class="p">):</span>
        <span class="n">channel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_channel</span><span class="p">(</span><span class="n">channel_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">channel</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ChannelAccessException</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">Unable to get channel &quot;{}&quot;, did you create it or is it a typo?&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">channel_name</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">channel</span>
    <span class="k">def</span> <span class="nf">get_flat_channel_group</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;returns a channel_group directly containing all channels this one can resolve&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s">&#39;{}_flattened&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_name</span><span class="p">())</span>
        <span class="n">new_group</span> <span class="o">=</span> <span class="n">channel_group</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="n">new_group</span><span class="o">.</span><span class="n">merge_in_channel_group</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">new_group</span>
    <span class="k">def</span> <span class="nf">_resolve_channel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">channel_name</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">channel_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_channel_dict</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_channel_dict</span><span class="p">[</span><span class="n">channel_name</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">sub_channel_group</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sub_channel_groups</span><span class="p">:</span>
            <span class="n">channel</span> <span class="o">=</span> <span class="n">sub_channel_group</span><span class="o">.</span><span class="n">_resolve_channel</span><span class="p">(</span><span class="n">channel_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">channel</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">channel</span>
        <span class="k">return</span> <span class="bp">None</span>
    <span class="k">def</span> <span class="nf">get_all_channels_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c">#returns a dictionary of all channels by name</span>
        <span class="n">all_channels</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_channel_dict</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">sub_channel_group</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sub_channel_groups</span><span class="p">:</span>
            <span class="n">all_channels</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">sub_channel_group</span><span class="o">.</span><span class="n">get_all_channels_dict</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">all_channels</span>
    <span class="k">def</span> <span class="nf">get_all_channel_names</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_all_channels_dict</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">get_all_channels_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_all_channels_dict</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">read_channel_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">channel_list</span><span class="p">):</span>
        <span class="c">#reads a list of channel objects</span>
        <span class="c"># create lists of threadable and non-threadable channels</span>
        <span class="n">threadable_channels</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">non_threadable_channels</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_partial_delegation_results</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_self_delegation_channels</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="n">channel_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">channel</span><span class="o">.</span><span class="n">resolve_delegator</span><span class="p">()</span> <span class="ow">is</span> <span class="bp">self</span><span class="p">:</span>
                <span class="c"># if the user asked the delegator directly to read do not thread</span>
                <span class="c"># this is also useful for the masters caching mode to do it last</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_self_delegation_channels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">channel</span><span class="p">)</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">channel</span><span class="o">.</span><span class="n">threadable</span><span class="p">():</span>
                <span class="n">non_threadable_channels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">channel</span><span class="p">)</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">channel</span><span class="o">.</span><span class="n">resolve_delegator</span><span class="p">()</span><span class="o">.</span><span class="n">threadable</span><span class="p">():</span>
                <span class="n">non_threadable_channels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">channel</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">threadable_channels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">channel</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_threaded</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_channels_threaded</span><span class="p">(</span><span class="n">threadable_channels</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_channels_non_threaded</span><span class="p">(</span><span class="n">threadable_channels</span><span class="p">)</span>
        <span class="n">results</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_read_channels_non_threaded</span><span class="p">(</span><span class="n">non_threadable_channels</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_self_delegation_channels</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_partial_delegation_results</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
            <span class="n">results</span><span class="o">.</span><span class="n">update</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_delegated_channel_list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_self_delegation_channels</span><span class="p">)</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_partial_delegation_results</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_self_delegation_channels</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">results</span>
    <span class="k">def</span> <span class="nf">_read_channels_non_threaded</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">channel_list</span><span class="p">):</span>
        <span class="c">#get a dictionary of delegators for list of channel objects</span>
        <span class="n">delegator_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="n">channel_list</span><span class="p">:</span>
            <span class="n">delegator_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">channel</span><span class="o">.</span><span class="n">resolve_delegator</span><span class="p">()</span> <span class="p">)</span>
        <span class="c"># remove all duplicates</span>
        <span class="n">delegator_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">delegator_list</span><span class="p">))</span>
        <span class="c">#have each delegator read its channels</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">delegator</span> <span class="ow">in</span> <span class="n">delegator_list</span><span class="p">:</span>
            <span class="c"># for each delegator get the list of channels it is responsible for</span>
            <span class="n">channel_delegation_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="n">channel_list</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">delegator</span> <span class="o">==</span> <span class="n">channel</span><span class="o">.</span><span class="n">resolve_delegator</span><span class="p">():</span>
                    <span class="n">channel_delegation_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">channel</span><span class="p">)</span>
            <span class="n">results</span><span class="o">.</span><span class="n">update</span><span class="p">(</span> <span class="n">delegator</span><span class="o">.</span><span class="n">_read_delegated_channel_list</span><span class="p">(</span><span class="n">channel_delegation_list</span><span class="p">)</span> <span class="p">)</span>
        <span class="k">return</span> <span class="n">results</span>
    <span class="k">def</span> <span class="nf">_read_channels_threaded</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">channel_list</span><span class="p">):</span>
        <span class="c"># dont read threaded unless i know how to group interfaces for theads (only interface_factory&#39;s</span>
        <span class="c">#    know this, ie a master</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s">&#39;group_com_nodes_for_threads_filter&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_channels_non_threaded</span><span class="p">(</span><span class="n">channel_list</span><span class="p">)</span>
        <span class="c">#get a dictionary of delegator&#39;s by channel name</span>
        <span class="n">delegator_list</span> <span class="o">=</span> <span class="p">[</span> <span class="n">channel</span><span class="o">.</span><span class="n">resolve_delegator</span><span class="p">()</span> <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="n">channel_list</span><span class="p">]</span>
        <span class="c"># remove all duplicates</span>
        <span class="n">delegator_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">delegator_list</span><span class="p">))</span>
        <span class="c"># build a list of interfaces that will be used in this read</span>
        <span class="n">interfaces</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">delegator</span> <span class="ow">in</span> <span class="n">delegator_list</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">interface</span> <span class="ow">in</span> <span class="n">delegator</span><span class="o">.</span><span class="n">get_interfaces</span><span class="p">():</span>
                <span class="n">interfaces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">interface</span><span class="p">)</span>
        
        <span class="n">remaining_delegators</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">interface_thread_groups</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_com_nodes_for_threads_filter</span><span class="p">(</span><span class="n">interfaces</span><span class="p">)</span>
        <span class="n">work_units</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">interface_thread_groups</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">interface_group</span> <span class="ow">in</span> <span class="n">interface_thread_groups</span><span class="p">:</span>
                <span class="c">#build a group of delegators for each potential thread</span>
                <span class="n">delegator_group</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">remaining_delegators</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">delegator</span> <span class="ow">in</span> <span class="n">delegator_list</span><span class="p">:</span>
                    <span class="n">interfaces</span> <span class="o">=</span> <span class="n">delegator</span><span class="o">.</span><span class="n">get_interfaces</span><span class="p">()</span>
                    <span class="c"># a delegator without interfaces cannot be threaded since I dont know how it works</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">interfaces</span><span class="p">)</span> <span class="ow">and</span> <span class="n">interfaces</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="n">interface_group</span><span class="p">):</span>
                        <span class="n">delegator_group</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">delegator</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">remaining_delegators</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">delegator</span><span class="p">)</span>
                        
                <span class="c">#build a list of channels for that group of delegators to read</span>
                <span class="n">delegator_groups_channel_list</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">delegator</span> <span class="ow">in</span> <span class="n">delegator_group</span><span class="p">:</span> <span class="c">#this is where the channel reads become unordered...</span>
                    <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="n">channel_list</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">channel</span><span class="o">.</span><span class="n">resolve_delegator</span><span class="p">()</span> <span class="o">==</span> <span class="n">delegator</span><span class="p">:</span>
                            <span class="n">delegator_groups_channel_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">channel</span><span class="p">)</span>
                <span class="c">#start the threaded read here</span>
                <span class="c">#not threaded yet</span>
                <span class="n">work_units</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="c">#send channels to thread pool</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_read_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">delegator_groups_channel_list</span><span class="p">)</span>
                <span class="n">delegator_list</span> <span class="o">=</span> <span class="n">remaining_delegators</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">remaining_delegators</span> <span class="o">=</span> <span class="n">delegator_list</span>
        <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_threaded_results</span><span class="p">(</span><span class="n">work_units</span><span class="p">)</span>
        <span class="c">#group all the thread results here</span>
        <span class="c"># find the channels for any decelerators that couldn&#39;t be threaded</span>
        <span class="n">delegator_groups_channel_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">delegator</span> <span class="ow">in</span> <span class="n">remaining_delegators</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="n">channel_list</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">channel</span><span class="o">.</span><span class="n">resolve_delegator</span><span class="p">()</span> <span class="o">==</span> <span class="n">delegator</span><span class="p">:</span>
                    <span class="n">delegator_groups_channel_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">channel</span><span class="p">)</span>
        <span class="n">results</span><span class="o">.</span><span class="n">update</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_channels_non_threaded</span><span class="p">(</span><span class="n">delegator_groups_channel_list</span><span class="p">)</span> <span class="p">)</span>
        <span class="k">return</span> <span class="n">results</span>
    <span class="k">def</span> <span class="nf">start_threads</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">number</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_threaded</span> <span class="o">==</span> <span class="bp">False</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_threaded</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_threads</span> <span class="o">=</span> <span class="n">number</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_read_queue</span> <span class="o">=</span> <span class="n">Queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_read_results_queue</span> <span class="o">=</span> <span class="n">Queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">number</span><span class="p">):</span>
                <span class="n">thread</span><span class="o">.</span><span class="n">start_new_thread</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">threaded_read_function</span><span class="p">,</span> <span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;Threads already started, do not start again&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">threaded_read_function</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">_threaded</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">channel_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_queue</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">Queue</span><span class="o">.</span><span class="n">Empty</span><span class="p">:</span>
                <span class="c">#shouldn&#39;t get here</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_channels_non_threaded</span><span class="p">(</span><span class="n">channel_list</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">print</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_read_results_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_read_results_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">get_threaded_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">number</span><span class="p">):</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">number</span><span class="p">):</span>
            <span class="n">thread_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_results_queue</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">thread_results</span><span class="p">,</span><span class="ne">Exception</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">thread_results</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">results</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">thread_results</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">results</span>
    <span class="k">def</span> <span class="nf">read_all_channels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">categories</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">exclusions</span><span class="o">=</span><span class="p">[]):</span>
        <span class="sd">&#39;&#39;&#39;read all readable channels in channel group and return orderd dictionary of results. Optionally filter by list of categories.&#39;&#39;&#39;</span>
        <span class="n">channels</span> <span class="o">=</span> <span class="p">[</span> <span class="n">channel</span> <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_all_channels_list</span><span class="p">()</span> <span class="k">if</span> <span class="n">channel</span><span class="o">.</span><span class="n">is_readable</span><span class="p">()</span> <span class="ow">and</span> <span class="p">(</span><span class="n">categories</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">channel</span><span class="o">.</span><span class="n">get_category</span><span class="p">()</span> <span class="ow">in</span> <span class="n">categories</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolve_channel_list</span><span class="p">(</span><span class="n">exclusions</span><span class="p">):</span>
            <span class="n">channels</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">channel</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">read_channel_list</span><span class="p">(</span><span class="n">channels</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="c">#sort results by channel name</span>
    <span class="k">def</span> <span class="nf">remove_channel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">channel</span><span class="p">):</span>
        <span class="c">#note this delete will only remove from this channel_group, not from children</span>
        <span class="n">channel_name</span> <span class="o">=</span> <span class="n">channel</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">channel_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_channel_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;Channel &quot;{}&quot; is not a member of {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">channel_name</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">get_name</span><span class="p">()))</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_channel_dict</span><span class="p">[</span><span class="n">channel_name</span><span class="p">]</span>
    <span class="k">def</span> <span class="nf">remove_channel_group</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">channel_group_to_remove</span><span class="p">):</span>
        <span class="n">removed_channels</span> <span class="o">=</span> <span class="n">channel_group_to_remove</span><span class="o">.</span><span class="n">get_all_channels_list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">removed_channel</span> <span class="ow">in</span> <span class="n">removed_channels</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">remove_channel</span><span class="p">(</span><span class="n">removed_channel</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">remove_channel_by_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">channel_name</span><span class="p">):</span>
        <span class="n">channel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_channel</span><span class="p">(</span><span class="n">channel_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">remove_channel</span><span class="p">(</span><span class="n">channel</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">remove_all_channels_and_sub_groups</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_channel_dict</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sub_channel_groups</span> <span class="o">=</span> <span class="p">[]</span>  
    <span class="k">def</span> <span class="nf">remove_sub_channel_group</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">sub_channel_group</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sub_channel_groups</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">sub_channel_group</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">remove_category</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">category</span><span class="p">):</span>
        <span class="c">#note this delete will only remove from this channel_group, not from children</span>
        <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_all_channels_list</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">channel</span><span class="o">.</span><span class="n">get_category</span><span class="p">()</span> <span class="o">==</span> <span class="n">category</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">remove_channel</span><span class="p">(</span><span class="n">channel</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">debug_print</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">indent</span><span class="o">=</span><span class="s">&quot; &quot;</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_channel_dict</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">d</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
            <span class="k">if</span> <span class="n">ch</span><span class="o">.</span><span class="n">get_delegator</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">ch</span><span class="p">:</span>
                <span class="n">d</span> <span class="o">=</span> <span class="s">&quot;(delegated by {})&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ch</span><span class="o">.</span><span class="n">resolve_delegator</span><span class="p">())</span>
            <span class="k">print</span> <span class="s">&quot;{} {} {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">indent</span><span class="p">,</span><span class="n">ch</span><span class="p">,</span><span class="n">d</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">sub_channel_group</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sub_channel_groups</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;{} {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">indent</span><span class="p">,</span><span class="n">sub_channel_group</span><span class="p">)</span>
            <span class="n">sub_channel_group</span><span class="o">.</span><span class="n">debug_print</span><span class="p">(</span><span class="s">&quot;{}   &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">indent</span><span class="p">)</span> <span class="p">)</span>
            <span class="c">#remove the excluded items from the scan list</span>
    <span class="k">def</span> <span class="nf">remove_channel_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">item_list</span><span class="p">):</span>
        <span class="n">channel_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolve_channel_list</span><span class="p">(</span><span class="n">item_list</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="n">channel_list</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">remove_channel</span><span class="p">(</span><span class="n">channel</span><span class="p">)</span> 
    <span class="k">def</span> <span class="nf">resolve_channel_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">item_list</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;takes a list of channels, channel_names, or channel_groups and produces a single channel group&#39;&#39;&#39;</span>
        <span class="n">ch_group</span> <span class="o">=</span> <span class="n">channel_group</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">item_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span>
                <span class="n">ch_group</span><span class="o">.</span><span class="n">_add_channel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_channel</span><span class="p">(</span><span class="n">item</span><span class="p">))</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span><span class="n">channel</span><span class="p">):</span>
                <span class="n">ch_group</span><span class="o">.</span><span class="n">_add_channel</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span><span class="n">channel_group</span><span class="p">):</span>
                <span class="n">ch_group</span><span class="o">.</span><span class="n">merge_in_channel_group</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;Unknown input {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">item_list</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">ch_group</span>
    <span class="k">def</span> <span class="nf">clone</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c">#this builds a flattened group and tries to reconnect to the remote_channels</span>
        <span class="n">channels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_all_channels_list</span><span class="p">()</span>
        <span class="n">new_channels</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">remote_channel_group_clients</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">channels</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span><span class="n">remote_channel</span><span class="p">):</span>
                <span class="n">remote_channel_group_clients</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">ch</span><span class="o">.</span><span class="n">get_delegator</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">new_channels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">rcgc</span> <span class="ow">in</span> <span class="n">remote_channel_group_clients</span><span class="p">:</span>
            <span class="n">clone_rcgc</span> <span class="o">=</span> <span class="n">rcgc</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">channels</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ch</span><span class="o">.</span><span class="n">get_delegator</span><span class="p">()</span> <span class="o">==</span> <span class="n">rcgc</span><span class="p">:</span>
                    <span class="n">new_channels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">clone_rcgc</span><span class="p">[</span><span class="n">ch</span><span class="o">.</span><span class="n">get_name</span><span class="p">()])</span>
        <span class="n">new_group</span> <span class="o">=</span> <span class="n">channel_group</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span> <span class="o">+</span> <span class="s">&#39;_cloned&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">new_channels</span><span class="p">:</span>
            <span class="n">new_group</span><span class="o">.</span><span class="n">_add_channel</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">new_group</span>
    <span class="k">def</span> <span class="nf">write_html</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">sort_categories</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;return html document string and optionally write to file_name</span>
<span class="sd">        if verbose, include tables of presets and attributes for each channel</span>
<span class="sd">        if sort_categories, group channel names first by category before alphabetical sort of channel name&#39;&#39;&#39;</span>
        <span class="n">txt</span> <span class="o">=</span> <span class="s">&#39;&lt;!DOCTYPE html/&gt;&#39;</span>
        <span class="n">txt</span> <span class="o">+=</span> <span class="s">&#39;&lt;HTML&gt;</span><span class="se">\n</span><span class="s">&#39;</span>
        <span class="n">txt</span> <span class="o">+=</span> <span class="s">&#39;&lt;HEAD&gt;</span><span class="se">\n</span><span class="s">&#39;</span>
        <span class="n">txt</span> <span class="o">+=</span> <span class="s">&#39;&lt;META charset=&quot;UTF-8&quot;/&gt;</span><span class="se">\n</span><span class="s">&#39;</span>
        <span class="n">txt</span> <span class="o">+=</span> <span class="s">&#39;&lt;TITLE&gt;</span><span class="se">\n</span><span class="s">&#39;</span>
        <span class="n">txt</span> <span class="o">+=</span> <span class="s">&#39;Secret Channel Decoder Ring</span><span class="se">\n</span><span class="s">&#39;</span>
        <span class="n">txt</span> <span class="o">+=</span> <span class="s">&#39;&lt;/TITLE&gt;</span><span class="se">\n</span><span class="s">&#39;</span>
        <span class="n">txt</span> <span class="o">+=</span> <span class="s">&#39;&lt;STYLE&gt;</span><span class="se">\n</span><span class="s">&#39;</span>
        <span class="n">txt</span> <span class="o">+=</span> <span class="s">&#39;    table, th, td {</span><span class="se">\n</span><span class="s">&#39;</span>
        <span class="n">txt</span> <span class="o">+=</span> <span class="s">&#39;        border: 1px solid black;</span><span class="se">\n</span><span class="s">&#39;</span>
        <span class="n">txt</span> <span class="o">+=</span> <span class="s">&#39;        border-collapse: collapse;</span><span class="se">\n</span><span class="s">&#39;</span>
        <span class="n">txt</span> <span class="o">+=</span> <span class="s">&#39;    }</span><span class="se">\n</span><span class="s">&#39;</span>
        <span class="n">txt</span> <span class="o">+=</span> <span class="s">&#39;&lt;/STYLE&gt;</span><span class="se">\n</span><span class="s">&#39;</span>
        <span class="n">txt</span> <span class="o">+=</span> <span class="s">&#39;&lt;/HEAD&gt;</span><span class="se">\n</span><span class="s">&#39;</span>
        <span class="n">txt</span> <span class="o">+=</span> <span class="s">&#39;&lt;BODY&gt;</span><span class="se">\n</span><span class="s">&#39;</span>
        <span class="n">txt</span> <span class="o">+=</span> <span class="s">&#39;&lt;TABLE&gt;</span><span class="se">\n</span><span class="s">&#39;</span>
        <span class="n">txt</span> <span class="o">+=</span> <span class="s">&#39;&lt;TR&gt;</span><span class="se">\n</span><span class="s">&#39;</span>
        <span class="n">txt</span> <span class="o">+=</span> <span class="s">&#39;&lt;TH&gt;Channel Name&lt;/TH&gt;</span><span class="se">\n</span><span class="s">&#39;</span>
        <span class="n">txt</span> <span class="o">+=</span> <span class="s">&#39;&lt;TH&gt;Category&lt;/TH&gt;</span><span class="se">\n</span><span class="s">&#39;</span>
        <span class="n">txt</span> <span class="o">+=</span> <span class="s">&#39;&lt;TH&gt;Description&lt;/TH&gt;</span><span class="se">\n</span><span class="s">&#39;</span>
        <span class="n">txt</span> <span class="o">+=</span> <span class="s">&#39;&lt;/TR&gt;</span><span class="se">\n</span><span class="s">&#39;</span>
        <span class="n">channels</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_all_channels_list</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">ch</span><span class="p">:</span> <span class="n">ch</span><span class="o">.</span><span class="n">get_name</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">sort_categories</span><span class="p">:</span>
            <span class="n">channels</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">channels</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">ch</span><span class="p">:</span> <span class="n">ch</span><span class="o">.</span><span class="n">get_category</span><span class="p">())</span> <span class="c">#stable sort preserves name sort above when tied</span>
        <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="n">channels</span><span class="p">:</span>
            <span class="n">txt</span> <span class="o">+=</span> <span class="s">&#39;&lt;TR&gt;</span><span class="se">\n</span><span class="s">&#39;</span>
            <span class="n">txt</span> <span class="o">+=</span> <span class="s">&#39;&lt;TD&gt;{}&lt;/TD&gt;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">channel</span><span class="o">.</span><span class="n">get_name</span><span class="p">())</span>
            <span class="n">txt</span> <span class="o">+=</span> <span class="s">&#39;&lt;TD&gt;{}&lt;/TD&gt;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">channel</span><span class="o">.</span><span class="n">get_category</span><span class="p">())</span>
            <span class="n">txt</span> <span class="o">+=</span> <span class="s">&#39;&lt;TD&gt;</span><span class="se">\n</span><span class="s">&#39;</span>
            <span class="n">txt</span> <span class="o">+=</span> <span class="s">&#39;&lt;P&gt;</span><span class="se">\n</span><span class="s">&#39;</span>
            <span class="n">txt</span> <span class="o">+=</span> <span class="s">u&#39;{}</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">channel</span><span class="o">.</span><span class="n">get_description</span><span class="p">())</span>
            <span class="n">txt</span> <span class="o">+=</span> <span class="s">&#39;&lt;/P&gt;</span><span class="se">\n</span><span class="s">&#39;</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="c">#add presets and attributes</span>
                <span class="n">txt</span> <span class="o">+=</span> <span class="s">&#39;&lt;P style=&quot;margin-left: 40px&quot;&gt;</span><span class="se">\n</span><span class="s">&#39;</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">channel</span><span class="o">.</span><span class="n">get_presets</span><span class="p">()):</span>
                        <span class="n">ps_dict</span> <span class="o">=</span> <span class="n">channel</span><span class="o">.</span><span class="n">get_presets_dict</span><span class="p">()</span>
                        <span class="n">txt</span> <span class="o">+=</span> <span class="s">&#39;&lt;TABLE&gt;</span><span class="se">\n</span><span class="s">&#39;</span>
                        <span class="n">txt</span> <span class="o">+=</span> <span class="s">&#39;&lt;TR&gt;&lt;TH&gt;Presets:&lt;/TH&gt;&lt;/TR&gt;</span><span class="se">\n</span><span class="s">&#39;</span>
                        <span class="k">for</span> <span class="n">ps</span> <span class="ow">in</span> <span class="n">channel</span><span class="o">.</span><span class="n">get_presets</span><span class="p">():</span>
                            <span class="n">txt</span> <span class="o">+=</span> <span class="s">&#39;&lt;TR&gt;&lt;TD&gt;{}: {}&lt;/TD&gt;&lt;/TR&gt;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ps</span><span class="p">,</span> <span class="n">ps_dict</span><span class="p">[</span><span class="n">ps</span><span class="p">])</span>
                        <span class="n">txt</span> <span class="o">+=</span> <span class="s">&#39;&lt;/TABLE&gt;&#39;</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="c">#Only integer_channels and registers can have presets</span>
                    <span class="k">pass</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">channel</span><span class="o">.</span><span class="n">get_attributes</span><span class="p">()):</span>
                    <span class="n">txt</span> <span class="o">+=</span> <span class="s">&#39;&lt;BR/&gt;</span><span class="se">\n</span><span class="s">&#39;</span>
                    <span class="n">txt</span> <span class="o">+=</span> <span class="s">&#39;&lt;TABLE&gt;</span><span class="se">\n</span><span class="s">&#39;</span>
                    <span class="n">txt</span> <span class="o">+=</span> <span class="s">&#39;&lt;TR&gt;&lt;TH&gt;Attributes:&lt;/TH&gt;&lt;/TR&gt;</span><span class="se">\n</span><span class="s">&#39;</span>
                    <span class="k">for</span> <span class="n">attrib</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">channel</span><span class="o">.</span><span class="n">get_attributes</span><span class="p">()):</span>
                        <span class="n">txt</span> <span class="o">+=</span> <span class="s">&#39;&lt;TR&gt;&lt;TD&gt;{}: {}&lt;/TD&gt;&lt;/TR&gt;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">attrib</span><span class="p">,</span> <span class="n">channel</span><span class="o">.</span><span class="n">get_attribute</span><span class="p">(</span><span class="n">attrib</span><span class="p">))</span>
                    <span class="n">txt</span> <span class="o">+=</span> <span class="s">&#39;&lt;/TABLE&gt;&#39;</span>
                <span class="n">txt</span> <span class="o">+=</span> <span class="s">&#39;&lt;/P&gt;</span><span class="se">\n</span><span class="s">&#39;</span>
            <span class="n">txt</span> <span class="o">+=</span> <span class="s">&#39;&lt;/TD&gt;</span><span class="se">\n</span><span class="s">&#39;</span>
            <span class="n">txt</span> <span class="o">+=</span> <span class="s">&#39;&lt;/TR&gt;</span><span class="se">\n</span><span class="s">&#39;</span>
        <span class="n">txt</span> <span class="o">+=</span> <span class="s">&#39;&lt;/TABLE&gt;</span><span class="se">\n</span><span class="s">&#39;</span>
        <span class="n">txt</span> <span class="o">+=</span> <span class="s">&#39;&lt;/BODY&gt;</span><span class="se">\n</span><span class="s">&#39;</span>
        <span class="n">txt</span> <span class="o">+=</span> <span class="s">&#39;&lt;/HTML&gt;</span><span class="se">\n</span><span class="s">&#39;</span>
        <span class="k">if</span> <span class="n">file_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">txt</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">))</span>
                <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">txt</span>
        
<div class="viewcode-block" id="instrument"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_core.html#PyICe.lab_core.instrument">[docs]</a><span class="k">class</span> <span class="nc">instrument</span><span class="p">(</span><span class="n">channel_group</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Superclass for all lab instruments</span>
<span class="sd">       To add an instrument to a lab_bench object, it must inherit from instrument or one of its specialized subclasses</span>
<span class="sd">        Rules for adding instruments:</span>
<span class="sd">          1) extend instrument class</span>
<span class="sd">          2) call the instrument classes __init__ from its __init__</span>
<span class="sd">          3) contain an add_channel (and/or add_channel_XXXXX) methods that:</span>
<span class="sd">                a) create a channel object with a:</span>
<span class="sd">                    1) name</span>
<span class="sd">                    2) EITHER a read_function or write_function</span>
<span class="sd">                b) call the _add_channel method with that channel as an argument</span>
<span class="sd">          4) has a name attribute which is a meaningful string about the instrument</span>
<span class="sd">          &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">name</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Overload method in instrument specific class, the __init__ method should call instrument.__init__(self,name).</span>
<span class="sd">        if an instrument uses an interface, it must call an add_interface_ function from this class of the appropriate type&#39;&#39;&#39;</span>
        <span class="n">channel_group</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_interfaces</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s">&#39;_base_name&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_base_name</span> <span class="o">=</span> <span class="s">&quot;unnamed instrument&quot;</span>
<div class="viewcode-block" id="instrument.add_channel"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_core.html#PyICe.lab_core.instrument.add_channel">[docs]</a>    <span class="k">def</span> <span class="nf">add_channel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">channel_name</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Usage: Add channel name to instrument.  For multi-channel instruments,</span>
<span class="sd">            typically also takes a second argument representing the physical</span>
<span class="sd">            channel of the instrument. May also take channel configuration arguments specific to the instrument.</span>

<span class="sd">           Operation:  This method should create the channel object then call self._add_channel(channel) to add it to the internal channel group</span>

<span class="sd">            Method must be overloaded by each instrument driver.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;Add channel method not implemented for instrument {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_name</span><span class="p">()))</span></div>
<div class="viewcode-block" id="instrument.get_error"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_core.html#PyICe.lab_core.instrument.get_error">[docs]</a>    <span class="k">def</span> <span class="nf">get_error</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Return the first error from the instrument.  Overload in scpi_instrument or the actual instrument class&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="s">&#39;Error checking not implemented for this instrument&#39;</span></div>
<div class="viewcode-block" id="instrument.get_errors"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_core.html#PyICe.lab_core.instrument.get_errors">[docs]</a>    <span class="k">def</span> <span class="nf">get_errors</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Return a list of all errors from the instrument.  Overload in scpi_instrument or the actual instrument class&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="p">[</span><span class="s">&#39;Error checking not implemented for this instrument&#39;</span><span class="p">]</span>        </div>
    <span class="k">def</span> <span class="nf">_add_interface</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">interface</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_interfaces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">interface</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">get_interface</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_interfaces</span><span class="p">[</span><span class="n">num</span><span class="p">]</span>
    <span class="k">def</span> <span class="nf">set_category</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">category_name</span><span class="p">,</span> <span class="n">update_existing_channels</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_base_name</span> <span class="o">=</span> <span class="n">category_name</span>
        <span class="k">if</span> <span class="n">update_existing_channels</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
                <span class="n">channel</span><span class="o">.</span><span class="n">set_category</span><span class="p">(</span><span class="n">category_name</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">add_interface_visa</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">interface_visa</span><span class="p">,</span><span class="n">timeout</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">interface_visa</span><span class="p">,</span><span class="n">lab_interfaces</span><span class="o">.</span><span class="n">interface_visa</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;Interface must be a visa interface,, interface is {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">interface_visa</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">timeout</span> <span class="o">&gt;</span> <span class="n">interface_visa</span><span class="o">.</span><span class="n">timeout</span><span class="p">:</span>
            <span class="c"># only increase a timeout if it is shared it may be to fast for the others</span>
            <span class="n">interface_visa</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">timeout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_interface</span><span class="p">(</span><span class="n">interface_visa</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">add_interface_raw_serial</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">interface_raw_serial</span><span class="p">,</span><span class="n">timeout</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">baudrate</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">interface_raw_serial</span><span class="p">,</span><span class="n">lab_interfaces</span><span class="o">.</span><span class="n">interface_raw_serial</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;Interface must be a raw serial interface, interface is {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">interface_raw_serial</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">timeout</span> <span class="o">&gt;</span> <span class="n">interface_raw_serial</span><span class="o">.</span><span class="n">timeout</span><span class="p">:</span>
            <span class="c"># only increase a timeout if it is shared it may be to fast for the others</span>
            <span class="n">interface_raw_serial</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">timeout</span>
        <span class="k">if</span> <span class="n">baudrate</span><span class="p">:</span>
            <span class="n">interface_raw_serial</span><span class="o">.</span><span class="n">baudrate</span> <span class="o">=</span> <span class="n">baudrate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_interface</span><span class="p">(</span><span class="n">interface_raw_serial</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">add_interface_twi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">interface_twi</span><span class="p">,</span><span class="n">timeout</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">interface_twi</span><span class="p">,</span><span class="n">lab_interfaces</span><span class="o">.</span><span class="n">interface_twi</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;Interface must be a twi interface, interface is {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">interface_twi</span><span class="p">))</span>        
        <span class="k">if</span> <span class="n">timeout</span> <span class="o">&gt;</span> <span class="n">interface_twi</span><span class="o">.</span><span class="n">timeout</span><span class="p">:</span>
            <span class="c"># only increase a timeout if it is shared it may be to fast for the others</span>
            <span class="n">interface_twi</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">timeout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_interface</span><span class="p">(</span><span class="n">interface_twi</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">add_interface_spi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">interface_spi</span><span class="p">,</span><span class="n">timeout</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">baudrate</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">interface_spi</span><span class="p">,</span><span class="n">lab_interfaces</span><span class="o">.</span><span class="n">interface_spi</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;Interface must be an spi interface, interface is {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">interface_spi</span><span class="p">))</span>        
        <span class="k">if</span> <span class="n">timeout</span> <span class="o">&gt;</span> <span class="n">interface_spi</span><span class="o">.</span><span class="n">timeout</span><span class="p">:</span>
            <span class="c"># only increase a timeout if it is shared it may be to fast for the others</span>
            <span class="n">interface_spi</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">timeout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_interface</span><span class="p">(</span><span class="n">interface_spi</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_add_channel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">channel</span><span class="p">):</span>
        <span class="c">#overload _add_channel to do some automatic repetive tasks before </span>
        <span class="c">#  letting channel_group do the rest</span>
        <span class="k">for</span> <span class="n">interface</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_interfaces</span><span class="p">:</span>
            <span class="n">channel</span><span class="o">.</span><span class="n">add_interface</span><span class="p">(</span><span class="n">interface</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">channel</span><span class="o">.</span><span class="n">get_category</span><span class="p">()</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">channel</span><span class="o">.</span><span class="n">set_category</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_base_name</span><span class="p">)</span>
        <span class="n">channel_group</span><span class="o">.</span><span class="n">_add_channel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">channel</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">channel</span>
            </div>
<div class="viewcode-block" id="scpi_instrument"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_core.html#PyICe.lab_core.scpi_instrument">[docs]</a><span class="k">class</span> <span class="nc">scpi_instrument</span><span class="p">(</span><span class="n">instrument</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;SCPI Instrument Base Class. Implements methods common to all SCPI instruments</span>
<span class="sd">        Instruments which adhere to the SCPI specification should inherit from the</span>
<span class="sd">        scpi_instrument class rather than the instrument class.</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="scpi_instrument.get_error"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_core.html#PyICe.lab_core.scpi_instrument.get_error">[docs]</a>    <span class="k">def</span> <span class="nf">get_error</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Return the first error from the SCPI instrument.  +0 is the errorcode for no error&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">()</span></div>
<div class="viewcode-block" id="scpi_instrument.get_errors"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_core.html#PyICe.lab_core.scpi_instrument.get_errors">[docs]</a>    <span class="k">def</span> <span class="nf">get_errors</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Return a list of all accumulated SCPI instrument errors.&#39;&#39;&#39;</span>
        <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">while</span><span class="p">(</span><span class="bp">True</span><span class="p">):</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_error</span><span class="p">()</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;,&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;+0&#39;</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">errors</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;,&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;0&#39;</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">errors</span></div>
<div class="viewcode-block" id="scpi_instrument.beep"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_core.html#PyICe.lab_core.scpi_instrument.beep">[docs]</a>    <span class="k">def</span> <span class="nf">beep</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Send a beep command.&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_interface</span><span class="p">()</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;SYST:BEEP&quot;</span><span class="p">)</span></div>
<div class="viewcode-block" id="scpi_instrument.clear_status"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_core.html#PyICe.lab_core.scpi_instrument.clear_status">[docs]</a>    <span class="k">def</span> <span class="nf">clear_status</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Send the *CLS command.&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_interface</span><span class="p">()</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;*CLS&quot;</span><span class="p">)</span></div>
<div class="viewcode-block" id="scpi_instrument.display_clear"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_core.html#PyICe.lab_core.scpi_instrument.display_clear">[docs]</a>    <span class="k">def</span> <span class="nf">display_clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Clear the instrument display&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_interface</span><span class="p">()</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;DISP:TEXT:CLE&quot;</span><span class="p">)</span>  </div>
<div class="viewcode-block" id="scpi_instrument.display_off"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_core.html#PyICe.lab_core.scpi_instrument.display_off">[docs]</a>    <span class="k">def</span> <span class="nf">display_off</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Turn the instrument display off&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_interface</span><span class="p">()</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;DISP OFF&#39;</span><span class="p">)</span></div>
<div class="viewcode-block" id="scpi_instrument.display_on"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_core.html#PyICe.lab_core.scpi_instrument.display_on">[docs]</a>    <span class="k">def</span> <span class="nf">display_on</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Turn the instrument display on&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_interface</span><span class="p">()</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;DISP ON&#39;</span><span class="p">)</span></div>
<div class="viewcode-block" id="scpi_instrument.display_text"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_core.html#PyICe.lab_core.scpi_instrument.display_text">[docs]</a>    <span class="k">def</span> <span class="nf">display_text</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">text</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Display text on instrument front panel&#39;&#39;&#39;</span>
        <span class="n">command</span><span class="o">=</span><span class="s">&quot;DISP:TEXT &#39;&quot;</span><span class="o">+</span><span class="n">text</span><span class="o">+</span><span class="s">&quot;&#39;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_interface</span><span class="p">()</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">command</span><span class="p">)</span></div>
<div class="viewcode-block" id="scpi_instrument.enable_serial_polling"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_core.html#PyICe.lab_core.scpi_instrument.enable_serial_polling">[docs]</a>    <span class="k">def</span> <span class="nf">enable_serial_polling</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Enable the instrument to report operation complete via serial polling&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clear_status</span><span class="p">()</span>     <span class="c">#clear the stauts register</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_interface</span><span class="p">()</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;*ESE 1&quot;</span><span class="p">)</span>    <span class="c">#enable the operation complete bit in the event register</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_interface</span><span class="p">()</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;*SRE 32&quot;</span><span class="p">)</span>   <span class="c">#enable the event register to update the status register</span></div>
<div class="viewcode-block" id="scpi_instrument.error"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_core.html#PyICe.lab_core.scpi_instrument.error">[docs]</a>    <span class="k">def</span> <span class="nf">error</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get error message.&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_interface</span><span class="p">()</span><span class="o">.</span><span class="n">ask</span><span class="p">(</span><span class="s">&quot;SYST:ERROR?&quot;</span><span class="p">)</span></div>
<div class="viewcode-block" id="scpi_instrument.operation_complete"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_core.html#PyICe.lab_core.scpi_instrument.operation_complete">[docs]</a>    <span class="k">def</span> <span class="nf">operation_complete</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;query if current operation is done</span>
<span class="sd">            blocks i/o until operation is complete or timeout</span>
<span class="sd">            this method retries query until a character is returned in cas of premature timeout</span>
<span class="sd">            EDIT - delet retry for now</span>
<span class="sd">            &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_interface</span><span class="p">()</span><span class="o">.</span><span class="n">ask</span><span class="p">(</span><span class="s">&#39;*OPC?&#39;</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_interface</span><span class="p">()</span><span class="o">.</span><span class="n">ask</span><span class="p">(</span><span class="s">&#39;*OPC?&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">response</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">response</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&#39;*OPC? Timeout!: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">response</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">operation_complete</span><span class="p">()</span></div>
<div class="viewcode-block" id="scpi_instrument.fetch"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_core.html#PyICe.lab_core.scpi_instrument.fetch">[docs]</a>    <span class="k">def</span> <span class="nf">fetch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Send FETCH? query.&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_interface</span><span class="p">()</span><span class="o">.</span><span class="n">ask</span><span class="p">(</span><span class="s">&quot;FETCH?&quot;</span><span class="p">)</span></div>
<div class="viewcode-block" id="scpi_instrument.init"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_core.html#PyICe.lab_core.scpi_instrument.init">[docs]</a>    <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Send INIT command.&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_interface</span><span class="p">()</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;INIT&quot;</span><span class="p">)</span>    </div>
<div class="viewcode-block" id="scpi_instrument.initiate_measurement"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_core.html#PyICe.lab_core.scpi_instrument.initiate_measurement">[docs]</a>    <span class="k">def</span> <span class="nf">initiate_measurement</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">enable_polling</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Initiate a measurement&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">enable_polling</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">enable_serial_polling</span><span class="p">()</span>         <span class="c">#enable serial polling</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">clear_status</span><span class="p">()</span>                  <span class="c">#clear the status register     </span>
            <span class="bp">self</span><span class="o">.</span><span class="n">operation_complete</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_interface</span><span class="p">()</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;*OPC&quot;</span><span class="p">)</span>         <span class="c">#enable operation complete update to the status register</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">operation_complete</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="p">()</span></div>
<div class="viewcode-block" id="scpi_instrument.read_measurement"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_core.html#PyICe.lab_core.scpi_instrument.read_measurement">[docs]</a>    <span class="k">def</span> <span class="nf">read_measurement</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Send FETCH? query.&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_interface</span><span class="p">()</span><span class="o">.</span><span class="n">ask</span><span class="p">(</span><span class="s">&quot;FETCH?&quot;</span><span class="p">)</span></div>
<div class="viewcode-block" id="scpi_instrument.reset"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_core.html#PyICe.lab_core.scpi_instrument.reset">[docs]</a>    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Send the *RST command.&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_interface</span><span class="p">()</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;*RST&quot;</span><span class="p">)</span></div>
<div class="viewcode-block" id="scpi_instrument.trigger"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_core.html#PyICe.lab_core.scpi_instrument.trigger">[docs]</a>    <span class="k">def</span> <span class="nf">trigger</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Send the *TRG command.&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_interface</span><span class="p">()</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;*TRG&#39;</span><span class="p">)</span></div>
<div class="viewcode-block" id="scpi_instrument.identify"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_core.html#PyICe.lab_core.scpi_instrument.identify">[docs]</a>    <span class="k">def</span> <span class="nf">identify</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Send the *IDN? command.&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_interface</span><span class="p">()</span><span class="o">.</span><span class="n">ask</span><span class="p">(</span><span class="s">&#39;*IDN?&#39;</span><span class="p">)</span>
</div></div>
<span class="k">class</span> <span class="nc">remote_channel_group_server</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="c"># this class takes a channel groups and makes it remotely accessible</span>
    <span class="c"># it currently does not support changing channels after creation</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">channel_group_object</span><span class="p">,</span><span class="n">address</span><span class="o">=</span><span class="s">&#39;localhost&#39;</span><span class="p">,</span><span class="n">port</span><span class="o">=</span><span class="mi">5001</span><span class="p">,</span><span class="n">authkey</span><span class="o">=</span><span class="s">&#39;ltc_lab&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">channel_group</span> <span class="o">=</span> <span class="n">channel_group_object</span>
        <span class="k">class</span> <span class="nc">channel_group_manager</span><span class="p">(</span><span class="n">multiprocessing</span><span class="o">.</span><span class="n">managers</span><span class="o">.</span><span class="n">BaseManager</span><span class="p">):</span> <span class="k">pass</span>
        <span class="n">channel_group_manager</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s">&#39;channel&#39;</span><span class="p">)</span>
        <span class="n">channel_group_manager</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s">&#39;get_channel_server&#39;</span><span class="p">,</span><span class="nb">callable</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">channel_group</span><span class="p">,</span> <span class="n">method_to_typeid</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;get_channel&#39;</span><span class="p">:</span><span class="s">&#39;channel&#39;</span><span class="p">}</span> <span class="p">)</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">cgm</span> <span class="o">=</span> <span class="n">channel_group_manager</span><span class="p">(</span><span class="n">address</span><span class="o">=</span><span class="p">(</span><span class="n">address</span><span class="p">,</span><span class="n">port</span><span class="p">),</span><span class="n">authkey</span><span class="o">=</span><span class="n">authkey</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">serve_forever</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">print</span> <span class="s">&quot;Launching remote server listening at address {}:{}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cgm</span><span class="o">.</span><span class="n">address</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">cgm</span><span class="o">.</span><span class="n">address</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">server</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cgm</span><span class="o">.</span><span class="n">get_server</span><span class="p">()</span>
        <span class="n">server</span><span class="o">.</span><span class="n">serve_forever</span><span class="p">()</span>
        
<span class="k">class</span> <span class="nc">remote_channel</span><span class="p">(</span><span class="n">channel</span><span class="p">):</span>
    <span class="c"># this handles both registers and channels</span>
    <span class="n">methods_to_proxy</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;__str__&#39;</span><span class="p">,</span>
                <span class="c">#integer_channel methods:</span>
                <span class="s">&#39;add_format&#39;</span><span class="p">,</span>
                <span class="s">&#39;add_preset&#39;</span><span class="p">,</span>
                <span class="s">&#39;format&#39;</span><span class="p">,</span>
                <span class="s">&#39;format_read&#39;</span><span class="p">,</span>
                <span class="s">&#39;format_write&#39;</span><span class="p">,</span>
                <span class="s">&#39;get_format&#39;</span><span class="p">,</span>
                <span class="s">&#39;get_formats&#39;</span><span class="p">,</span>
                <span class="s">&#39;get_max_write_limit&#39;</span><span class="p">,</span>
                <span class="s">&#39;get_min_write_limit&#39;</span><span class="p">,</span>
                <span class="s">&#39;get_presets&#39;</span><span class="p">,</span>
                <span class="s">&#39;get_presets_dict&#39;</span><span class="p">,</span>
                <span class="s">&#39;get_units&#39;</span><span class="p">,</span>
                <span class="c">#&#39;read_without_delegator&#39;,</span>
                <span class="s">&#39;remove_format&#39;</span><span class="p">,</span>
                <span class="s">&#39;set_format&#39;</span><span class="p">,</span>
                <span class="s">&#39;signedToTwosComplement&#39;</span><span class="p">,</span>
                <span class="s">&#39;twosComplementToSigned&#39;</span><span class="p">,</span>
                <span class="s">&#39;unformat&#39;</span><span class="p">,</span>
                <span class="s">&#39;use_presets_read&#39;</span><span class="p">,</span>
                <span class="s">&#39;use_presets_write&#39;</span><span class="p">,</span>
                <span class="s">&#39;using_presets_read&#39;</span><span class="p">,</span>
                <span class="s">&#39;using_presets_write&#39;</span><span class="p">,</span>
                <span class="s">&#39;write&#39;</span><span class="p">,</span>
                <span class="s">&#39;write_unformatted&#39;</span><span class="p">,</span>
                
                <span class="c">#channel methods:</span>
                <span class="s">&#39;add_read_callback&#39;</span><span class="p">,</span>
                <span class="s">&#39;add_write_callback&#39;</span><span class="p">,</span>
                <span class="s">&#39;format_display&#39;</span><span class="p">,</span>
                <span class="s">&#39;get_attribute&#39;</span><span class="p">,</span>
                <span class="s">&#39;get_attributes&#39;</span><span class="p">,</span>
                <span class="s">&#39;get_category&#39;</span><span class="p">,</span>
                <span class="s">&#39;get_description&#39;</span><span class="p">,</span>
                <span class="s">&#39;get_name&#39;</span><span class="p">,</span>
                <span class="s">&#39;get_write_delay&#39;</span><span class="p">,</span>
                <span class="s">&#39;is_readable&#39;</span><span class="p">,</span>
                <span class="s">&#39;is_writeable&#39;</span><span class="p">,</span>
                <span class="s">&#39;read&#39;</span><span class="p">,</span>
                <span class="s">&#39;set_attribute&#39;</span><span class="p">,</span>
                <span class="s">&#39;set_category&#39;</span><span class="p">,</span>
                <span class="s">&#39;set_description&#39;</span><span class="p">,</span>
                <span class="s">&#39;set_display_format_function&#39;</span><span class="p">,</span>
                <span class="s">&#39;set_display_format_str&#39;</span><span class="p">,</span>
                <span class="s">&#39;set_max_write_limit&#39;</span><span class="p">,</span>
                <span class="s">&#39;set_min_write_limit&#39;</span><span class="p">,</span>
                <span class="s">&#39;set_name&#39;</span><span class="p">,</span>
                <span class="s">&#39;set_read_access&#39;</span><span class="p">,</span>
                <span class="s">&#39;set_write_access&#39;</span><span class="p">,</span>
                <span class="s">&#39;set_write_delay&#39;</span><span class="p">,</span>
                
                <span class="c">#delegator methods omitted</span>
                <span class="p">]</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">proxy_channel</span><span class="p">,</span><span class="n">parent_delegator</span><span class="p">):</span>
        <span class="c">#this intentially does not call the init of channel,just delegator</span>
        <span class="n">delegator</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_delegator</span><span class="p">(</span><span class="n">parent_delegator</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_proxy_delegator</span> <span class="o">=</span> <span class="n">delegator</span>
        <span class="k">for</span> <span class="n">method</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">methods_to_proxy</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span> <span class="n">proxy_channel</span><span class="p">,</span> <span class="n">method</span><span class="p">):</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">proxy_channel</span><span class="p">,</span> <span class="n">method</span><span class="p">))</span>


<span class="k">class</span> <span class="nc">remote_channel_group_client</span><span class="p">(</span><span class="n">channel_group</span><span class="p">,</span><span class="n">delegator</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">address</span><span class="o">=</span><span class="s">&#39;localhost&#39;</span><span class="p">,</span><span class="n">port</span><span class="o">=</span><span class="mi">5001</span><span class="p">,</span><span class="n">authkey</span><span class="o">=</span><span class="s">&#39;ltc_lab&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_address</span> <span class="o">=</span> <span class="n">address</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_port</span> <span class="o">=</span> <span class="n">port</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_authkey</span><span class="o">=</span><span class="n">authkey</span>
        <span class="n">channel_group</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s">&#39;remote_channel @ {}:{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">address</span><span class="p">,</span><span class="n">port</span><span class="p">))</span>
        <span class="n">delegator</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">class</span> <span class="nc">channel_group_manager</span><span class="p">(</span><span class="n">multiprocessing</span><span class="o">.</span><span class="n">managers</span><span class="o">.</span><span class="n">BaseManager</span><span class="p">):</span> <span class="k">pass</span>
        <span class="n">channel_group_manager</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s">&#39;channel&#39;</span><span class="p">)</span>
        <span class="n">channel_group_manager</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s">&#39;get_channel_server&#39;</span><span class="p">)</span>
        <span class="c">#check if the port is open, there doesn&#39;t seem to be a way to time out so check first</span>
        <span class="kn">import</span> <span class="nn">socket</span><span class="p">;</span>
        <span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">sock</span><span class="o">.</span><span class="n">connect_ex</span><span class="p">((</span><span class="n">address</span><span class="p">,</span><span class="n">port</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">result</span><span class="p">:</span>  
            <span class="c">#the port is not open </span>
            <span class="k">raise</span> <span class="n">RemoteChannelGroupException</span><span class="p">(</span><span class="s">&#39;Unable to connect: {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cgm</span> <span class="o">=</span> <span class="n">channel_group_manager</span><span class="p">(</span><span class="n">address</span><span class="o">=</span><span class="p">(</span><span class="n">address</span><span class="p">,</span><span class="n">port</span><span class="p">),</span><span class="n">authkey</span><span class="o">=</span><span class="n">authkey</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cgm</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">server</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cgm</span><span class="o">.</span><span class="n">get_channel_server</span><span class="p">()</span>
        <span class="n">names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">get_all_channel_names</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
            <span class="n">ch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">get_channel</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_channel</span><span class="p">(</span><span class="n">remote_channel</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span><span class="bp">self</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">read_delegated_channel_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">channel_list</span><span class="p">):</span>
        <span class="n">channel_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">ch</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">channel_list</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">read_channels</span><span class="p">(</span><span class="n">channel_names</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">clone</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">remote_channel_group_client</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_address</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_port</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_authkey</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">RemoteChannelGroupException</span><span class="p">(</span><span class="n">ChannelException</span><span class="p">):</span>
    <span class="k">pass</span>

<div class="viewcode-block" id="channel_master"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_core.html#PyICe.lab_core.channel_master">[docs]</a><span class="k">class</span> <span class="nc">channel_master</span><span class="p">(</span><span class="n">channel_group</span><span class="p">,</span><span class="n">delegator</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Master channel collection. There is typically only one. It replaces the old lab_bench </span>
<span class="sd">    as the main point of interaction with channels.  Channels and channel_groups (instruments) may</span>
<span class="sd">    be added to it.  It also creates dummy and virtual channels and adds them to its collection.  It also </span>
<span class="sd">    supports virtual_caching channels; these can use cached data if available during logging or other multiple channel read.&#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="nb">object</span><span class="o">.</span><span class="n">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="c">#remove Python &lt;&gt; because Qt interpret&#39;s them as HTML tags</span>
        <span class="n">channel_group</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="n">delegator</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_caching_mode</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_verbose</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_read_callbacks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_write_callbacks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_threads</span><span class="p">(</span><span class="mi">24</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">set_verbose</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_verbose</span> <span class="o">=</span> <span class="n">verbose</span>
    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">channel_or_group</span><span class="p">):</span>
        <span class="n">channel_group</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">channel_or_group</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verbose</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&#39;Added: {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">channel_or_group</span><span class="o">.</span><span class="n">get_name</span><span class="p">())</span>
<div class="viewcode-block" id="channel_master.add_channel_virtual"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_core.html#PyICe.lab_core.channel_master.add_channel_virtual">[docs]</a>    <span class="k">def</span> <span class="nf">add_channel_virtual</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">channel_name</span><span class="p">,</span><span class="n">read_function</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">write_function</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">integer_size</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Adds a channel named channel_name. Channel may have a read_function or a write_function but not both.</span>
<span class="sd">        If write_function is supplied, the write function is called with the value when written, and the last written value is returned when read.</span>
<span class="sd">        If read_function is supplied, this channel returns the return of read_function when read.</span>
<span class="sd">        If integer_size is not None, creates in integer_channel instead of a channel. integer_size should specify the number of data bits.</span>
<span class="sd">        Integer channels can add presets, formats.&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">integer_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">new_channel</span> <span class="o">=</span> <span class="n">integer_channel</span><span class="p">(</span><span class="n">channel_name</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="n">integer_size</span><span class="p">,</span><span class="n">read_function</span><span class="o">=</span><span class="n">read_function</span><span class="p">,</span><span class="n">write_function</span><span class="o">=</span><span class="n">write_function</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">new_channel</span> <span class="o">=</span> <span class="n">channel</span><span class="p">(</span><span class="n">channel_name</span><span class="p">,</span><span class="n">read_function</span><span class="o">=</span><span class="n">read_function</span><span class="p">,</span><span class="n">write_function</span><span class="o">=</span><span class="n">write_function</span><span class="p">)</span>
        <span class="n">new_channel</span><span class="o">.</span><span class="n">set_description</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span> <span class="o">+</span> <span class="s">&#39;: &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_channel_virtual</span><span class="o">.</span><span class="n">__doc__</span><span class="p">)</span>
        <span class="n">new_channel</span><span class="o">.</span><span class="n">set_category</span><span class="p">(</span><span class="s">&#39;Virtual&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_channel</span><span class="p">(</span><span class="n">new_channel</span><span class="p">)</span></div>
<div class="viewcode-block" id="channel_master.add_channel_virtual_caching"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_core.html#PyICe.lab_core.channel_master.add_channel_virtual_caching">[docs]</a>    <span class="k">def</span> <span class="nf">add_channel_virtual_caching</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">channel_name</span><span class="p">,</span><span class="n">read_function</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">write_function</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Adds a channel named channel_name. Channel may have a read_function or a write_function but not both.</span>
<span class="sd">        If write_function is supplied, the write function is called with the value when written, and the last written value is returned when read.</span>
<span class="sd">        If read_function is supplied, this channel returns the return of read_function when read.</span>
<span class="sd">        If the read_function calls the creating channel_master&#39;s read_channel on another channel,</span>
<span class="sd">        a cached value may be used if part of a multi-channel channel read. This can improve logging speed in some cases.&#39;&#39;&#39;</span>
        <span class="n">new_channel</span> <span class="o">=</span> <span class="n">channel</span><span class="p">(</span><span class="n">channel_name</span><span class="p">,</span><span class="n">read_function</span><span class="o">=</span><span class="n">read_function</span><span class="p">,</span><span class="n">write_function</span><span class="o">=</span><span class="n">write_function</span><span class="p">)</span>
        <span class="n">new_channel</span><span class="o">.</span><span class="n">set_delegator</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">new_channel</span><span class="o">.</span><span class="n">set_description</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span> <span class="o">+</span> <span class="s">&#39;: &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_channel_virtual_caching</span><span class="o">.</span><span class="n">__doc__</span><span class="p">)</span>
        <span class="n">new_channel</span><span class="o">.</span><span class="n">set_category</span><span class="p">(</span><span class="s">&#39;Virtual&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_channel</span><span class="p">(</span><span class="n">new_channel</span><span class="p">)</span></div>
<div class="viewcode-block" id="channel_master.add_channel_dummy"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_core.html#PyICe.lab_core.channel_master.add_channel_dummy">[docs]</a>    <span class="k">def</span> <span class="nf">add_channel_dummy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">channel_name</span><span class="p">,</span><span class="n">integer_size</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Add a named dummy channel. This can be used if a single physical instrument channel is externally multiplexed to </span>
<span class="sd">        multiple measurement nodes. The user can store the multiple measurement results from a single instrument into</span>
<span class="sd">        multiple dummy channels. Also it is useful for logging test conditions.&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">integer_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">new_channel</span> <span class="o">=</span> <span class="n">integer_channel</span><span class="p">(</span><span class="n">channel_name</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="n">integer_size</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">new_channel</span> <span class="o">=</span> <span class="n">channel</span><span class="p">(</span><span class="n">channel_name</span><span class="p">)</span>
        <span class="n">new_channel</span><span class="o">.</span><span class="n">set_description</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span> <span class="o">+</span> <span class="s">&#39;: &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_channel_dummy</span><span class="o">.</span><span class="n">__doc__</span><span class="p">)</span>
        <span class="n">new_channel</span><span class="o">.</span><span class="n">set_category</span><span class="p">(</span><span class="s">&#39;Virtual&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_channel</span><span class="p">(</span><span class="n">new_channel</span><span class="p">)</span></div>
<div class="viewcode-block" id="channel_master.add_channel_delta_timer"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_core.html#PyICe.lab_core.channel_master.add_channel_delta_timer">[docs]</a>    <span class="k">def</span> <span class="nf">add_channel_delta_timer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">channel_name</span><span class="p">,</span><span class="n">reciprocal</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Add a named timer channel. Returns the time elapsed since the prior channel read.</span>
<span class="sd">        Optionally, compute 1/time to return frequency instead.&#39;&#39;&#39;</span>
        <span class="k">class</span> <span class="nc">timer</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
            <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reciprocal</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reciprocal</span> <span class="o">=</span> <span class="n">reciprocal</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">last_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
            <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">this_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
                <span class="n">elapsed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">this_time</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_time</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">last_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">this_time</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">reciprocal</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">elapsed</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="c">#return native dimedelta instead?</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">return</span> <span class="mi">1</span><span class="o">/</span><span class="n">elapsed</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
                    <span class="k">except</span> <span class="ne">ZeroDivisionError</span><span class="p">:</span> <span class="c">#too fast?</span>
                        <span class="k">return</span> <span class="bp">None</span>
        <span class="n">new_channel</span> <span class="o">=</span> <span class="n">channel</span><span class="p">(</span><span class="n">channel_name</span><span class="p">,</span> <span class="n">read_function</span><span class="o">=</span><span class="n">timer</span><span class="p">(</span><span class="n">reciprocal</span><span class="p">))</span>
        <span class="n">new_channel</span><span class="o">.</span><span class="n">set_description</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span> <span class="o">+</span> <span class="s">&#39;: &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_channel_delta_timer</span><span class="o">.</span><span class="n">__doc__</span><span class="p">)</span>
        <span class="n">new_channel</span><span class="o">.</span><span class="n">set_category</span><span class="p">(</span><span class="s">&#39;Virtual&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_channel</span><span class="p">(</span><span class="n">new_channel</span><span class="p">)</span></div>
<div class="viewcode-block" id="channel_master.add_channel_total_timer"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_core.html#PyICe.lab_core.channel_master.add_channel_total_timer">[docs]</a>    <span class="k">def</span> <span class="nf">add_channel_total_timer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">channel_name</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Add a named timer channel. Returns the time elapsed since first channel read.&#39;&#39;&#39;</span>
        <span class="k">class</span> <span class="nc">timer</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
            <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">beginning</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">beginning</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">beginning</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">beginning</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="c">#return native dimedelta instead?</span>
        <span class="n">new_channel</span> <span class="o">=</span> <span class="n">channel</span><span class="p">(</span><span class="n">channel_name</span><span class="p">,</span> <span class="n">read_function</span><span class="o">=</span><span class="n">timer</span><span class="p">())</span>
        <span class="n">new_channel</span><span class="o">.</span><span class="n">set_description</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span> <span class="o">+</span> <span class="s">&#39;: &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_channel_total_timer</span><span class="o">.</span><span class="n">__doc__</span><span class="p">)</span>
        <span class="n">new_channel</span><span class="o">.</span><span class="n">set_category</span><span class="p">(</span><span class="s">&#39;Virtual&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_channel</span><span class="p">(</span><span class="n">new_channel</span><span class="p">)</span></div>
<div class="viewcode-block" id="channel_master.add_channel_counter"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_core.html#PyICe.lab_core.channel_master.add_channel_counter">[docs]</a>    <span class="k">def</span> <span class="nf">add_channel_counter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">channel_name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Add a named timer channel. Returns zero the first time channel is read and increments by one each time thereafter.&#39;&#39;&#39;</span>
        <span class="k">class</span> <span class="nc">counter</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
            <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">inc</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">inc</span> <span class="o">=</span> <span class="n">inc</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">=</span> <span class="n">init</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">inc</span>
            <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inc</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">count</span>
        <span class="n">new_channel</span> <span class="o">=</span> <span class="n">channel</span><span class="p">(</span><span class="n">channel_name</span><span class="p">,</span> <span class="n">read_function</span><span class="o">=</span><span class="n">counter</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>
        <span class="n">new_channel</span><span class="o">.</span><span class="n">set_description</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span> <span class="o">+</span> <span class="s">&#39;: &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_channel_counter</span><span class="o">.</span><span class="n">__doc__</span><span class="p">)</span>
        <span class="n">new_channel</span><span class="o">.</span><span class="n">set_category</span><span class="p">(</span><span class="s">&#39;Virtual&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_channel</span><span class="p">(</span><span class="n">new_channel</span><span class="p">)</span></div>
    <span class="k">def</span> <span class="nf">read_channel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">channel_name</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verbose</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;Reading Channel (via channel_master.read_channel): {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">channel_name</span><span class="p">)</span>
        <span class="n">channel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_channel</span><span class="p">(</span><span class="n">channel_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_caching_mode</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">channel_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_partial_delegation_results</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_partial_delegation_results</span><span class="p">[</span><span class="n">channel_name</span><span class="p">]</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verbose</span><span class="p">:</span>
                    <span class="k">print</span> <span class="s">&quot;Reading Channel: {} from previous results: {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">channel_name</span><span class="p">,</span><span class="n">result</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_channel</span><span class="p">(</span><span class="n">channel_name</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verbose</span><span class="p">:</span>
                    <span class="k">print</span> <span class="s">&quot;cache miss  {} read: {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">channel_name</span><span class="p">,</span><span class="n">result</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">channel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_self_delegation_channels</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_partial_delegation_results</span><span class="p">[</span><span class="n">channel_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>
                <span class="k">return</span> <span class="n">result</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_channel</span><span class="p">(</span><span class="n">channel_name</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verbose</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;  {} read: {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">channel_name</span><span class="p">,</span><span class="n">result</span><span class="p">)</span>
        <span class="c">#calling the observer is done here so its in the secondary thread, if threading</span>
        <span class="k">for</span> <span class="n">function</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_callbacks</span><span class="p">:</span>
            <span class="n">function</span><span class="p">({</span><span class="n">channel_name</span><span class="p">:</span> <span class="n">result</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="k">def</span> <span class="nf">read_channel_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">channel_list</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verbose</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;Reading channel list: &quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">channel_list</span><span class="p">:</span>
                <span class="k">print</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">{}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">channel_group</span><span class="o">.</span><span class="n">read_channel_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">channel_list</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">function</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_callbacks</span><span class="p">:</span>
            <span class="n">function</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">results</span>
<div class="viewcode-block" id="channel_master.write_channel"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_core.html#PyICe.lab_core.channel_master.write_channel">[docs]</a>    <span class="k">def</span> <span class="nf">write_channel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">channel_name</span><span class="p">,</span><span class="n">value</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Delegates channel write to the appropriate registered instrument.&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verbose</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;Writing Channel {}, to {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">channel_name</span><span class="p">,</span><span class="n">value</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">function</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_write_callbacks</span><span class="p">:</span>
            <span class="n">function</span><span class="p">({</span><span class="n">channel_name</span><span class="p">:</span> <span class="n">value</span><span class="p">})</span>
        <span class="n">data</span> <span class="o">=</span>  <span class="n">channel_group</span><span class="o">.</span><span class="n">write_channel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">channel_name</span><span class="p">,</span><span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span></div>
    <span class="k">def</span> <span class="nf">read_delegated_channel_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">channel_list</span><span class="p">):</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_caching_mode</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="n">channel_list</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">channel</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_partial_delegation_results</span><span class="p">:</span>
                    <span class="n">results</span><span class="p">[</span><span class="n">channel</span><span class="o">.</span><span class="n">get_name</span><span class="p">()]</span> <span class="o">=</span> <span class="n">channel</span><span class="o">.</span><span class="n">read_without_delegator</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_partial_delegation_results</span><span class="p">[</span><span class="n">channel</span><span class="o">.</span><span class="n">get_name</span><span class="p">()]</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="n">channel</span><span class="o">.</span><span class="n">get_name</span><span class="p">()]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">results</span><span class="p">[</span><span class="n">channel</span><span class="o">.</span><span class="n">get_name</span><span class="p">()]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_partial_delegation_results</span><span class="p">[</span><span class="n">channel</span><span class="o">.</span><span class="n">get_name</span><span class="p">()]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_caching_mode</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="n">channel_list</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">channel</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_partial_delegation_results</span><span class="p">:</span>
                    <span class="n">results</span><span class="p">[</span><span class="n">channel</span><span class="o">.</span><span class="n">get_name</span><span class="p">()]</span> <span class="o">=</span> <span class="n">channel</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_partial_delegation_results</span><span class="p">[</span><span class="n">channel</span><span class="o">.</span><span class="n">get_name</span><span class="p">()]</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="n">channel</span><span class="o">.</span><span class="n">get_name</span><span class="p">()]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">results</span><span class="p">[</span><span class="n">channel</span><span class="o">.</span><span class="n">get_name</span><span class="p">()]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_partial_delegation_results</span><span class="p">[</span><span class="n">channel</span><span class="o">.</span><span class="n">get_name</span><span class="p">()]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_caching_mode</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_caching_mode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_partial_delegation_results</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">results</span>
    <span class="k">def</span> <span class="nf">serve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">address</span><span class="o">=</span><span class="s">&#39;localhost&#39;</span><span class="p">,</span><span class="n">port</span><span class="o">=</span><span class="mi">5001</span><span class="p">,</span><span class="n">authkey</span><span class="o">=</span><span class="s">&#39;ltc_lab&#39;</span><span class="p">):</span>
        <span class="n">rcgs</span> <span class="o">=</span> <span class="n">remote_channel_group_server</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">address</span><span class="p">,</span><span class="n">port</span><span class="p">,</span><span class="n">authkey</span><span class="p">)</span>
        <span class="n">rcgs</span><span class="o">.</span><span class="n">serve_forever</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">attach</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">address</span><span class="o">=</span><span class="s">&#39;localhost&#39;</span><span class="p">,</span><span class="n">port</span><span class="o">=</span><span class="mi">5001</span><span class="p">,</span><span class="n">authkey</span><span class="o">=</span><span class="s">&#39;ltc_lab&#39;</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">rcgc</span> <span class="o">=</span> <span class="n">remote_channel_group_client</span><span class="p">(</span><span class="n">address</span><span class="p">,</span><span class="n">port</span><span class="p">,</span><span class="n">authkey</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">RemoteChannelGroupException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">print</span> <span class="n">e</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">rcgc</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">True</span>
    <span class="k">def</span> <span class="nf">background_gui</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">cfg_file</span><span class="o">=</span><span class="s">&#39;default.guicfg&#39;</span><span class="p">):</span>
        <span class="n">thread</span><span class="o">.</span><span class="n">start_new_thread</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gui_launcher_passive</span><span class="p">,</span> <span class="p">(</span><span class="n">cfg_file</span><span class="p">,)</span> <span class="p">)</span>
    <span class="k">def</span> <span class="nf">gui</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">cfg_file</span><span class="o">=</span><span class="s">&#39;default.guicfg&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_gui_launcher</span><span class="p">(</span><span class="n">cfg_file</span><span class="p">)</span>
<div class="viewcode-block" id="channel_master.add_read_callback"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_core.html#PyICe.lab_core.channel_master.add_read_callback">[docs]</a>    <span class="k">def</span> <span class="nf">add_read_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">read_callback</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Adds a read callback. This is a function that will be called any time a channel(s) is read. the callback function should accept one argument: the dictionary of results.</span>
<span class="sd">        If it is not important to group results by each batch read, consider adding a callback to an individual channel instead.&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_read_callbacks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">read_callback</span><span class="p">)</span></div>
    <span class="k">def</span> <span class="nf">remove_read_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">read_callback</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_read_callbacks</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">read_callback</span><span class="p">)</span>
<div class="viewcode-block" id="channel_master.add_write_callback"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_core.html#PyICe.lab_core.channel_master.add_write_callback">[docs]</a>    <span class="k">def</span> <span class="nf">add_write_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">write_callback</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Adds a write callback. This is a function that will be called any time a channel is written. the callback function should accept one argument: the dictionary of results.</span>
<span class="sd">        In this case, the dictionary will only contain a key,value pair for the single channel that was written. For more flexibility, considering adding a callback to an individual channel instead.&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_write_callbacks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">write_callback</span><span class="p">)</span></div>
    <span class="k">def</span> <span class="nf">remove_write_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">write_callback</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_write_callbacks</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">write_callback</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_gui_launcher_passive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">cfg_file</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">lab_gui</span> <span class="c">#this cannot be imported in the main thread</span>
        <span class="n">gui</span> <span class="o">=</span> <span class="n">lab_gui</span><span class="o">.</span><span class="n">ltc_lab_gui_app</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">passive</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">cfg_file</span><span class="o">=</span><span class="n">cfg_file</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_read_callback</span><span class="p">(</span><span class="n">gui</span><span class="o">.</span><span class="n">passive_data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_write_callback</span><span class="p">(</span><span class="n">gui</span><span class="o">.</span><span class="n">passive_data</span><span class="p">)</span>
        <span class="n">gui</span><span class="o">.</span><span class="n">exec_</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">_gui_launcher</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">cfg_file</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">lab_gui</span> <span class="c">#this cannot be imported in the main thread</span>
        <span class="n">gui</span> <span class="o">=</span> <span class="n">lab_gui</span><span class="o">.</span><span class="n">ltc_lab_gui_app</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">passive</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">cfg_file</span><span class="o">=</span><span class="n">cfg_file</span><span class="p">)</span>
        <span class="n">gui</span><span class="o">.</span><span class="n">exec_</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">get_dummy_clone</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">clone</span> <span class="o">=</span> <span class="n">channel_master</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">clone</span><span class="o">.</span><span class="n">add_channel_dummy</span><span class="p">(</span><span class="n">channel</span><span class="o">.</span><span class="n">get_name</span><span class="p">())</span>
            <span class="n">clone</span><span class="p">[</span><span class="n">channel</span><span class="o">.</span><span class="n">get_name</span><span class="p">()]</span><span class="o">.</span><span class="n">set_category</span><span class="p">(</span><span class="n">channel</span><span class="o">.</span><span class="n">get_category</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">channel</span><span class="o">.</span><span class="n">_read</span><span class="p">:</span>
                <span class="n">clone</span><span class="p">[</span><span class="n">channel</span><span class="o">.</span><span class="n">get_name</span><span class="p">()]</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">clone</span>
</div>
<span class="k">class</span> <span class="nc">master</span><span class="p">(</span><span class="n">channel_master</span><span class="p">,</span><span class="n">lab_interfaces</span><span class="o">.</span><span class="n">interface_factory</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">channel_master</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">name</span><span class="p">)</span>
        <span class="n">lab_interfaces</span><span class="o">.</span><span class="n">interface_factory</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">logger</span><span class="p">(</span><span class="n">master</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">channel_master_or_group</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">database</span><span class="o">=</span><span class="s">&quot;data_log.sqlite&quot;</span><span class="p">,</span> <span class="n">use_threads</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;channel_group is a lab_bench object containing all instruments of interest for logging.</span>
<span class="sd">        database is the filemane the sqlite database will be stored in&#39;&#39;&#39;</span>
        <span class="n">master</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;logger&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">channel_master_or_group</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">merge_in_channel_group</span><span class="p">(</span><span class="n">channel_master_or_group</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">channel</span><span class="o">.</span><span class="n">is_readable</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">remove_channel</span><span class="p">(</span><span class="n">channel</span><span class="p">)</span>
        <span class="c"># if the object given</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">channel_master_or_group</span><span class="p">,</span><span class="n">channel_master</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">master</span> <span class="o">=</span> <span class="n">channel_master_or_group</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">master</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_backend</span> <span class="o">=</span> <span class="n">logger_backend</span><span class="p">(</span><span class="n">database</span><span class="o">=</span><span class="n">database</span><span class="p">,</span> <span class="n">use_threads</span><span class="o">=</span><span class="n">use_threads</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_database</span> <span class="o">=</span> <span class="n">database</span> 
        <span class="n">atexit</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_table_name</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log_callbacks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_previously_logged_data</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>
    <span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">None</span>
    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;close sqlite database connection.&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_backend</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">add_channel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">channel_object</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_channel</span><span class="p">(</span><span class="n">channel_object</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">append_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">table_name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_table_name</span> <span class="o">=</span> <span class="n">table_name</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_all_channel_names</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_backend</span><span class="o">.</span><span class="n">append_table</span><span class="p">(</span><span class="n">table_name</span><span class="p">,</span><span class="n">columns</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">new_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">table_name</span><span class="p">,</span><span class="n">replace_table</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">warn</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;create a new table with columns matching channels known to logger instance</span>
<span class="sd">        if replace_table == &#39;copy&#39;, previously collected data to a new table with the date and time appended to the table name before overwriting</span>
<span class="sd">        if replace_table, allow previously collected data to be overwritten</span>
<span class="sd">        if not replace_table, raise an exception (or print to screen instead if warn) rather than overwrite existing data&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_table_name</span> <span class="o">=</span> <span class="n">table_name</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_all_channel_names</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_backend</span><span class="o">.</span><span class="n">new_table</span><span class="p">(</span><span class="n">table_name</span><span class="p">,</span><span class="n">columns</span><span class="p">,</span><span class="n">replace_table</span><span class="p">,</span><span class="n">warn</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">switch_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">table_name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_table_name</span> <span class="o">=</span> <span class="n">table_name</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_backend</span><span class="o">.</span><span class="n">switch_table</span><span class="p">(</span><span class="n">table_name</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">copy_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">old_table</span><span class="p">,</span> <span class="n">new_table</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_backend</span><span class="o">.</span><span class="n">copy_table</span><span class="p">(</span><span class="n">old_table</span><span class="p">,</span><span class="n">new_table</span><span class="p">)</span> 
    <span class="k">def</span> <span class="nf">get_database</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_database</span>
    <span class="k">def</span> <span class="nf">get_table_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table_name</span>
    <span class="k">def</span> <span class="nf">_fetch_channel_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">exclusions</span><span class="p">):</span>
        <span class="n">scan_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_flat_channel_group</span><span class="p">(</span><span class="s">&#39;scan_list&#39;</span><span class="p">)</span>
        <span class="c">#only log channels that are readable</span>
        <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="n">scan_list</span><span class="o">.</span><span class="n">get_all_channels_list</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">channel</span><span class="o">.</span><span class="n">is_readable</span><span class="p">():</span>
                <span class="n">scan_list</span><span class="o">.</span><span class="n">remove_channel</span><span class="p">(</span><span class="n">channel</span><span class="p">)</span>
        <span class="c">#remove the excluded items from the scan list</span>
        <span class="n">scan_list</span><span class="o">.</span><span class="n">remove_channel_list</span><span class="p">(</span><span class="n">exclusions</span><span class="p">)</span>
        <span class="n">channel_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">master</span><span class="o">.</span><span class="n">read_channel_list</span><span class="p">(</span><span class="n">scan_list</span><span class="p">)</span>
        <span class="c">#add additional database columns</span>
        <span class="n">channel_data</span><span class="p">[</span><span class="s">&#39;rowid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">channel_data</span><span class="p">[</span><span class="s">&#39;datetime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&#39;%Y-%m-</span><span class="si">%d</span><span class="s">T%H:%M:%S.</span><span class="si">%f</span><span class="s">Z&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">channel_data</span>
    <span class="k">def</span> <span class="nf">log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">exclusions</span><span class="o">=</span><span class="p">[]):</span>
        <span class="sd">&#39;&#39;&#39;measure all non-excluded channels. Channels may be excluded by name, channel_group(instrument), or directly.  Returns a dictionary of what it logged.&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_backend</span><span class="o">.</span><span class="n">check_exception</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fetch_channel_data</span><span class="p">(</span><span class="n">exclusions</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_backend</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_previously_logged_data</span> <span class="o">=</span> <span class="n">data</span>
        <span class="k">for</span> <span class="n">callback</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_log_callbacks</span><span class="p">:</span>
            <span class="n">callback</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span>
    <span class="k">def</span> <span class="nf">log_if_changed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">log_exclusions</span><span class="o">=</span><span class="p">[],</span> <span class="n">compare_exclusions</span><span class="o">=</span><span class="p">[]):</span>
        <span class="sd">&#39;&#39;&#39;like log(), but only stores data to database if data in at least on channel/column has changed.</span>
<span class="sd">        log_exclusions is a list of logger channels which will not be read nor stored in the database.</span>
<span class="sd">        compare_exclusions is a list of logger channels which will not be used to decide if data has changed but which will be read and stored in the databased if something else changed.</span>
<span class="sd">        rowid and datetime are automatically excluded from change comparison.</span>
<span class="sd">        returns channel data if logged, else None&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_backend</span><span class="o">.</span><span class="n">check_exception</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fetch_channel_data</span><span class="p">(</span><span class="n">log_exclusions</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_previously_logged_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">old_data</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_previously_logged_data</span><span class="p">)</span>
            <span class="n">new_data</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="k">del</span> <span class="n">old_data</span><span class="p">[</span><span class="s">&#39;rowid&#39;</span><span class="p">]</span>
            <span class="k">del</span> <span class="n">new_data</span><span class="p">[</span><span class="s">&#39;rowid&#39;</span><span class="p">]</span>
            <span class="k">del</span> <span class="n">old_data</span><span class="p">[</span><span class="s">&#39;datetime&#39;</span><span class="p">]</span>
            <span class="k">del</span> <span class="n">new_data</span><span class="p">[</span><span class="s">&#39;datetime&#39;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">compare_exclusions</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span>
                    <span class="k">del</span> <span class="n">old_data</span><span class="p">[</span><span class="n">item</span><span class="p">]</span>
                    <span class="k">del</span> <span class="n">new_data</span><span class="p">[</span><span class="n">item</span><span class="p">]</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span><span class="n">channel</span><span class="p">):</span>
                    <span class="k">del</span> <span class="n">old_data</span><span class="p">[</span><span class="n">item</span><span class="o">.</span><span class="n">get_name</span><span class="p">()]</span>
                    <span class="k">del</span> <span class="n">new_data</span><span class="p">[</span><span class="n">item</span><span class="o">.</span><span class="n">get_name</span><span class="p">()]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;Unknown compare exclusion type: {} {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">item</span><span class="p">),</span><span class="n">item</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_previously_logged_data</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">old_data</span> <span class="o">!=</span> <span class="n">new_data</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_backend</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_previously_logged_data</span> <span class="o">=</span> <span class="n">data</span>
            <span class="c">#skip callbacks if data unchanged?</span>
            <span class="k">for</span> <span class="n">callback</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_log_callbacks</span><span class="p">:</span>
                <span class="n">callback</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">data</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
    <span class="k">def</span> <span class="nf">log_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_dictionary</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;log previously collected data.</span>
<span class="sd">        data_dictionary should have channel name keys.</span>
<span class="sd">        set up logger and table using logger.add_data_channels()</span>
<span class="sd">        alternately, data_dictionary can be an iterable containing dictionaries, each representing a single row.&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_backend</span><span class="o">.</span><span class="n">check_exception</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">data_dictionary</span><span class="p">[</span><span class="s">&#39;rowid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">if</span> <span class="n">data_dictionary</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;datetime&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">data_dictionary</span><span class="p">[</span><span class="s">&#39;datetime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&#39;%Y-%m-</span><span class="si">%d</span><span class="s">T%H:%M:%S.</span><span class="si">%f</span><span class="s">Z&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_backend</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">data_dictionary</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_previously_logged_data</span> <span class="o">=</span> <span class="n">data_dictionary</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="c">#not a mapping type, assume iterable of mapping</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">data_dictionary</span><span class="p">:</span>
                <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="c">#try to prevent infinite recursion with malformed data</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log_data</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">add_data_channels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_dictionary</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;prepare logger channel group with fake channels matching data_dictionary keys.</span>
<span class="sd">        call before logger.new_table().</span>
<span class="sd">        use to log previously collected data in conjunction with logger.log_data()</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_all_channel_names</span><span class="p">())</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="k">def</span> <span class="nf">read_disable</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;Attempted to read fake channel designed to be used with logger.log_data()&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">data_dictionary</span><span class="p">:</span>
            <span class="n">fake_channel</span> <span class="o">=</span> <span class="n">channel</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">read_function</span><span class="o">=</span><span class="n">read_disable</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_channel</span><span class="p">(</span><span class="n">fake_channel</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">add_log_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">log_callback</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Adds a read callback. This is a function that will be called any time a channel(s) is read. the callback function should accept one argument: the dictionary of results.</span>
<span class="sd">        If it is not important to group results by each batch read, consider adding a callback to an individual channel instead.&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log_callbacks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">log_callback</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">remove_log_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">log_callback</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log_callbacks</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">log_callback</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">get_master</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">master</span>
    <span class="k">def</span> <span class="nf">flush</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;commit pending transactions and block until database thread queue is empty.&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_backend</span><span class="o">.</span><span class="n">sync_threads</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">set_journal_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">journal_mode</span><span class="o">=</span><span class="s">&#39;WAL&#39;</span><span class="p">,</span> <span class="n">synchronous</span><span class="o">=</span><span class="s">&#39;NORMAL&#39;</span><span class="p">,</span> <span class="n">timeout_ms</span><span class="o">=</span><span class="mi">10000</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;configure database connection for more reliable concurrent read/write operations with high data throughput or large data sets.</span>
<span class="sd">        Three options are individually configurable:</span>
<span class="sd">        </span>
<span class="sd">        journal_mode changes the default rollback journal to other methods which read-lock the database less often and for less time.</span>
<span class="sd">        WAL (write-ahead log) is usually the best choice. Reading and writing are independet and will never block each other.</span>
<span class="sd">        https://www.sqlite.org/pragma.html#pragma_journal_mode</span>
<span class="sd">        https://www.sqlite.org/wal.html</span>
<span class="sd">        </span>
<span class="sd">        synchronouns changes how SQLite waits to confirm that data has been safely written to the disk platter surface. </span>
<span class="sd">        Relaxing this from FULL to NORMAL to OFF will increase commit speed with an increasing risk of data corruption if power is lost or the compute crashes at an inopportune time.</span>
<span class="sd">        Use with caution. Usually WAL alone will correct most access problems.</span>
<span class="sd">        https://www.sqlite.org/pragma.html#pragma_synchronous</span>
<span class="sd">        </span>
<span class="sd">        timeout_ms changes the amount of time SQLite will wait for access to a locked database before giving up and failing.</span>
<span class="sd">        Timeouts are much less likely in WAL mode compated to normal rollback journal mode.</span>
<span class="sd">        https://www.sqlite.org/pragma.html#pragma_busy_timeout</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_backend</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;PRAGMA locking_mode = NORMAL;&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_backend</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;PRAGMA busy_timeout = {};&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">timeout_ms</span><span class="p">))</span>
        <span class="n">journal_mode</span> <span class="o">=</span> <span class="n">journal_mode</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">journal_mode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&quot;DELETE&quot;</span><span class="p">,</span><span class="s">&quot;TRUNCATE&quot;</span><span class="p">,</span><span class="s">&quot;PERSIST&quot;</span><span class="p">,</span><span class="s">&quot;MEMORY&quot;</span><span class="p">,</span><span class="s">&quot;WAL&quot;</span><span class="p">,</span><span class="s">&quot;OFF&quot;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;Valid arguments to journal_mode are &quot;DELETE&quot;, &quot;TRUNCATE&quot;, &quot;PERSIST&quot;, &quot;MEMORY&quot;, &quot;WAL&quot;, and &quot;OFF&quot;. See https://www.sqlite.org/pragma.html#pragma_journal_mode&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_backend</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;PRAGMA journal_mode = {};&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">journal_mode</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">journal_mode</span> <span class="o">==</span> <span class="s">&quot;WAL&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_backend</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;PRAGMA wal_autocheckpoint=100;&quot;</span><span class="p">)</span>
        <span class="n">synchronous</span> <span class="o">=</span> <span class="n">synchronous</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">synchronous</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&quot;OFF&quot;</span><span class="p">,</span><span class="s">&quot;NORMAL&quot;</span><span class="p">,</span><span class="s">&quot;FULL&quot;</span><span class="p">,</span><span class="s">&quot;EXTRA&quot;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;Valid arguments to synchronous are &quot;OFF&quot;, &quot;NORMAL&quot;, &quot;FULL&quot;, and &quot;EXTRA&quot;. See https://www.sqlite.org/pragma.html#pragma_synchronous&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_backend</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;PRAGMA synchronous = {};&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">synchronous</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">optimize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Defragment database file, reducing file size and speeding future queries.</span>
<span class="sd">        Also re-runs query plan optimizer to spped future queries.</span>
<span class="sd">        WARNING: May take a lot time to complete when operating on a large database.</span>
<span class="sd">        WARNING: May re-order rowid&#39;s</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_backend</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;VACUUM;&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_backend</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;ANALYZE;&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">logger_backend</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">database</span><span class="o">=</span><span class="s">&quot;data_log.sqlite&quot;</span><span class="p">,</span> <span class="n">use_threads</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table_name</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_use_thread</span> <span class="o">=</span> <span class="n">use_threads</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_max_lock_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_thread_exception</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_run</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stopped</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_thread</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">storage_queue</span> <span class="o">=</span> <span class="n">Queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_thread</span> <span class="o">=</span> <span class="n">thread</span><span class="o">.</span><span class="n">start_new_thread</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db_thread</span><span class="p">,</span> <span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">storage_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connect_db</span><span class="p">(</span><span class="n">database</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_connect_db</span><span class="p">(</span><span class="n">database</span><span class="p">)</span>
        <span class="n">atexit</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c">#print &quot;Closing database connection.&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;PRAGMA wal_checkpoint(RESTART);&quot;</span><span class="p">)</span> <span class="c">#no effect if DB not in write-ahead log journal mode</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;PRAGMA journal_mode=DELETE;&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">ProgrammingError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c">#can&#39;t execute if connection previously closed</span>
            <span class="k">print</span> <span class="n">e</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;Unhandled exception in _close!&quot;</span>
            <span class="k">print</span> <span class="n">e</span>
    <span class="k">def</span> <span class="nf">sync_threads</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_thread</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">storage_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_commit</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">storage_queue</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_exception</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_commit</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">check_exception</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_exception</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">_check_exception</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_thread_exception</span><span class="p">:</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">_thread_exception</span>
    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sql_query</span><span class="p">,</span> <span class="o">*</span><span class="n">params</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;not currently capable of returning the query result through the thread queue</span>
<span class="sd">        useful for setting up the database with PRAGMA commands.&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_thread</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">storage_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execute</span><span class="p">(</span><span class="n">sql_query</span><span class="p">,</span> <span class="o">*</span><span class="n">params</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_execute</span><span class="p">(</span><span class="n">sql_query</span><span class="p">,</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sql_query</span><span class="p">,</span> <span class="o">*</span><span class="n">params</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql_query</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_connect_db</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">database</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">database</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cur</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">_db_thread</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lock_time</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock_time</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">lock_time</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_lock_time</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_commit</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lock_time</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="c">#print &#39;max lock timed out&#39;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">function</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">storage_queue</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">Queue</span><span class="o">.</span><span class="n">Empty</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock_time</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span> <span class="c">#not self._commit to avoid infinite retry</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;PRAGMA wal_checkpoint(PASSIVE);&quot;</span><span class="p">)</span> <span class="c">#no effect if DB not in write-ahead log journal mode</span>
                    <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">OperationalError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="k">print</span> <span class="s">&quot;Opportunistic commit failed. Not retrying.&quot;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">lock_time</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="n">function</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">storage_queue</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock_time</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">lock_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
                    <span class="n">function</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">print</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                    <span class="k">raise</span> <span class="n">e</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_thread_exception</span> <span class="o">=</span> <span class="n">e</span>
                <span class="k">finally</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">storage_queue</span><span class="o">.</span><span class="n">task_done</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stopped</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">def</span> <span class="nf">store</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">data</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_thread</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">storage_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_new_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">table_name</span><span class="p">,</span><span class="n">columns</span><span class="p">,</span><span class="n">replace_table</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">warn</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;create new table in the sqlite database with a column for each channel.  </span>
<span class="sd">            replace any existing table with the same name (delete data!).&#39;&#39;&#39;</span>
        <span class="n">table_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">table_name</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="p">,</span><span class="s">&quot;_&quot;</span><span class="p">)</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_create_table</span><span class="p">(</span><span class="n">table_name</span><span class="p">,</span><span class="n">columns</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_commit</span><span class="p">()</span>   
        <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">OperationalError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">replace_table</span> <span class="o">==</span> <span class="s">&#39;copy&#39;</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_copy_table</span><span class="p">(</span><span class="n">table_name</span><span class="p">,</span> <span class="s">&#39;{}_{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">table_name</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&#39;%Y_%m_</span><span class="si">%d</span><span class="s">T%H_%M_%SZ&#39;</span><span class="p">)))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;DROP TABLE {};&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">table_name</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_commit</span><span class="p">()</span>
                <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">OperationalError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">print</span> <span class="n">e</span>
                    <span class="k">print</span> <span class="s">&quot;Table not copied (may not exist): {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">table_name</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_create_table</span><span class="p">(</span><span class="n">table_name</span><span class="p">,</span><span class="n">columns</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_commit</span><span class="p">()</span>   
            <span class="k">elif</span> <span class="n">replace_table</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;DROP TABLE {};&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">table_name</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_commit</span><span class="p">()</span>
                <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">OperationalError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">print</span> <span class="n">e</span>
                    <span class="k">print</span> <span class="s">&quot;Table not dropped (may not exist): {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">table_name</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_create_table</span><span class="p">(</span><span class="n">table_name</span><span class="p">,</span><span class="n">columns</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_commit</span><span class="p">()</span>   
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">warn</span><span class="p">:</span>
                    <span class="k">print</span> <span class="s">&#39;Table name {} creation failed.  Table probably exists. Rename table, change table name argument, or call with replace_table argument=True&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">table_name</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">e</span>
    <span class="k">def</span> <span class="nf">_create_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">table_name</span><span class="p">,</span><span class="n">columns</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;create the actual sql table and commit to database.  Called by new_sweep_replace() (and new_sweep()?)&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="n">txt</span> <span class="o">=</span> <span class="s">&quot;CREATE TABLE &quot;</span> <span class="o">+</span> <span class="n">table_name</span> <span class="o">+</span> <span class="s">&quot; ( rowid INTEGER PRIMARY KEY, datetime DATETIME, &quot;</span>
        <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">txt</span> <span class="o">+=</span> <span class="s">&quot;{} NUMERIC, &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">column</span><span class="p">)</span>
        <span class="n">txt</span> <span class="o">=</span> <span class="n">txt</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">txt</span> <span class="o">+=</span> <span class="s">&quot; );&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">txt</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_commit</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table_name</span> <span class="o">=</span> <span class="n">table_name</span>
    <span class="k">def</span> <span class="nf">_store</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">data</span><span class="p">,</span><span class="n">num</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">table_name</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;Need to create a table before logging&quot;</span><span class="p">)</span>
        <span class="sd">&#39;&#39;&#39;match data dictionary keys to table column names and commit new row to table.&#39;&#39;&#39;</span>
        
        <span class="n">q</span> <span class="o">=</span> <span class="p">(</span><span class="s">&quot;?,&quot;</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">def</span> <span class="nf">db_clean</span><span class="p">(</span><span class="n">column_data</span><span class="p">):</span>
            <span class="sd">&#39;&#39;&#39;help database to store lists, dictionaries and any other future datatype that doesn&#39;t fit natively&#39;&#39;&#39;</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">column_data</span><span class="p">,</span><span class="nb">list</span><span class="p">):</span>
                <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">column_data</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">column_data</span><span class="p">,</span><span class="nb">dict</span><span class="p">):</span>
                <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">column_data</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">column_data</span>
        <span class="n">values</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="n">db_clean</span><span class="p">(</span><span class="n">column</span><span class="p">)</span> <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="s">&quot;INSERT INTO {} {} VALUES ({});&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">table_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">())),</span> <span class="n">q</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span><span class="n">values</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">OperationalError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">num</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">print</span> <span class="n">e</span>
                <span class="k">print</span> <span class="s">&quot;Try {} failed. Trying again...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">num</span><span class="o">=</span><span class="n">num</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="c">#keep trying forever</span>
    <span class="k">def</span> <span class="nf">copy_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">old_table</span><span class="p">,</span><span class="n">new_table</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_name</span><span class="p">(</span><span class="n">new_table</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_exception</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_thread</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">storage_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_copy_table</span><span class="p">(</span><span class="n">old_table</span><span class="p">,</span><span class="n">new_table</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_copy_table</span><span class="p">(</span><span class="n">old_table</span><span class="p">,</span><span class="n">new_table</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sync_threads</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">_copy_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">old_table</span><span class="p">,</span> <span class="n">new_table</span><span class="p">):</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&#39;CREATE TABLE {} AS SELECT * FROM {};&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">new_table</span><span class="p">,</span> <span class="n">old_table</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">_commit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">OperationalError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">print</span> <span class="n">e</span>
            <span class="k">print</span> <span class="s">&quot;Trying commit again...&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_commit</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">switch_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">table_name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_name</span><span class="p">(</span><span class="n">table_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_exception</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_thread</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">storage_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_switch_table</span><span class="p">(</span><span class="n">table_name</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_switch_table</span><span class="p">(</span><span class="n">table_name</span><span class="p">)</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">sync_threads</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">_switch_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">table_name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table_name</span> <span class="o">=</span> <span class="n">table_name</span>
    <span class="k">def</span> <span class="nf">append_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">table_name</span><span class="p">,</span><span class="n">columns</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_name</span><span class="p">(</span><span class="n">table_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_exception</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_thread</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">storage_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_append_table</span><span class="p">(</span><span class="n">table_name</span><span class="p">,</span><span class="n">columns</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_append_table</span><span class="p">(</span><span class="n">table_name</span><span class="p">,</span><span class="n">columns</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sync_threads</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">_append_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">table_name</span><span class="p">,</span><span class="n">columns</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_new_table</span><span class="p">(</span><span class="n">table_name</span><span class="p">,</span><span class="n">columns</span><span class="p">,</span><span class="n">replace_table</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">warn</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_commit</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">OperationalError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_switch_table</span><span class="p">(</span><span class="n">table_name</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;ALTER TABLE {} ADD {} NUMERIC;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">table_name</span><span class="p">,</span> <span class="n">column</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_commit</span><span class="p">()</span>
            <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">OperationalError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">print</span> <span class="s">&quot;Added column: {} to table: {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">column</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">table_name</span><span class="p">)</span>   
    <span class="k">def</span> <span class="nf">_check_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">name</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">&quot;[_A-Za-z][_a-zA-Z0-9]*$&quot;</span><span class="p">,</span><span class="n">name</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;Bad Table Name &quot;{}&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">new_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">table_name</span><span class="p">,</span><span class="n">columns</span><span class="p">,</span><span class="n">replace_table</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">warn</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_name</span><span class="p">(</span><span class="n">table_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_exception</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_thread</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">storage_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_new_table</span><span class="p">(</span><span class="n">table_name</span><span class="p">,</span><span class="n">columns</span><span class="p">,</span><span class="n">replace_table</span><span class="p">,</span><span class="n">warn</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_new_table</span><span class="p">(</span><span class="n">table_name</span><span class="p">,</span><span class="n">columns</span><span class="p">,</span><span class="n">replace_table</span><span class="p">,</span><span class="n">warn</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sync_threads</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_thread</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">storage_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_stop</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_stop</span><span class="p">()</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stopped</span><span class="p">:</span> <span class="c">#change to self.storage_queue.join()?</span>
            <span class="k">pass</span>
    <span class="k">def</span> <span class="nf">_stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_commit</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">ProgrammingError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c">#can&#39;t commit if connection previously closed</span>
            <span class="k">print</span> <span class="n">e</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;Unhandled exception in _stop!&quot;</span>
            <span class="k">print</span> <span class="n">e</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_close</span><span class="p">()</span>       
            <span class="bp">self</span><span class="o">.</span><span class="n">_run</span> <span class="o">=</span> <span class="bp">False</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">print_it</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="k">print</span> <span class="n">x</span>
    <span class="c">#test of threaded delegation</span>
    <span class="n">lb</span> <span class="o">=</span> <span class="n">master</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">lb</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">address</span><span class="o">=</span><span class="s">&#39;localhost&#39;</span><span class="p">):</span>
        <span class="k">print</span> <span class="s">&quot;creating fake channels&quot;</span>
        <span class="c"># make 4 communication nodes, a-d, a and b are root level interfaces, b is not thread safe, c and d are downstream of b</span>
        <span class="n">ia</span> <span class="o">=</span> <span class="n">lb</span><span class="o">.</span><span class="n">get_dummy_interface</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;a&#39;</span><span class="p">)</span>
        <span class="n">ia</span><span class="o">.</span><span class="n">set_com_node_thread_safe</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">ib</span> <span class="o">=</span> <span class="n">lb</span><span class="o">.</span><span class="n">get_dummy_interface</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;b&#39;</span><span class="p">)</span>
        <span class="n">ib</span><span class="o">.</span><span class="n">set_com_node_thread_safe</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">ic</span> <span class="o">=</span> <span class="n">lb</span><span class="o">.</span><span class="n">get_dummy_interface</span><span class="p">(</span><span class="n">parent</span><span class="o">=</span><span class="n">ib</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;c&#39;</span><span class="p">)</span>
        <span class="nb">id</span> <span class="o">=</span> <span class="n">lb</span><span class="o">.</span><span class="n">get_dummy_interface</span><span class="p">(</span><span class="n">parent</span><span class="o">=</span><span class="n">ib</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;d&#39;</span><span class="p">)</span>
        
        <span class="c">#create some dummy channels using these interfaces</span>
        <span class="n">ch1_ia</span> <span class="o">=</span> <span class="n">channel</span><span class="p">(</span><span class="s">&#39;ch1_ia&#39;</span><span class="p">,</span> <span class="n">read_function</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>  <span class="p">)</span>
        <span class="n">ch1_ia</span><span class="o">.</span><span class="n">add_interface</span><span class="p">(</span><span class="n">ia</span><span class="p">)</span>
        <span class="n">ch2_ic</span> <span class="o">=</span> <span class="n">channel</span><span class="p">(</span><span class="s">&#39;ch2_ic&#39;</span><span class="p">,</span> <span class="n">read_function</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">)</span>
        <span class="n">ch2_ic</span><span class="o">.</span><span class="n">add_interface</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span>
        <span class="n">ch3_id</span> <span class="o">=</span> <span class="n">channel</span><span class="p">(</span><span class="s">&#39;ch3_id&#39;</span><span class="p">,</span> <span class="n">read_function</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">)</span>
        <span class="n">ch3_id</span><span class="o">.</span><span class="n">add_interface</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
        <span class="n">ch4_id</span> <span class="o">=</span> <span class="n">channel</span><span class="p">(</span><span class="s">&#39;ch4_id&#39;</span><span class="p">,</span> <span class="n">read_function</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">)</span>
        <span class="c">#ch4_id.set_delegator(ch3_id)</span>
        <span class="n">ch4_id</span><span class="o">.</span><span class="n">add_interface</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>

        <span class="n">lb</span><span class="o">.</span><span class="n">_add_channel</span><span class="p">(</span><span class="n">ch1_ia</span><span class="p">)</span>
        <span class="n">lb</span><span class="o">.</span><span class="n">_add_channel</span><span class="p">(</span><span class="n">ch2_ic</span><span class="p">)</span>
        <span class="n">lb</span><span class="o">.</span><span class="n">_add_channel</span><span class="p">(</span><span class="n">ch3_id</span><span class="p">)</span>
        <span class="n">lb</span><span class="o">.</span><span class="n">_add_channel</span><span class="p">(</span><span class="n">ch4_id</span><span class="p">)</span>
        <span class="n">lb</span><span class="o">.</span><span class="n">add_channel_dummy</span><span class="p">(</span><span class="s">&#39;dummy&#39;</span><span class="p">)</span>
        <span class="n">lb</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;dummy&#39;</span><span class="p">,</span><span class="s">&quot;dummydata&quot;</span><span class="p">)</span>
        <span class="n">lb</span><span class="o">.</span><span class="n">add_channel_virtual</span><span class="p">(</span><span class="s">&#39;virtual_print&#39;</span><span class="p">,</span><span class="n">write_function</span><span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">print_it</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="k">print</span> <span class="s">&quot;new_logger&quot;</span>
        <span class="n">lb</span><span class="o">.</span><span class="n">gui</span><span class="p">()</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="n">logger</span><span class="p">(</span><span class="n">lb</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">new_table</span><span class="p">(</span><span class="s">&quot;test_table&quot;</span><span class="p">,</span><span class="n">replace_table</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">set_journal_mode</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">()</span>
        <span class="c">#lb.background_gui()</span>
        <span class="c">#lb.serve(address=&#39;localhost&#39;)</span>
        <span class="k">print</span> <span class="s">&quot;done&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&quot;did not create any channels&quot;</span>
        <span class="n">tstart</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span>  <span class="n">lb</span><span class="o">.</span><span class="n">read_all_channels</span><span class="p">()</span>
        <span class="k">print</span> <span class="s">&quot;read took {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">tstart</span><span class="p">)</span>
        <span class="k">print</span> <span class="n">data</span>
        
        <span class="n">lgr</span> <span class="o">=</span> <span class="n">logger</span><span class="p">(</span><span class="n">lb</span><span class="p">)</span>
        <span class="n">lgr</span><span class="o">.</span><span class="n">new_table</span><span class="p">(</span><span class="s">&#39;test&#39;</span><span class="p">,</span><span class="n">replace_table</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">lgr</span><span class="o">.</span><span class="n">log</span><span class="p">()</span>
        <span class="n">lgr</span><span class="o">.</span><span class="n">log</span><span class="p">()</span>
        
        <span class="c">#lgr.gui()</span>
        
        <span class="c">#lb.gui()</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../PyICe.html">
              <img class="logo" src="../../_static/tssop.png" alt="Logo"/>
            </a></p>
<h3><a href="../../PyICe.html">Table Of Contents</a></h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../_autosummary/PyICe.lab_instruments.html">PyICe.lab_instruments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../_autosummary/PyICe.lab_core.html">PyICe.lab_core</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../_autosummary/PyICe.lab_utils.html">PyICe.lab_utils</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../_autosummary/PyICe.LTC_plot.html">PyICe.LTC_plot</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../_autosummary/PyICe.lab_gui.html">PyICe.lab_gui</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../_autosummary/PyICe.lab_interfaces.html">PyICe.lab_interfaces</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../_autosummary/PyICe.twi_instrument.html">PyICe.twi_instrument</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../_autosummary/PyICe.twoWireInterface.html">PyICe.twoWireInterface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../_autosummary/PyICe.spi_instrument.html">PyICe.spi_instrument</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../_autosummary/PyICe.spi_interface.html">PyICe.spi_interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../_autosummary/PyICe.visa_wrappers.html">PyICe.visa_wrappers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../_autosummary/PyICe.xml_registers.html">PyICe.xml_registers</a></li>
</ul>
<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../PyICe.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2017, Linear Technology Corporation.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.3.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.6</a>
      
    </div>

    

    
  </body>
</html>