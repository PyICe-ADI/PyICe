<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>PyICe.lab_utils &mdash; PyICe 9000 documentation</title>
    
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '9000',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="shortcut icon" href="../../_static/tssop.ico"/>
    <link rel="top" title="PyICe 9000 documentation" href="../../PyICe.html" />
    <link rel="up" title="Module code" href="../index.html" />
   
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9">

  </head>
  <body role="document">  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for PyICe.lab_utils</h1><div class="highlight"><pre>
<span class="c">#!/usr/bin/env python</span>
<span class="c"># -*- coding: utf-8 -*-</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">Miscellaneous Utilities</span>
<span class="sd">=======================</span>

<span class="sd">Includes:</span>

<span class="sd">- database access toools</span>
<span class="sd">- servo delay loop</span>
<span class="sd">- string sanitization</span>
<span class="sd">- filters and other numeric transforms</span>
<span class="sd">- floating point number utilites</span>
<span class="sd">- email/SMS notification</span>
<span class="sd"> </span>
<span class="sd"> &#39;&#39;&#39;</span>

<span class="kn">import</span> <span class="nn">smtplib</span>
<span class="kn">from</span> <span class="nn">email.mime.text</span> <span class="kn">import</span> <span class="n">MIMEText</span> <span class="c">#send email/sms message from script</span>
<span class="kn">from</span> <span class="nn">email.mime.multipart</span> <span class="kn">import</span> <span class="n">MIMEMultipart</span>
<span class="kn">from</span> <span class="nn">email.mime.application</span> <span class="kn">import</span> <span class="n">MIMEApplication</span>
<span class="kn">import</span> <span class="nn">time</span><span class="o">,</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">sqlite3</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">urllib</span>
<span class="kn">import</span> <span class="nn">operator</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">atexit</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">struct</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">numbers</span>
<span class="kn">import</span> <span class="nn">csv</span>
<span class="kn">import</span> <span class="nn">Queue</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">numpy</span><span class="o">,</span> <span class="nn">scipy</span><span class="o">,</span> <span class="nn">scipy.signal</span>
<span class="k">except</span> <span class="ne">ImportError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="k">print</span> <span class="s">&quot;Warning: NumPy,SciPy import failed.&quot;</span>
    <span class="k">print</span> <span class="n">e</span>

<div class="viewcode-block" id="delay_loop"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_utils.html#PyICe.lab_instruments.delay_loop">[docs]</a><span class="k">class</span> <span class="nc">delay_loop</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;make constant loop delay independent of loop processing time by measuring time at beginning</span>
<span class="sd">        and end of loop and adding extra delay as necessary&#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">begin</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">no_drift</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Set strict to True to raise an Exception if loop time is longer than requested delay.</span>
<span class="sd">        Timer will automatically begin when the object is instantiated if begin=True.</span>
<span class="sd">          To start timer only when ready, set begin=False and call begin() method to start timer.</span>
<span class="sd">        If no_drift=True, delay loop will manage loop time over-runs by debiting extra time from next cycle.</span>
<span class="sd">          This insures long-term time stability at the expense of increased jitter.</span>
<span class="sd">          Windows task switching can add multi-mS uncertainty to each delay() call, which can accumulate if not accounted for.</span>
<span class="sd">          Set no_drift=False to ignore time over-runs when computing next delay time.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">strict</span> <span class="o">=</span> <span class="n">strict</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">no_drift</span> <span class="o">=</span> <span class="n">no_drift</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">begin_time</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delay_time</span> <span class="o">=</span> <span class="bp">None</span> <span class="c">#last loop time for margin diagnostics.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loop_time</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="n">begin</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">seconds</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="n">seconds</span><span class="p">)</span>
<div class="viewcode-block" id="delay_loop.get_count"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_utils.html#PyICe.lab_instruments.delay_loop.get_count">[docs]</a>    <span class="k">def</span> <span class="nf">get_count</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;returns total number of times delay() method called&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">count</span></div>
<div class="viewcode-block" id="delay_loop.get_total_time"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_utils.html#PyICe.lab_instruments.delay_loop.get_total_time">[docs]</a>    <span class="k">def</span> <span class="nf">get_total_time</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;returns total number of seconds since first delay&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">start_time</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span></div>
<div class="viewcode-block" id="delay_loop.begin"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_utils.html#PyICe.lab_instruments.delay_loop.begin">[docs]</a>    <span class="k">def</span> <span class="nf">begin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;make note of begin time for loop measurement. Use offset to adjust the begin time in case of overrun on last cycle.&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">begin_time</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">begin_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span> <span class="o">=</span> <span class="n">offset</span><span class="p">)</span></div>
<div class="viewcode-block" id="delay_loop.delay"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_utils.html#PyICe.lab_instruments.delay_loop.delay">[docs]</a>    <span class="k">def</span> <span class="nf">delay</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seconds</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;delay extra time to make loop time constant</span>
<span class="sd">            returns actual delay time achieved&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">begin_time</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;Call begin() method before delay().&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">elapsed_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">begin_time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delay_time</span> <span class="o">=</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span> <span class="o">=</span> <span class="n">seconds</span><span class="p">)</span> <span class="o">-</span> <span class="n">elapsed_time</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delay_time</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">strict</span> <span class="o">==</span> <span class="bp">True</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;Loop processing longer than requested delay by {:3.3f} seconds {} at {}.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">delay_time</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">print</span> <span class="s">&#39;Warning! Loop processing longer than requested delay by {:3.3f} seconds at {}.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">delay_time</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delay_time</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loop_time</span> <span class="o">=</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">begin_time</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_drift</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">begin</span><span class="p">(</span><span class="n">offset</span> <span class="o">=</span> <span class="n">seconds</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">loop_time</span><span class="p">)</span> <span class="c"># restart timer for next loop cycle, use offset to correct for over run.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">begin</span><span class="p">(</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="c"># restart timer for next loop cycle, ignore over run.</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">delay_time</span></div>
<div class="viewcode-block" id="delay_loop.time_remaining"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_utils.html#PyICe.lab_instruments.delay_loop.time_remaining">[docs]</a>    <span class="k">def</span> <span class="nf">time_remaining</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">loop_time</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Use this in a while loop to perform another function for duration loop_time. Test the result for 0 or less.&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">begin_time</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;Call begin() method before time_remaining().&#39;</span><span class="p">)</span>
        <span class="n">remaining_time</span> <span class="o">=</span> <span class="n">loop_time</span> <span class="o">-</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">begin_time</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">remaining_time</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">begin</span><span class="p">(</span><span class="n">offset</span> <span class="o">=</span> <span class="n">remaining_time</span><span class="p">)</span> <span class="c"># restart timer for next loop cycle, use offset to correct for over run.</span>
        <span class="k">return</span> <span class="n">remaining_time</span></div>
<div class="viewcode-block" id="delay_loop.delay_margin"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_utils.html#PyICe.lab_instruments.delay_loop.delay_margin">[docs]</a>    <span class="k">def</span> <span class="nf">delay_margin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Return extra time remaining (ie sleep time) before last call to delay().&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">delay_time</span></div>
<div class="viewcode-block" id="delay_loop.achieved_loop_time"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_utils.html#PyICe.lab_instruments.delay_loop.achieved_loop_time">[docs]</a>    <span class="k">def</span> <span class="nf">achieved_loop_time</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Return previous actual achieved loop time (including any overrun).&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">loop_time</span>
</div></div>
<div class="viewcode-block" id="threaded_writer"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_utils.html#PyICe.lab_instruments.threaded_writer">[docs]</a><span class="k">class</span> <span class="nc">threaded_writer</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;helper to perform some task in parallel with test script at fixed rate&#39;&#39;&#39;</span>
<div class="viewcode-block" id="threaded_writer.stop_thread"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_utils.html#PyICe.lab_instruments.threaded_writer.stop_thread">[docs]</a>    <span class="k">class</span> <span class="nc">stop_thread</span><span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Thread extended to have stop() method. Threads cannot be restarted after stopping. Make a new one to restart.&#39;&#39;&#39;</span>
        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stop_event</span><span class="p">,</span> <span class="n">stopped_event</span><span class="p">,</span> <span class="n">queue</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(),</span> <span class="n">kwargs</span><span class="o">=</span><span class="p">{}):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stop_event</span> <span class="o">=</span> <span class="n">stop_event</span> <span class="c">#command to stop thread</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stopped_event</span> <span class="o">=</span> <span class="n">stopped_event</span> <span class="c">#notification that thread has stopped itself.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">queue</span> <span class="o">=</span> <span class="n">queue</span>
            <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="n">group</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">target</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="n">kwargs</span><span class="p">)</span>
<div class="viewcode-block" id="threaded_writer.stop_thread.stop"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_utils.html#PyICe.lab_instruments.threaded_writer.stop_thread.stop">[docs]</a>        <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="sd">&#39;&#39;&#39;stop thread. thread cannot be restarted.&#39;&#39;&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stop_event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span></div>
        <span class="k">def</span> <span class="nf">set_time_interval</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">time_interval</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="s">&quot;time_interval&quot;</span><span class="p">,</span> <span class="n">time_interval</span><span class="p">))</span></div>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_threads</span> <span class="o">=</span> <span class="p">[]</span> <span class="c">#check stopped_event whenever inspecting elements of this list to find out which threads have already stopped.</span>
    <span class="k">def</span> <span class="nf">_check_threads</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;remove terminated threads from internal list&#39;&#39;&#39;</span>
        <span class="k">for</span> <span class="n">thread</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_threads</span><span class="p">[:]:</span>
            <span class="k">if</span> <span class="n">thread</span><span class="o">.</span><span class="n">stopped_event</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_threads</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">thread</span><span class="p">)</span>
<div class="viewcode-block" id="threaded_writer.stop_all"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_utils.html#PyICe.lab_instruments.threaded_writer.stop_all">[docs]</a>    <span class="k">def</span> <span class="nf">stop_all</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;stop all threads. threads cannot be restarted.&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_threads</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">thread</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_threads</span><span class="p">[:]:</span>
            <span class="n">thread</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_threads</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">thread</span><span class="p">)</span></div>
<div class="viewcode-block" id="threaded_writer.connect_channel"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_utils.html#PyICe.lab_instruments.threaded_writer.connect_channel">[docs]</a>    <span class="k">def</span> <span class="nf">connect_channel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">channel_name</span><span class="p">,</span> <span class="n">time_interval</span><span class="p">,</span> <span class="n">sequence</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">address</span><span class="o">=</span><span class="s">&#39;localhost&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">5001</span><span class="p">,</span> <span class="n">authkey</span><span class="o">=</span><span class="s">&#39;ltc_lab&#39;</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Write each element of sequence in turn to channel_name, waiting time_interval between writes.</span>
<span class="sd">        If sequence is None, Periodically read and re-write channel as keepalive.</span>
<span class="sd">        Thread safety provided by remote channel server infrastructure.</span>
<span class="sd">        First thread must call master.serve() and test script should call master.attach().</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="kn">from</span> <span class="nn">PyICe</span> <span class="kn">import</span> <span class="n">lab_core</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">lab_core</span><span class="o">.</span><span class="n">master</span><span class="p">()</span>
        <span class="n">m</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">authkey</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sequence</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_function</span><span class="p">(</span><span class="k">lambda</span> <span class="n">channel_name</span><span class="o">=</span><span class="n">channel_name</span><span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">channel_name</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">channel_name</span><span class="p">)),</span> <span class="n">time_interval</span><span class="p">,</span> <span class="n">start</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">class</span> <span class="nc">sequencer</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
                <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generator</span><span class="p">(</span><span class="n">sequence</span><span class="p">)</span>
                <span class="k">def</span> <span class="nf">generator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sequence</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">sequence</span><span class="p">:</span>
                        <span class="k">yield</span> <span class="n">i</span>
                <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                    <span class="n">m</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">channel_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span><span class="o">.</span><span class="n">next</span><span class="p">())</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_function</span><span class="p">(</span><span class="n">sequencer</span><span class="p">(),</span> <span class="n">time_interval</span><span class="p">,</span> <span class="n">start</span><span class="p">)</span></div>
<div class="viewcode-block" id="threaded_writer.add_function"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_utils.html#PyICe.lab_instruments.threaded_writer.add_function">[docs]</a>    <span class="k">def</span> <span class="nf">add_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">function</span><span class="p">,</span> <span class="n">time_interval</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Periodically execute function.</span>
<span class="sd">        No thread safety. Use caution with shared interfaces or use separate remote channel clients with each function. See example above.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">stop_event</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>
        <span class="n">stopped_event</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>
        <span class="n">queue</span> <span class="o">=</span> <span class="n">Queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
        <span class="n">thread</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop_thread</span><span class="p">(</span><span class="n">stop_event</span><span class="p">,</span> <span class="n">stopped_event</span><span class="p">,</span> <span class="n">queue</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_task</span><span class="p">(</span><span class="n">function</span><span class="p">,</span> <span class="n">time_interval</span><span class="p">,</span> <span class="n">stop_event</span><span class="p">,</span> <span class="n">stopped_event</span><span class="p">,</span> <span class="n">queue</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">start</span><span class="p">:</span>
            <span class="n">thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_threads</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">thread</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">thread</span></div>
    <span class="k">def</span> <span class="nf">_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">function</span><span class="p">,</span> <span class="n">time_interval</span><span class="p">,</span> <span class="n">stop_event</span><span class="p">,</span> <span class="n">stopped_event</span><span class="p">,</span> <span class="n">queue</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;thread handling loop. processes input Event to request thread termination and sends event back when thread terminates.&#39;&#39;&#39;</span>
        <span class="n">dly</span> <span class="o">=</span> <span class="n">delay_loop</span><span class="p">()</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">params</span><span class="p">[</span><span class="s">&#39;time_interval&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time_interval</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">stop_event</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span> <span class="c">#add ability to pass external message to terminate thread???</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">attr</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">get_nowait</span><span class="p">()</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                    <span class="k">print</span> <span class="s">&quot;Writing {} to {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">attr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">attr</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">params</span><span class="p">[</span><span class="n">attr</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">attr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">except</span> <span class="n">Queue</span><span class="o">.</span><span class="n">Empty</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="k">print</span> <span class="s">&quot;Executing {} at time {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">function</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">())</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">function</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">StopIteration</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                    <span class="k">print</span> <span class="s">&quot;Thread {} terminating - reached end of sequence at time {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">function</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">())</span>
                <span class="n">stopped_event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
                <span class="k">return</span>
            <span class="n">dly</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;time_interval&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;Thread {} terminating - received stop event at time {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">function</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">())</span>
        <span class="n">stopped_event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="floatRange"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_utils.html#PyICe.lab_instruments.floatRange">[docs]</a><span class="k">def</span> <span class="nf">floatRange</span><span class="p">(</span><span class="n">start</span><span class="p">,</span><span class="n">stop</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">step</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Returns a list of numbers similar to python range() builtin but supports floats.</span>
<span class="sd">        start is inclusive, stop is exclusive</span>
<span class="sd">        When called with a single argument, start=0 and the argument becomes stop.&#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="floatRangeInc"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_utils.html#PyICe.lab_instruments.floatRangeInc">[docs]</a><span class="k">def</span> <span class="nf">floatRangeInc</span><span class="p">(</span><span class="n">start</span><span class="p">,</span><span class="n">stop</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">step</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Same as float range, however it is inclusive of the last value&#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="n">floatRange</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="n">stop</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="logRange"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_utils.html#PyICe.lab_instruments.logRange">[docs]</a><span class="k">def</span> <span class="nf">logRange</span><span class="p">(</span><span class="n">start</span><span class="p">,</span><span class="n">stop</span><span class="p">,</span><span class="n">stepsPerDecade</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">stepsPerOctave</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;log step range function similar to python built-in range()&#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">stepsPerDecade</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">stepsPerOctave</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">):</span>
        <span class="n">stepsize</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="mf">1.0</span><span class="o">/</span><span class="n">stepsPerDecade</span><span class="p">)</span> <span class="c">#possible divide by zero!</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">stepsPerDecade</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">stepsPerOctave</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">):</span>
        <span class="n">stepsize</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="p">(</span><span class="mf">1.0</span><span class="o">/</span><span class="n">stepsPerOctave</span><span class="p">)</span> <span class="c">#possible divide by zero!</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;Must call logRange function with exactly one of the (stepsPerDecade, stepsPerOctave) arguments&#39;</span><span class="p">)</span>
    <span class="n">point</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">point</span> <span class="o">&lt;</span> <span class="n">stop</span><span class="p">):</span>
        <span class="n">r</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">point</span><span class="p">)</span>
        <span class="n">point</span> <span class="o">*=</span> <span class="n">stepsize</span>
    <span class="k">return</span> <span class="n">r</span>
</div>
<div class="viewcode-block" id="decadeListRange"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_utils.html#PyICe.lab_instruments.decadeListRange">[docs]</a><span class="k">def</span> <span class="nf">decadeListRange</span><span class="p">(</span><span class="n">decadePoints</span><span class="p">,</span><span class="n">decades</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;log step range function similar to python built-in range()</span>
<span class="sd">    accepts list input of points in a single decade and repeats</span>
<span class="sd">    these points over the specified number of decades</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">r</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">exp</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">decades</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
        <span class="n">r</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="n">exp</span><span class="p">,</span> <span class="n">decadePoints</span><span class="p">))</span>
        <span class="n">decades</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="n">exp</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">r</span>
    </div>
<div class="viewcode-block" id="email"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_utils.html#PyICe.lab_instruments.email">[docs]</a><span class="k">class</span> <span class="nc">email</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;sends email to specified destination from dedicated gmail account, or account of your choosing&#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">destination</span><span class="p">,</span> <span class="n">login</span><span class="o">=</span><span class="s">&#39;ltlabboston&#39;</span><span class="p">,</span> <span class="n">pw</span><span class="o">=</span><span class="s">&#39;PythonLab&#39;</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="s">&#39;gmail.com&#39;</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;destination is the recipient&#39;s email address&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">destination</span> <span class="o">=</span> <span class="n">destination</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">login</span> <span class="o">=</span> <span class="n">login</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">pw</span> <span class="o">=</span> <span class="n">pw</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sender</span> <span class="o">=</span> <span class="n">login</span> <span class="o">+</span> <span class="s">&#39;@&#39;</span> <span class="o">+</span> <span class="n">domain</span>
<div class="viewcode-block" id="email.send"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_utils.html#PyICe.lab_instruments.email.send">[docs]</a>    <span class="k">def</span> <span class="nf">send</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">body</span><span class="p">,</span> <span class="n">subject</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">attachments</span> <span class="o">=</span> <span class="p">[]):</span>
        <span class="sd">&#39;&#39;&#39;compose MIME message with proper headers and send&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">attachments</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="n">MIMEText</span><span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="n">_charset</span><span class="o">=</span><span class="s">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="n">MIMEMultipart</span><span class="p">(</span><span class="s">&#39;mixed&#39;</span><span class="p">)</span>
            <span class="n">message</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">MIMEText</span><span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="n">_charset</span><span class="o">=</span><span class="s">&quot;utf-8&quot;</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">attachment</span> <span class="ow">in</span> <span class="n">attachments</span><span class="p">:</span>
                <span class="n">filebytes</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">attachment</span><span class="p">,</span> <span class="s">&quot;rb&quot;</span><span class="p">)</span>
                <span class="n">Attachment</span> <span class="o">=</span> <span class="n">MIMEApplication</span><span class="p">(</span><span class="n">filebytes</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
                <span class="n">Attachment</span><span class="o">.</span><span class="n">add_header</span><span class="p">(</span><span class="s">&#39;content-disposition&#39;</span><span class="p">,</span> <span class="s">&#39;attachment&#39;</span><span class="p">,</span> <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">attachment</span><span class="p">))</span>
                <span class="n">message</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">Attachment</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">subject</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">):</span>
            <span class="n">message</span><span class="p">[</span><span class="s">&#39;Subject&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">subject</span>
        <span class="n">message</span><span class="p">[</span><span class="s">&#39;To&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">destination</span>
        <span class="n">message</span><span class="p">[</span><span class="s">&#39;From&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sender</span>
        <span class="n">server</span> <span class="o">=</span> <span class="n">smtplib</span><span class="o">.</span><span class="n">SMTP</span><span class="p">(</span><span class="s">&#39;smtp.gmail.com:587&#39;</span><span class="p">)</span>  
        <span class="n">server</span><span class="o">.</span><span class="n">ehlo</span><span class="p">()</span>
        <span class="n">server</span><span class="o">.</span><span class="n">starttls</span><span class="p">()</span>  
        <span class="n">server</span><span class="o">.</span><span class="n">ehlo</span><span class="p">()</span>
        <span class="n">server</span><span class="o">.</span><span class="n">login</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">login</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">pw</span><span class="p">)</span>  
        <span class="n">server</span><span class="o">.</span><span class="n">sendmail</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sender</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">destination</span><span class="p">,</span> <span class="n">message</span><span class="o">.</span><span class="n">as_string</span><span class="p">())</span>
        <span class="n">server</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span>
</div></div>
<div class="viewcode-block" id="sms"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_utils.html#PyICe.lab_instruments.sms">[docs]</a><span class="k">class</span> <span class="nc">sms</span><span class="p">(</span><span class="n">email</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Extends email class to send sms messages through several carriers&#39; email to sms gateways&#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mobile_number</span><span class="p">,</span> <span class="n">carrier</span><span class="p">,</span> <span class="n">login</span><span class="o">=</span><span class="s">&#39;ltlabboston&#39;</span><span class="p">,</span> <span class="n">pw</span><span class="o">=</span><span class="s">&#39;PythonLab&#39;</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="s">&#39;gmail.com&#39;</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;carrier is &#39;verizon&#39;, &#39;tmobile&#39;, &#39;att&#39;, &#39;sprint&#39;, or &#39;nextel&#39; &#39;&#39;&#39;</span>
        <span class="n">sms_email</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="k">for</span> <span class="n">digit</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">mobile_number</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">digit</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span> <span class="c">#remove dashes, dots, spaces, and whatever other non-digits came in</span>
                <span class="n">sms_email</span> <span class="o">+=</span> <span class="n">digit</span>
        <span class="n">sms_email</span> <span class="o">=</span> <span class="n">sms_email</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s">&#39;1&#39;</span><span class="p">)</span> <span class="c">#remove country code</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sms_email</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">10</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;mobile_number argument must be a 10-digit phone number with area code&#39;</span><span class="p">)</span>
        <span class="n">carrier</span> <span class="o">=</span> <span class="n">carrier</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">carrier</span> <span class="o">==</span> <span class="s">&#39;verizon&#39;</span><span class="p">):</span>
            <span class="n">sms_email</span> <span class="o">+=</span> <span class="s">&#39;@vtext.com&#39;</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">carrier</span> <span class="o">==</span> <span class="s">&#39;t-mobile&#39;</span> <span class="ow">or</span> <span class="n">carrier</span> <span class="o">==</span> <span class="s">&#39;tmobile&#39;</span><span class="p">):</span>
            <span class="n">sms_email</span> <span class="o">+=</span> <span class="s">&#39;@tmomail.net&#39;</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">carrier</span> <span class="o">==</span> <span class="s">&#39;att&#39;</span> <span class="ow">or</span> <span class="n">carrier</span> <span class="o">==</span> <span class="s">&#39;at&amp;t&#39;</span><span class="p">):</span>
            <span class="n">sms_email</span> <span class="o">+=</span> <span class="s">&#39;@txt.att.net &#39;</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">carrier</span> <span class="o">==</span> <span class="s">&#39;sprint&#39;</span><span class="p">):</span>
            <span class="n">sms_email</span> <span class="o">+=</span> <span class="s">&#39;@messaging.sprintpcs.com&#39;</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">carrier</span> <span class="o">==</span> <span class="s">&#39;nextel&#39;</span><span class="p">):</span>
            <span class="n">sms_email</span> <span class="o">+=</span> <span class="s">&#39;@page.nextel.com&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c">#look up additional sms email gateways here: http://en.wikipedia.org/wiki/List_of_SMS_gateways</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;carrier argument must be &quot;verizon&quot;, &quot;t-mobile&quot;, &quot;att&quot;, &quot;sprint&quot;, or &quot;nextel&quot; unless you add your carrier to the list&#39;</span><span class="p">)</span>
        <span class="n">email</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sms_email</span><span class="p">,</span> <span class="n">login</span><span class="p">,</span> <span class="n">pw</span><span class="p">,</span> <span class="n">domain</span><span class="p">)</span>
        </div>
<span class="k">def</span> <span class="nf">str2num</span><span class="p">(</span><span class="n">str_in</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">str_in</span><span class="p">,</span><span class="nb">int</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">str_in</span><span class="p">,</span><span class="nb">float</span><span class="p">)</span> <span class="ow">or</span> <span class="n">str_in</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">str_in</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">str_in</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="c">#automatically select base</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">str_in</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;string failed to convert both to integer (automatic base selection) and float: {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">e</span>

<span class="k">def</span> <span class="nf">clean_c</span><span class="p">(</span><span class="nb">str</span><span class="p">):</span>
    <span class="nb">str</span> <span class="o">=</span> <span class="nb">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">,</span><span class="s">&quot;_&quot;</span><span class="p">)</span> <span class="c">#0x09</span>
    <span class="nb">str</span> <span class="o">=</span> <span class="nb">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="p">,</span><span class="s">&quot;_&quot;</span><span class="p">)</span> <span class="c">#0x20</span>
    <span class="nb">str</span> <span class="o">=</span> <span class="nb">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;!&quot;</span><span class="p">,</span><span class="s">&quot;_BANG_&quot;</span><span class="p">)</span> <span class="c">#0x21</span>
    <span class="nb">str</span> <span class="o">=</span> <span class="nb">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;&quot;&#39;</span><span class="p">,</span><span class="s">&quot;_DQT_&quot;</span><span class="p">)</span> <span class="c">#0x22</span>
    <span class="nb">str</span> <span class="o">=</span> <span class="nb">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;#&quot;</span><span class="p">,</span><span class="s">&quot;_PND_&quot;</span><span class="p">)</span> <span class="c">#0x23</span>
    <span class="nb">str</span> <span class="o">=</span> <span class="nb">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;$&quot;</span><span class="p">,</span><span class="s">&quot;_DOL_&quot;</span><span class="p">)</span> <span class="c">#0x24</span>
    <span class="nb">str</span> <span class="o">=</span> <span class="nb">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;%&quot;</span><span class="p">,</span><span class="s">&quot;_PER_&quot;</span><span class="p">)</span> <span class="c">#0x25</span>
    <span class="nb">str</span> <span class="o">=</span> <span class="nb">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;&amp;&quot;</span><span class="p">,</span><span class="s">&quot;_AND_&quot;</span><span class="p">)</span> <span class="c">#0x26</span>
    <span class="nb">str</span> <span class="o">=</span> <span class="nb">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;&#39;&quot;</span><span class="p">,</span><span class="s">&quot;_SQT_&quot;</span><span class="p">)</span> <span class="c">#0x27</span>
    <span class="nb">str</span> <span class="o">=</span> <span class="nb">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;(&quot;</span><span class="p">,</span><span class="s">&quot;_OPNP_&quot;</span><span class="p">)</span> <span class="c">#0x28</span>
    <span class="nb">str</span> <span class="o">=</span> <span class="nb">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;)&quot;</span><span class="p">,</span><span class="s">&quot;_CLSP_&quot;</span><span class="p">)</span> <span class="c">#0x29</span>
    <span class="nb">str</span> <span class="o">=</span> <span class="nb">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;*&quot;</span><span class="p">,</span><span class="s">&quot;_MUL_&quot;</span><span class="p">)</span> <span class="c">#0x2A</span>
    <span class="nb">str</span> <span class="o">=</span> <span class="nb">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;+&quot;</span><span class="p">,</span><span class="s">&quot;_PLS_&quot;</span><span class="p">)</span> <span class="c">#0x2B</span>
    <span class="nb">str</span> <span class="o">=</span> <span class="nb">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;,&quot;</span><span class="p">,</span><span class="s">&quot;_COMA_&quot;</span><span class="p">)</span> <span class="c">#0x2C</span>
    <span class="nb">str</span> <span class="o">=</span> <span class="nb">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;-&quot;</span><span class="p">,</span><span class="s">&quot;_MNS_&quot;</span><span class="p">)</span> <span class="c">#0x2D</span>
    <span class="nb">str</span> <span class="o">=</span> <span class="nb">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;.&quot;</span><span class="p">,</span><span class="s">&quot;p&quot;</span><span class="p">)</span> <span class="c">#0x2E</span>
    <span class="nb">str</span> <span class="o">=</span> <span class="nb">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">,</span><span class="s">&quot;_DIV_&quot;</span><span class="p">)</span> <span class="c">#0x2F</span>
    <span class="nb">str</span> <span class="o">=</span> <span class="nb">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;:&quot;</span><span class="p">,</span><span class="s">&quot;_CLN_&quot;</span><span class="p">)</span> <span class="c">#0x3A</span>
    <span class="nb">str</span> <span class="o">=</span> <span class="nb">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;;&quot;</span><span class="p">,</span><span class="s">&quot;_SCLN_&quot;</span><span class="p">)</span> <span class="c">#0x3B</span>
    <span class="nb">str</span> <span class="o">=</span> <span class="nb">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;&lt;&quot;</span><span class="p">,</span><span class="s">&quot;_LSS_THN_&quot;</span><span class="p">)</span> <span class="c">#0x3C</span>
    <span class="nb">str</span> <span class="o">=</span> <span class="nb">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;=&quot;</span><span class="p">,</span><span class="s">&quot;_EQLS_&quot;</span><span class="p">)</span> <span class="c">#0x3D</span>
    <span class="nb">str</span> <span class="o">=</span> <span class="nb">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;&gt;&quot;</span><span class="p">,</span><span class="s">&quot;_GRTR_THN_&quot;</span><span class="p">)</span> <span class="c">#0x3E</span>
    <span class="nb">str</span> <span class="o">=</span> <span class="nb">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;?&quot;</span><span class="p">,</span><span class="s">&quot;_QUES_&quot;</span><span class="p">)</span> <span class="c">#0x3F</span>
    <span class="nb">str</span> <span class="o">=</span> <span class="nb">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;@&quot;</span><span class="p">,</span><span class="s">&quot;_AT_&quot;</span><span class="p">)</span> <span class="c">#0x40</span>
    <span class="nb">str</span> <span class="o">=</span> <span class="nb">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;[&quot;</span><span class="p">,</span><span class="s">&quot;_OPNS_&quot;</span><span class="p">)</span> <span class="c">#0x5B</span>
    <span class="nb">str</span> <span class="o">=</span> <span class="nb">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\\</span><span class="s">&quot;</span><span class="p">,</span><span class="s">&quot;_SLSH_&quot;</span><span class="p">)</span> <span class="c">#0x5C</span>
    <span class="nb">str</span> <span class="o">=</span> <span class="nb">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;]&quot;</span><span class="p">,</span><span class="s">&quot;_CLSS_&quot;</span><span class="p">)</span> <span class="c">#0x5D</span>
    <span class="nb">str</span> <span class="o">=</span> <span class="nb">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;^&quot;</span><span class="p">,</span><span class="s">&quot;_CAR_&quot;</span><span class="p">)</span> <span class="c">#0x5E</span>
    <span class="c">#0x5F is &#39;_&#39;</span>
    <span class="nb">str</span> <span class="o">=</span> <span class="nb">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;`&quot;</span><span class="p">,</span><span class="s">&quot;_GRAVE_&quot;</span><span class="p">)</span> <span class="c">#0x60</span>
    <span class="nb">str</span> <span class="o">=</span> <span class="nb">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;{&quot;</span><span class="p">,</span><span class="s">&quot;_OPNC_&quot;</span><span class="p">)</span> <span class="c">#0x7B</span>
    <span class="nb">str</span> <span class="o">=</span> <span class="nb">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;|&quot;</span><span class="p">,</span><span class="s">&quot;_OR_&quot;</span><span class="p">)</span> <span class="c">#0x7C</span>
    <span class="nb">str</span> <span class="o">=</span> <span class="nb">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;}&quot;</span><span class="p">,</span><span class="s">&quot;_CLSC_&quot;</span><span class="p">)</span> <span class="c">#0x7D</span>
    <span class="nb">str</span> <span class="o">=</span> <span class="nb">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;~&quot;</span><span class="p">,</span><span class="s">&quot;_TIL_&quot;</span><span class="p">)</span> <span class="c">#0x7E</span>
    <span class="k">if</span> <span class="nb">str</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
        <span class="nb">str</span> <span class="o">=</span> <span class="s">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">:</span>
        <span class="c">#all characters 0x3A-0x40 and 0x5B-0x60 already replaced above.</span>
        <span class="k">if</span> <span class="nb">ord</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">127</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;TODO?: escape non-ascii character found in: {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">ord</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mh">0x30</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;Ascii control character code point {} found in: {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">c</span><span class="p">),</span><span class="nb">str</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">ord</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mh">0x7A</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;Ascii non-alphanumeric character code point {} found in: {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">c</span><span class="p">),</span><span class="nb">str</span><span class="p">))</span>
    <span class="k">return</span> <span class="nb">str</span>

<span class="k">def</span> <span class="nf">remove_non_ascii</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
    <span class="n">out</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">text</span><span class="p">:</span>
        <span class="c">#all characters 0x3A-0x40 and 0x5B-0x60 already replaced above.</span>
        <span class="k">if</span> <span class="nb">ord</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">127</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="s">&quot;(REMOVED_NON_ASCII)&quot;</span>
        <span class="n">out</span> <span class="o">+=</span> <span class="n">c</span>
    <span class="k">return</span> <span class="n">out</span>
    
<span class="k">def</span> <span class="nf">remove_html</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
  <span class="k">if</span> <span class="n">text</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
    <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s">&#39;&lt;[^&lt;]+?&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">text</span>
  
<div class="viewcode-block" id="swap_endian"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_utils.html#PyICe.lab_instruments.swap_endian">[docs]</a><span class="k">def</span> <span class="nf">swap_endian</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="n">elementCount</span><span class="p">,</span> <span class="n">elementSize</span><span class="o">=</span><span class="mi">8</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;reverse endianness of multi-byte word</span>
<span class="sd">    elementCount is number of bytes, or other atomic memory block if not of elementSize 8 bits</span>
<span class="sd">    </span>
<span class="sd">    to reverse bit order, set elementCount to the number of bits and set elementSize to 1.&#39;&#39;&#39;</span>
    <span class="k">assert</span> <span class="n">word</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="o">**</span><span class="p">(</span><span class="n">elementSize</span><span class="o">*</span><span class="n">elementCount</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">word</span> <span class="o">&gt;=</span> <span class="mi">0</span>
    <span class="nb">reversed</span> <span class="o">=</span> <span class="mh">0x00</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="n">elementSize</span><span class="o">-</span><span class="mi">1</span>
    <span class="k">while</span> <span class="n">elementCount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">reversed</span> <span class="o">^=</span> <span class="p">(</span><span class="n">word</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">elementSize</span><span class="o">*</span><span class="p">(</span><span class="n">elementCount</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">word</span> <span class="o">=</span> <span class="n">word</span> <span class="o">&gt;&gt;</span> <span class="n">elementSize</span>
        <span class="n">elementCount</span> <span class="o">-=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="nb">reversed</span>
</div>
<div class="viewcode-block" id="signedToTwosComplement"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_utils.html#PyICe.lab_instruments.signedToTwosComplement">[docs]</a><span class="k">def</span> <span class="nf">signedToTwosComplement</span><span class="p">(</span><span class="n">signed</span><span class="p">,</span> <span class="n">bitCount</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;take python int and convert to two&#39;s complement representation using specified number of bits&#39;&#39;&#39;</span>
    <span class="k">assert</span> <span class="n">signed</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="o">**</span><span class="p">(</span><span class="n">bitCount</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">signed</span> <span class="o">&gt;=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="mi">2</span><span class="o">**</span><span class="p">(</span><span class="n">bitCount</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">signed</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">signed</span> <span class="o">+=</span> <span class="mi">2</span><span class="o">**</span><span class="n">bitCount</span>
        <span class="n">signed</span> <span class="o">&amp;=</span> <span class="mi">2</span><span class="o">**</span><span class="n">bitCount</span><span class="o">-</span><span class="mi">1</span>
    <span class="k">return</span> <span class="n">signed</span>
</div>
<div class="viewcode-block" id="twosComplementToSigned"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_utils.html#PyICe.lab_instruments.twosComplementToSigned">[docs]</a><span class="k">def</span> <span class="nf">twosComplementToSigned</span><span class="p">(</span><span class="n">binary</span><span class="p">,</span> <span class="n">bitCount</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;take two&#39;s complement number with specified number of bits and convert to python int representation&#39;&#39;&#39;</span>
    <span class="k">assert</span> <span class="n">binary</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="o">**</span><span class="n">bitCount</span>
    <span class="k">assert</span> <span class="n">binary</span> <span class="o">&gt;=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">binary</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="o">**</span><span class="p">(</span><span class="n">bitCount</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">binary</span> <span class="o">-=</span> <span class="mi">2</span><span class="o">**</span><span class="n">bitCount</span>
    <span class="k">return</span> <span class="n">binary</span>
</div>
<div class="viewcode-block" id="isclose"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_utils.html#PyICe.lab_instruments.isclose">[docs]</a><span class="k">def</span> <span class="nf">isclose</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">rel_tol</span><span class="o">=</span><span class="mf">1e-9</span><span class="p">,</span> <span class="n">abs_tol</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
    <span class="c">#backported from 3.5</span>
    <span class="c">#https://github.com/PythonCHB/close_pep/blob/master/isclose.py</span>
    <span class="c">#https://www.python.org/dev/peps/pep-0485/</span>
    <span class="c">#https://docs.python.org/3/library/math.html#math.isclose</span>
    <span class="c">#alternative tests here: https://github.com/PythonCHB/close_pep/blob/master/is_close.py</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    returns True if a is close in value to b. False otherwise</span>
<span class="sd">    :param a: one of the values to be tested</span>
<span class="sd">    :param b: the other value to be tested</span>
<span class="sd">    :param rel_tol=1e-9: The relative tolerance -- the amount of error</span>
<span class="sd">                         allowed, relative to the absolute value of the</span>
<span class="sd">                         larger input values.</span>
<span class="sd">    :param abs_tol=0.0: The minimum absolute tolerance level -- useful</span>
<span class="sd">        for comparisons to zero.</span>
<span class="sd">    NOTES:</span>
<span class="sd">    -inf, inf and NaN behave similarly to the IEEE 754 Standard. That</span>
<span class="sd">    is, NaN is not close to anything, even itself. inf and -inf are</span>
<span class="sd">    only close to themselves.</span>
<span class="sd">    The function can be used with any type that supports comparison,</span>
<span class="sd">    substratcion and multiplication, including Decimal, Fraction, and</span>
<span class="sd">    Complex</span>
<span class="sd">    Complex values are compared based on their absolute value.</span>
<span class="sd">    See PEP-0485 for a detailed description</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">a</span> <span class="o">==</span> <span class="n">b</span><span class="p">:</span>  <span class="c"># short-circuit exact equality</span>
        <span class="k">return</span> <span class="bp">True</span>

    <span class="k">if</span> <span class="n">rel_tol</span> <span class="o">&lt;</span> <span class="mf">0.0</span> <span class="ow">or</span> <span class="n">abs_tol</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;error tolerances must be non-negative&#39;</span><span class="p">)</span>

    <span class="c"># use cmath so it will work with complex ot float</span>
    <span class="k">if</span> <span class="n">math</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">a</span><span class="p">))</span> <span class="ow">or</span> <span class="n">math</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">b</span><span class="p">)):</span>
        <span class="c"># This includes the case of two infinities of opposite sign, or</span>
        <span class="c"># one infinity and one finite number. Two infinities of opposite sign</span>
        <span class="c"># would otherwise have an infinite relative tolerance.</span>
        <span class="k">return</span> <span class="bp">False</span>
    <span class="n">diff</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">b</span> <span class="o">-</span> <span class="n">a</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(((</span><span class="n">diff</span> <span class="o">&lt;=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">rel_tol</span> <span class="o">*</span> <span class="n">b</span><span class="p">))</span> <span class="ow">and</span> <span class="c">#DJS change from weak to strong symmetry so that argument order doesn&#39;t matter</span>
             <span class="p">(</span><span class="n">diff</span> <span class="o">&lt;=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">rel_tol</span> <span class="o">*</span> <span class="n">a</span><span class="p">)))</span> <span class="ow">or</span>
            <span class="p">(</span><span class="n">diff</span> <span class="o">&lt;=</span> <span class="n">abs_tol</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="unit_least_precision"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_utils.html#PyICe.lab_instruments.unit_least_precision">[docs]</a><span class="k">def</span> <span class="nf">unit_least_precision</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">increasing</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;return positive increment/decrement to next representable floating point number above/below val&#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">increasing</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">float_next</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">-</span> <span class="n">val</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">val</span> <span class="o">-</span> <span class="n">float_prior</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="float_next"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_utils.html#PyICe.lab_instruments.float_next">[docs]</a><span class="k">def</span> <span class="nf">float_next</span><span class="p">(</span><span class="n">val</span><span class="p">):</span> 
    <span class="sd">&#39;&#39;&#39;return next Python double precision floating point nuber larger than x.&#39;&#39;&#39;</span>
    <span class="c">#algorithm copied from Boost: http://www.boost.org/doc/libs/1_45_0/boost/math/special_functions/next.hpp</span>
    <span class="k">assert</span> <span class="ow">not</span> <span class="n">math</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
    <span class="k">assert</span> <span class="ow">not</span> <span class="n">math</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
    <span class="k">assert</span> <span class="ow">not</span> <span class="n">val</span> <span class="o">&gt;=</span> <span class="n">sys</span><span class="o">.</span><span class="n">float_info</span><span class="o">.</span><span class="n">max</span>
    <span class="k">if</span> <span class="n">val</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">sys</span><span class="o">.</span><span class="n">float_info</span><span class="o">.</span><span class="n">epsilon</span><span class="o">*</span><span class="n">sys</span><span class="o">.</span><span class="n">float_info</span><span class="o">.</span><span class="n">min</span> <span class="c">#denorm min</span>
    <span class="n">frac</span><span class="p">,</span> <span class="n">expon</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">frexp</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">frac</span> <span class="o">==</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">:</span>
        <span class="n">expon</span> <span class="o">-=</span> <span class="mi">1</span> <span class="c">#reduce exponent when val is a power of two, and negative.</span>
    <span class="n">diff</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ldexp</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">expon</span> <span class="o">-</span> <span class="n">sys</span><span class="o">.</span><span class="n">float_info</span><span class="o">.</span><span class="n">mant_dig</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">diff</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">diff</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">float_info</span><span class="o">.</span><span class="n">epsilon</span><span class="o">*</span><span class="n">sys</span><span class="o">.</span><span class="n">float_info</span><span class="o">.</span><span class="n">min</span> <span class="c">#denorm min</span>
    <span class="k">return</span> <span class="n">val</span> <span class="o">+</span> <span class="n">diff</span><span class="p">;</span>
</div>
<div class="viewcode-block" id="float_prior"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_utils.html#PyICe.lab_instruments.float_prior">[docs]</a><span class="k">def</span> <span class="nf">float_prior</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;return next Python double precision floating point nuber smaller than x.&#39;&#39;&#39;</span>
    <span class="c">#algorithm copied from Boost: http://www.boost.org/doc/libs/1_45_0/boost/math/special_functions/next.hpp</span>
    <span class="k">assert</span> <span class="ow">not</span> <span class="n">math</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
    <span class="k">assert</span> <span class="ow">not</span> <span class="n">math</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
    <span class="k">assert</span> <span class="ow">not</span> <span class="n">val</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="n">sys</span><span class="o">.</span><span class="n">float_info</span><span class="o">.</span><span class="n">max</span>
    <span class="k">if</span> <span class="n">val</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">sys</span><span class="o">.</span><span class="n">float_info</span><span class="o">.</span><span class="n">epsilon</span><span class="o">*</span><span class="n">sys</span><span class="o">.</span><span class="n">float_info</span><span class="o">.</span><span class="n">min</span> <span class="c">#denorm min</span>
    <span class="n">frac</span><span class="p">,</span> <span class="n">expon</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">frexp</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">frac</span> <span class="o">==</span> <span class="mf">0.5</span><span class="p">:</span>
        <span class="n">expon</span> <span class="o">-=</span> <span class="mi">1</span> <span class="c">#when val is a power of two we must reduce the exponent</span>
    <span class="n">diff</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ldexp</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">expon</span> <span class="o">-</span> <span class="n">sys</span><span class="o">.</span><span class="n">float_info</span><span class="o">.</span><span class="n">mant_dig</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">diff</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">diff</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">float_info</span><span class="o">.</span><span class="n">epsilon</span><span class="o">*</span><span class="n">sys</span><span class="o">.</span><span class="n">float_info</span><span class="o">.</span><span class="n">min</span> <span class="c">#denorm min</span>
    <span class="k">return</span> <span class="n">val</span> <span class="o">-</span> <span class="n">diff</span>
</div>
<div class="viewcode-block" id="float_distance"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_utils.html#PyICe.lab_instruments.float_distance">[docs]</a><span class="k">def</span> <span class="nf">float_distance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;return signed difference between x and y expressed as distance between representable floating point numbers.&#39;&#39;&#39;</span>
    <span class="c">#Boost library algorithm port: http://www.boost.org/doc/libs/1_45_0/boost/math/special_functions/next.hpp</span>
    <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="n">y</span><span class="p">:</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">float_distance</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">x</span> <span class="o">==</span> <span class="n">y</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="k">elif</span> <span class="n">x</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">1</span> <span class="o">+</span> <span class="nb">abs</span><span class="p">(</span><span class="n">float_distance</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">copysign</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">y</span><span class="p">)</span> <span class="o">*</span> <span class="n">sys</span><span class="o">.</span><span class="n">float_info</span><span class="o">.</span><span class="n">epsilon</span><span class="o">*</span><span class="n">sys</span><span class="o">.</span><span class="n">float_info</span><span class="o">.</span><span class="n">min</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span> <span class="c">#denorm min</span>
    <span class="k">elif</span> <span class="n">y</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">1</span> <span class="o">+</span> <span class="nb">abs</span><span class="p">(</span><span class="n">float_distance</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">copysign</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="n">sys</span><span class="o">.</span><span class="n">float_info</span><span class="o">.</span><span class="n">epsilon</span><span class="o">*</span><span class="n">sys</span><span class="o">.</span><span class="n">float_info</span><span class="o">.</span><span class="n">min</span><span class="p">,</span> <span class="n">x</span><span class="p">))</span> <span class="c">#denorm min</span>
    <span class="k">elif</span> <span class="n">math</span><span class="o">.</span><span class="n">copysign</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">x</span><span class="p">)</span> <span class="o">!=</span> <span class="n">math</span><span class="o">.</span><span class="n">copysign</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">y</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">2</span> <span class="o">+</span> <span class="nb">abs</span><span class="p">(</span><span class="n">float_distance</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">copysign</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="n">sys</span><span class="o">.</span><span class="n">float_info</span><span class="o">.</span><span class="n">epsilon</span><span class="o">*</span><span class="n">sys</span><span class="o">.</span><span class="n">float_info</span><span class="o">.</span><span class="n">min</span><span class="p">,</span> <span class="n">x</span><span class="p">))</span> <span class="o">+</span> <span class="nb">abs</span><span class="p">(</span><span class="n">float_distance</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">copysign</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">y</span><span class="p">)</span> <span class="o">*</span> <span class="n">sys</span><span class="o">.</span><span class="n">float_info</span><span class="o">.</span><span class="n">epsilon</span><span class="o">*</span><span class="n">sys</span><span class="o">.</span><span class="n">float_info</span><span class="o">.</span><span class="n">min</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span> <span class="c">#denorm min</span>
    <span class="c">#should have same sign now</span>
    <span class="k">elif</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">float_distance</span><span class="p">(</span><span class="o">-</span><span class="n">y</span><span class="p">,</span> <span class="o">-</span><span class="n">x</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">x</span> <span class="o">&gt;=</span> <span class="mi">0</span>
    <span class="k">assert</span> <span class="n">y</span> <span class="o">&gt;=</span> <span class="n">x</span>
    
    <span class="c"># Note that if a is a denorm then the usual formula fails because we actually have fewer than tools::digits&lt;T&gt;() significant bits in the representation:</span>
    <span class="n">expon</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">frexp</span><span class="p">(</span><span class="n">x</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">expon</span> <span class="o">&lt;</span> <span class="n">sys</span><span class="o">.</span><span class="n">float_info</span><span class="o">.</span><span class="n">min_exp</span><span class="p">:</span>
        <span class="n">expon</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">float_info</span><span class="o">.</span><span class="n">min_exp</span>
    <span class="n">upper</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ldexp</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">expon</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">expon</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">float_info</span><span class="o">.</span><span class="n">mant_dig</span> <span class="o">-</span> <span class="n">expon</span> <span class="c">#For floating-point types, this is the number of digits in the mantissa.</span>
    <span class="c">#If b is greater than upper, then we *must* split the calculation as the size of the ULP changes with each order of magnitude change:</span>
    <span class="k">if</span><span class="p">(</span><span class="n">y</span> <span class="o">&gt;</span> <span class="n">upper</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">float_distance</span><span class="p">(</span><span class="n">upper</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">upper</span>
    <span class="c">#Use compensated double-double addition to avoid rounding errors in the subtraction:</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="n">y</span>
    <span class="n">Z</span> <span class="o">=</span> <span class="n">X</span> <span class="o">-</span> <span class="n">x</span>
    <span class="n">Y</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="p">(</span><span class="n">X</span> <span class="o">-</span> <span class="n">Z</span><span class="p">))</span> <span class="o">-</span> <span class="p">(</span><span class="n">y</span> <span class="o">+</span> <span class="n">Z</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">X</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">X</span> <span class="o">=</span> <span class="o">-</span><span class="n">X</span>
        <span class="n">Y</span> <span class="o">=</span> <span class="o">-</span><span class="n">Y</span>
    <span class="n">result</span> <span class="o">+=</span> <span class="n">math</span><span class="o">.</span><span class="n">ldexp</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">expon</span><span class="p">)</span> <span class="o">+</span> <span class="n">math</span><span class="o">.</span><span class="n">ldexp</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">expon</span><span class="p">)</span>
    <span class="c">#Result must be an integer:</span>
    <span class="k">assert</span><span class="p">(</span><span class="n">result</span> <span class="o">==</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>
    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</div>
<span class="k">def</span> <span class="nf">bounded</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">min_value</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">max_value</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;key&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">key</span>
    <span class="k">if</span> <span class="n">min_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">max_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">max_value</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">),</span> <span class="n">min_value</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">min_value</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">max_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">max_value</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">min_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">max_value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">min_value</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">value</span>

<div class="viewcode-block" id="csv_writer"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_utils.html#PyICe.lab_instruments.csv_writer">[docs]</a><span class="k">class</span> <span class="nc">csv_writer</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;shared functions for higher level interfaces&#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">column_data_t</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">namedtuple</span><span class="p">(</span><span class="s">&#39;column_setup&#39;</span><span class="p">,[</span><span class="s">&#39;query_name&#39;</span><span class="p">,</span><span class="s">&#39;display_name&#39;</span><span class="p">,</span><span class="s">&#39;transform&#39;</span><span class="p">,</span><span class="s">&#39;format&#39;</span><span class="p">,</span><span class="s">&#39;query_function&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">no_transform</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">comments</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">def</span> <span class="nf">_format_header</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">header_txt</span> <span class="o">=</span> <span class="s">u&#39;&#39;</span>
        <span class="k">for</span> <span class="n">comment</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">comments</span><span class="p">:</span>
            <span class="n">header_txt</span> <span class="o">+=</span> <span class="n">comment</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span>
        <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">header_txt</span> <span class="o">+=</span> <span class="s">u&quot;{},&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">column</span><span class="o">.</span><span class="n">display_name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">header_txt</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span>
    <span class="k">def</span> <span class="nf">_format_output</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">column_setup_tuple</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;give just one element of a data row&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">column_setup_tuple</span><span class="o">.</span><span class="n">query_function</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">column_setup_tuple</span><span class="o">.</span><span class="n">query_function</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">column_setup_tuple</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">return</span> <span class="s">&#39;{},&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">column_setup_tuple</span><span class="o">.</span><span class="n">format</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<div class="viewcode-block" id="csv_writer.add_comment"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_utils.html#PyICe.lab_instruments.csv_writer.add_comment">[docs]</a>    <span class="k">def</span> <span class="nf">add_comment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">comment_str</span><span class="p">,</span> <span class="n">comment_character</span><span class="o">=</span><span class="s">&#39;#&#39;</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;add comment line(s) to the top of the output file.</span>
<span class="sd">        Live Graph treats &#39;@&#39; as a &#39;description line&#39; and &#39;#&#39; as a &#39;comment line&#39;.</span>
<span class="sd">        Neither has any effect on the data interpretation.&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">comments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">u&#39;{}{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">comment_character</span><span class="p">,</span><span class="n">comment_str</span><span class="p">))</span></div>
<div class="viewcode-block" id="csv_writer.add_elapsed_seconds"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_utils.html#PyICe.lab_instruments.csv_writer.add_elapsed_seconds">[docs]</a>    <span class="k">def</span> <span class="nf">add_elapsed_seconds</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">display_name</span><span class="o">=</span><span class="s">&#39;elapsed_seconds&#39;</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;computes elapsed seconds since first row of table&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_elapsed_time</span><span class="p">(</span><span class="n">display_name</span><span class="o">=</span><span class="n">display_name</span><span class="p">,</span><span class="n">format</span><span class="o">=</span><span class="n">format</span><span class="p">,</span><span class="n">transform</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">no_transform</span><span class="p">)</span></div>
<div class="viewcode-block" id="csv_writer.add_elapsed_minutes"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_utils.html#PyICe.lab_instruments.csv_writer.add_elapsed_minutes">[docs]</a>    <span class="k">def</span> <span class="nf">add_elapsed_minutes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">display_name</span><span class="o">=</span><span class="s">&#39;elapsed_minutes&#39;</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;computes elapsed minutes since first row of table&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_elapsed_time</span><span class="p">(</span><span class="n">display_name</span><span class="o">=</span><span class="n">display_name</span><span class="p">,</span><span class="n">format</span><span class="o">=</span><span class="n">format</span><span class="p">,</span><span class="n">transform</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">/</span><span class="mf">60.0</span><span class="p">)</span></div>
<div class="viewcode-block" id="csv_writer.add_elapsed_hours"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_utils.html#PyICe.lab_instruments.csv_writer.add_elapsed_hours">[docs]</a>    <span class="k">def</span> <span class="nf">add_elapsed_hours</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">display_name</span><span class="o">=</span><span class="s">&#39;elapsed_hours&#39;</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;computes elapsed hours since first row of table&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_elapsed_time</span><span class="p">(</span><span class="n">display_name</span><span class="o">=</span><span class="n">display_name</span><span class="p">,</span><span class="n">format</span><span class="o">=</span><span class="n">format</span><span class="p">,</span><span class="n">transform</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">/</span><span class="mf">3600.0</span><span class="p">)</span></div>
<div class="viewcode-block" id="csv_writer.add_elapsed_days"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_utils.html#PyICe.lab_instruments.csv_writer.add_elapsed_days">[docs]</a>    <span class="k">def</span> <span class="nf">add_elapsed_days</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">display_name</span><span class="o">=</span><span class="s">&#39;elapsed_days&#39;</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;computes elapsed days since first row of table&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_elapsed_time</span><span class="p">(</span><span class="n">display_name</span><span class="o">=</span><span class="n">display_name</span><span class="p">,</span><span class="n">format</span><span class="o">=</span><span class="n">format</span><span class="p">,</span><span class="n">transform</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">/</span><span class="mf">86400.0</span><span class="p">)</span></div>
    <span class="k">def</span> <span class="nf">_add_elapsed_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s">&#39;Elapsed time not implemented&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="csv_writer.add_column"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_utils.html#PyICe.lab_instruments.csv_writer.add_column">[docs]</a>    <span class="k">def</span> <span class="nf">add_column</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query_name</span><span class="p">,</span> <span class="n">display_name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="n">transform</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">query_function</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;add single column to output file.</span>
<span class="sd">        provides more customization options than addign a list of columns</span>
<span class="sd">        transform is a python function applied to the query results before formatting</span>
<span class="sd">        format is a format string to alter the column data.  Ex: 3.2f.</span>
<span class="sd">        query function is a function that returns data directly from Python rather than from external data source. Ex: time</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">display_name</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">display_name</span> <span class="o">=</span> <span class="n">query_name</span>
        <span class="n">format</span> <span class="o">=</span> <span class="n">format</span> <span class="o">=</span> <span class="s">&#39;{{:{}}}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">format</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">transform</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">transform</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_transform</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">column_data_t</span><span class="p">(</span><span class="n">display_name</span><span class="o">=</span><span class="n">display_name</span><span class="p">,</span><span class="n">query_name</span><span class="o">=</span><span class="n">query_name</span><span class="p">,</span><span class="n">transform</span><span class="o">=</span><span class="n">transform</span><span class="p">,</span><span class="n">format</span><span class="o">=</span><span class="n">format</span><span class="p">,</span><span class="n">query_function</span><span class="o">=</span><span class="n">query_function</span><span class="p">))</span></div>
<div class="viewcode-block" id="csv_writer.add_columns"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_utils.html#PyICe.lab_instruments.csv_writer.add_columns">[docs]</a>    <span class="k">def</span> <span class="nf">add_columns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">column_list</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Shortcut method to add multiple data columns at once.</span>
<span class="sd">        column_list selects additional data columns to output.</span>
<span class="sd">        format is a format string to alter the column data.  Ex: 3.2f.</span>
<span class="sd">        For more flexibility, add columns individually using add_column() method.&#39;&#39;&#39;</span>
        <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">column_list</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="n">column</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="n">format</span><span class="p">)</span>
</div></div>
<div class="viewcode-block" id="csv_logger"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_utils.html#PyICe.lab_instruments.csv_logger">[docs]</a><span class="k">class</span> <span class="nc">csv_logger</span><span class="p">(</span><span class="n">csv_writer</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;set up columns, then pass results dictionary from logger or channel group to write() method.</span>
<span class="sd">    Can be used to provide automated test script &#39;marching waves&#39; with a program such as Live Graph (http://www.live-graph.org/).</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_file</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s">&#39;utf-8&#39;</span><span class="p">):</span>
        <span class="n">csv_writer</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_file</span> <span class="o">=</span> <span class="n">output_file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">encoding</span> <span class="o">=</span> <span class="n">encoding</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header_written</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_file</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="c">#line buffered</span>
        <span class="n">atexit</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__del__</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_row_id</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>
    <span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">):</span>
        <span class="k">print</span> <span class="s">&quot;__exit__ closing CSV filehandle: {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_file</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">None</span>
    <span class="k">def</span> <span class="nf">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">print</span> <span class="s">&quot;__del__ closing CSV filehandle: {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_file</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">_row_count</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;private method used by rowid column.&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_row_id</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_row_id</span>
<div class="viewcode-block" id="csv_logger.add_timestamps"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_utils.html#PyICe.lab_instruments.csv_logger.add_timestamps">[docs]</a>    <span class="k">def</span> <span class="nf">add_timestamps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;add rowid and datetime fields to output&#39;&#39;&#39;</span>
        <span class="n">csv_writer</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">query_name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">display_name</span><span class="o">=</span><span class="s">&#39;rowid&#39;</span><span class="p">,</span> <span class="n">query_function</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_row_count</span><span class="p">)</span>
        <span class="n">csv_writer</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">query_name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">display_name</span><span class="o">=</span><span class="s">&#39;datetime&#39;</span><span class="p">,</span><span class="n">query_function</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">,</span><span class="n">transform</span><span class="o">=</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="s">&quot;%Y-%m-</span><span class="si">%d</span><span class="s">T%H:%M:%S.</span><span class="si">%f</span><span class="s">Z&quot;</span><span class="p">))</span> <span class="c">#2015-10-20 21:54:17</span></div>
    <span class="k">def</span> <span class="nf">_add_elapsed_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">display_name</span><span class="p">,</span><span class="n">format</span><span class="p">,</span><span class="n">transform</span><span class="p">):</span>
        <span class="n">csv_writer</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">query_name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">display_name</span><span class="o">=</span><span class="n">display_name</span><span class="p">,</span><span class="n">format</span><span class="o">=</span><span class="n">format</span><span class="p">,</span><span class="n">query_function</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">,</span><span class="n">transform</span><span class="o">=</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span><span class="n">transform</span><span class="p">((</span><span class="n">t</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">_time_zero</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()))</span>
<div class="viewcode-block" id="csv_logger.add_column"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_utils.html#PyICe.lab_instruments.csv_logger.add_column">[docs]</a>    <span class="k">def</span> <span class="nf">add_column</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">channel</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;set up output to include channel object as column data source&#39;&#39;&#39;</span>
        <span class="n">csv_writer</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query_name</span><span class="o">=</span><span class="n">channel</span><span class="o">.</span><span class="n">get_name</span><span class="p">(),</span> <span class="n">transform</span><span class="o">=</span><span class="n">channel</span><span class="o">.</span><span class="n">format_display</span><span class="p">)</span></div>
<div class="viewcode-block" id="csv_logger.add_columns"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_utils.html#PyICe.lab_instruments.csv_logger.add_columns">[docs]</a>    <span class="k">def</span> <span class="nf">add_columns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">channel_list</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;set up output to include channel objects in channel_list as column data sources&#39;&#39;&#39;</span>
        <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="n">channel_list</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="n">channel</span><span class="p">)</span></div>
<div class="viewcode-block" id="csv_logger.write"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_utils.html#PyICe.lab_instruments.csv_logger.write">[docs]</a>    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">channel_data</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;write selected columns with data supplied in channel_data dictionary&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">header_written</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_format_header</span><span class="p">()</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_time_zero</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="c">#for elapsed time computation</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">header_written</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">row_txt</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">column</span><span class="o">.</span><span class="n">query_function</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">row_txt</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_output</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">column</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">column</span><span class="o">.</span><span class="n">query_name</span> <span class="ow">in</span> <span class="n">channel_data</span><span class="p">:</span>
                <span class="n">row_txt</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_output</span><span class="p">(</span><span class="n">channel_data</span><span class="p">[</span><span class="n">column</span><span class="o">.</span><span class="n">query_name</span><span class="p">],</span> <span class="n">column</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;Data for column: {} not provided to write() method.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">column</span><span class="o">.</span><span class="n">display_name</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">((</span><span class="n">row_txt</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span> <span class="c">#just in case line buffering doesn&#39;t work</span>
        <span class="k">return</span> <span class="n">channel_data</span></div>
<div class="viewcode-block" id="csv_logger.register_logger_callback"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_utils.html#PyICe.lab_instruments.csv_logger.register_logger_callback">[docs]</a>    <span class="k">def</span> <span class="nf">register_logger_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logger</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;register this csv_logger instance with a lab_core.logger instance for automatic data plotting</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">add_log_callback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">)</span></div>
<div class="viewcode-block" id="csv_logger.unregister_logger_callback"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_utils.html#PyICe.lab_instruments.csv_logger.unregister_logger_callback">[docs]</a>    <span class="k">def</span> <span class="nf">unregister_logger_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logger</span><span class="p">,</span> <span class="n">close_file</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;clean up in case lab_core.logger will be re-used for a new test.&#39;&#39;&#39;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">remove_log_callback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">close_file</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</div></div>
<div class="viewcode-block" id="sqlite_to_csv"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_utils.html#PyICe.lab_instruments.sqlite_to_csv">[docs]</a><span class="k">class</span> <span class="nc">sqlite_to_csv</span><span class="p">(</span><span class="n">csv_writer</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Formats data stored in an SQLite database so that it can be browsed interactively.</span>
<span class="sd">       Use a program like Live Graph (www.www.live-graph.org) or KST (kst-plot.kde.org) to visualize data.&#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_name</span><span class="p">,</span> <span class="n">database_file</span><span class="o">=</span><span class="s">&#39;data_log.sqlite&#39;</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;name is the chart title.</span>
<span class="sd">        table_name is the database table containing selected data columns.</span>
<span class="sd">        database_file is the sqlite file containing table_name.&#39;&#39;&#39;</span>
        <span class="n">csv_writer</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table_name</span> <span class="o">=</span> <span class="n">table_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">database_file</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>
    <span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">None</span>
<div class="viewcode-block" id="sqlite_to_csv.add_timestamps"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_utils.html#PyICe.lab_instruments.sqlite_to_csv.add_timestamps">[docs]</a>    <span class="k">def</span> <span class="nf">add_timestamps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Add rowid and datetime columns to csv output.&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="s">&#39;rowid&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="s">&#39;datetime&#39;</span><span class="p">)</span></div>
    <span class="k">def</span> <span class="nf">_add_elapsed_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">display_name</span><span class="p">,</span><span class="n">format</span><span class="p">,</span><span class="n">transform</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&#39;SELECT strftime(&quot;</span><span class="si">%s</span><span class="s">&quot;,datetime) FROM {} LIMIT 1&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">table_name</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="n">query_name</span><span class="o">=</span><span class="s">&#39;strftime(&quot;</span><span class="si">%s</span><span class="s">&quot;,datetime) - {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]),</span><span class="n">display_name</span><span class="o">=</span><span class="n">display_name</span><span class="p">,</span><span class="n">format</span><span class="o">=</span><span class="n">format</span><span class="p">,</span><span class="n">transform</span><span class="o">=</span><span class="n">transform</span><span class="p">)</span>
<div class="viewcode-block" id="sqlite_to_csv.write"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_utils.html#PyICe.lab_instruments.sqlite_to_csv.write">[docs]</a>    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_file</span><span class="p">,</span> <span class="n">append</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s">&#39;utf-8&#39;</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;write previously selected column data to output_file.&#39;&#39;&#39;</span>
        <span class="n">query_txt</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">query_txt</span> <span class="o">+=</span> <span class="s">u&quot;{},&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">column</span><span class="o">.</span><span class="n">query_name</span><span class="p">)</span>
        <span class="n">query_txt</span> <span class="o">=</span> <span class="n">query_txt</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="s">&#39;a&#39;</span> <span class="k">if</span> <span class="n">append</span> <span class="k">else</span> <span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_format_header</span><span class="p">()</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">encoding</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&#39;SELECT {} FROM {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">query_txt</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">table_name</span><span class="p">)):</span>
                <span class="n">row_txt</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
                <span class="k">for</span> <span class="n">cidx</span><span class="p">,</span><span class="n">column</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
                    <span class="n">row_txt</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_output</span><span class="p">(</span><span class="n">column</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">cidx</span><span class="p">])</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">((</span><span class="n">row_txt</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">encoding</span><span class="p">))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">print</span> <span class="s">&#39;Output written to {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">output_file</span><span class="p">)</span>
</div></div>
<div class="viewcode-block" id="sqlite_to_easylog"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_utils.html#PyICe.lab_instruments.sqlite_to_easylog">[docs]</a><span class="k">class</span> <span class="nc">sqlite_to_easylog</span><span class="p">(</span><span class="n">sqlite_to_csv</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Wrapper to make specific format required by Easy Log Graph software.</span>
<span class="sd">       Formats data stored in an SQLite database so that it can be browsed inteactively.</span>
<span class="sd">       Use EasyLogGraph (http://www.lascarelectronics.com/data-logger/easylogger-software.php) to visualize data.&#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chart_name</span><span class="p">,</span> <span class="n">table_name</span><span class="p">,</span> <span class="n">y1_axis_units</span><span class="o">=</span><span class="s">&#39;V&#39;</span><span class="p">,</span> <span class="n">y2_axis_units</span><span class="o">=</span><span class="s">&#39;A&#39;</span><span class="p">,</span> <span class="n">database_file</span><span class="o">=</span><span class="s">&#39;data_log.sqlite&#39;</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;chart_name will appear at top of graph</span>
<span class="sd">        table_name is the sqlite database table name</span>
<span class="sd">        y1_axis_units controls the left-side y-axis label</span>
<span class="sd">        y2_axis_units controls the right-side y-axis label</span>
<span class="sd">        database_file is the filename of the sqlite database&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y1_axis_units</span> <span class="o">=</span> <span class="n">y1_axis_units</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y2_axis_units</span> <span class="o">=</span> <span class="n">y2_axis_units</span>
        <span class="n">sqlite_to_csv</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_name</span><span class="p">,</span> <span class="n">database_file</span><span class="p">)</span>
        <span class="n">sqlite_to_csv</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">query_name</span><span class="o">=</span><span class="s">&#39;rowid&#39;</span><span class="p">,</span><span class="n">display_name</span><span class="o">=</span><span class="n">chart_name</span><span class="p">)</span>
        <span class="n">sqlite_to_csv</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">query_name</span><span class="o">=</span><span class="s">&#39;datetime&#39;</span><span class="p">,</span><span class="n">display_name</span><span class="o">=</span><span class="s">&#39;Time&#39;</span><span class="p">)</span> <span class="c">#the position of these fields is important</span>
    <span class="k">def</span> <span class="nf">add_comment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;Comment lines don&#39;t seem to be allowed in EasyLog files.&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="sqlite_to_easylog.add_column"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_utils.html#PyICe.lab_instruments.sqlite_to_easylog.add_column">[docs]</a>    <span class="k">def</span> <span class="nf">add_column</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query_name</span><span class="p">,</span> <span class="n">second_y_axis</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">display_name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;query name is the name of the sqlite column</span>
<span class="sd">        second_y_axis is a boolean.  Setting to True places data on the right-side y-axis scale</span>
<span class="sd">        display_name, if not None, sets csv column header title differently from database column name</span>
<span class="sd">        format controls appearance of queried data. Ex: &quot;3.2f&quot;&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">display_name</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">display_name</span> <span class="o">=</span> <span class="n">query_name</span>
        <span class="n">display_name</span> <span class="o">=</span> <span class="s">&quot;{} ({})&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">display_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y2_axis_units</span> <span class="k">if</span> <span class="n">second_y_axis</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">y1_axis_units</span><span class="p">)</span> <span class="c">#Data goes to first or second y-axis based on parenthesized units in column heading</span>
        <span class="n">sqlite_to_csv</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">query_name</span><span class="o">=</span><span class="n">query_name</span><span class="p">,</span><span class="n">display_name</span><span class="o">=</span><span class="n">display_name</span><span class="p">,</span><span class="n">format</span><span class="o">=</span><span class="n">format</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">transform</span><span class="p">)</span></div>
<div class="viewcode-block" id="sqlite_to_easylog.add_columns"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_utils.html#PyICe.lab_instruments.sqlite_to_easylog.add_columns">[docs]</a>    <span class="k">def</span> <span class="nf">add_columns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">column_list</span><span class="p">,</span> <span class="n">second_y_axis</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;adds a list of sqlite column names at once</span>
<span class="sd">        all columns will be placed on left-side y-axis scale unless second_y_axis is True</span>
<span class="sd">        format controls appearance of queried data. Ex: &quot;3.2f&quot;</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">column_list</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="n">query_name</span><span class="o">=</span><span class="n">column</span><span class="p">,</span> <span class="n">second_y_axis</span><span class="o">=</span><span class="n">second_y_axis</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="n">format</span><span class="p">)</span>
    <span class="c"># def _add_elapsed_time(self, *args, **kwargs):</span>
        <span class="c"># raise Exception(&quot;Elapsed time not supported yet. Is it really needed?&quot;)</span></div>
<div class="viewcode-block" id="sqlite_to_easylog.write"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_utils.html#PyICe.lab_instruments.sqlite_to_easylog.write">[docs]</a>    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_file</span><span class="p">,</span> <span class="n">append</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;write queried data to output_file after column setup is complete&#39;&#39;&#39;</span>
        <span class="n">sqlite_to_csv</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_file</span><span class="o">=</span><span class="n">output_file</span><span class="p">,</span> <span class="n">append</span><span class="o">=</span><span class="n">append</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s">&#39;mbcs&#39;</span><span class="p">)</span> <span class="c">#windows ANSI codepage</span>
</div></div>
<div class="viewcode-block" id="sqlite_data"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_utils.html#PyICe.lab_instruments.sqlite_data">[docs]</a><span class="k">class</span> <span class="nc">sqlite_data</span><span class="p">(</span><span class="n">collections</span><span class="o">.</span><span class="n">Sequence</span><span class="p">):</span> <span class="c">#collections.Iterable to disable slicing?</span>
    <span class="sd">&#39;&#39;&#39;Produce iteratable object returning row sequence, where each column within each row is accessible by either column name or position.</span>
<span class="sd">    table_name can be an expression returning a synthetic non-table relation.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">database_file</span><span class="o">=</span><span class="s">&#39;data_log.sqlite&#39;</span><span class="p">,</span> <span class="n">timezone</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">timezone</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">timezone</span> <span class="o">=</span> <span class="n">UTC</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">timezone</span> <span class="o">=</span> <span class="n">timezone</span>
        <span class="n">sqlite3</span><span class="o">.</span><span class="n">register_converter</span><span class="p">(</span><span class="s">&quot;DATETIME&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert_timestring</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">database_file</span><span class="p">,</span> <span class="n">detect_types</span><span class="o">=</span><span class="n">sqlite3</span><span class="o">.</span><span class="n">PARSE_DECLTYPES</span><span class="p">)</span> <span class="c">#automatically convert datetime column to Python datetime object</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">row_factory</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">Row</span> <span class="c">#index row data tuple by column name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table_name</span> <span class="o">=</span> <span class="n">table_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sql_query</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">table_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sql_query</span> <span class="o">=</span> <span class="s">&quot;SELECT * from {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">table_name</span><span class="p">)</span> <span class="c">#remove rowid because it&#39;s now an explicitly stored column from the logger</span>
    <span class="k">def</span> <span class="nf">convert_timestring</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">time_string</span><span class="p">):</span>
        <span class="c"># return datetime.datetime.strptime(time_string,&#39;%Y-%m-%d %H:%M:%S&#39;).replace(tzinfo=UTC()).astimezone(self.timezone) #old format</span>
        <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">time_string</span><span class="p">,</span><span class="s">&#39;%Y-%m-</span><span class="si">%d</span><span class="s">T%H:%M:%S.</span><span class="si">%f</span><span class="s">Z&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="n">UTC</span><span class="p">())</span><span class="o">.</span><span class="n">astimezone</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timezone</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">key</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;implement sequence behavior.&#39;&#39;&#39;</span>
        <span class="n">subs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">slice</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">start</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">subs</span><span class="p">[</span><span class="s">&#39;start&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">subs</span><span class="p">[</span><span class="s">&#39;start&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">start</span> 
            <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">stop</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">subs</span><span class="p">[</span><span class="s">&#39;limit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="c">#no limit</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">subs</span><span class="p">[</span><span class="s">&#39;start&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">key</span><span class="o">.</span><span class="n">stop</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;Reverse iteration not supported.&#39;</span><span class="p">)</span>
                <span class="n">subs</span><span class="p">[</span><span class="s">&#39;limit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">stop</span> <span class="o">-</span> <span class="n">subs</span><span class="p">[</span><span class="s">&#39;start&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">step</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;Slice step not supported.&#39;</span><span class="p">)</span>
            <span class="n">fetch</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">Cursor</span><span class="o">.</span><span class="n">fetchall</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">subs</span><span class="p">[</span><span class="s">&#39;start&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">key</span>
            <span class="n">subs</span><span class="p">[</span><span class="s">&#39;limit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">fetch</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">Cursor</span><span class="o">.</span><span class="n">fetchone</span>
        <span class="k">return</span> <span class="n">fetch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sql_query</span> <span class="o">+</span> <span class="s">&quot; LIMIT {limit} OFFSET {start};&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">subs</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;implement iterable behavior.&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sql_query</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;return number of rows returned by sql query.</span>
<span class="sd">        WARNING: Inefficient.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c">#this is hard because the iterable doesn&#39;t actually know its length</span>
        <span class="c">#self.cursor.rowcount doesn&#39;t work; returns -1 when database isn&#39;t modified.</span>
        <span class="c">#not very efficient for big dataset!</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sql_query</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">())</span>
    <span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>
    <span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<div class="viewcode-block" id="sqlite_data.get_column_names"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_utils.html#PyICe.lab_instruments.sqlite_data.get_column_names">[docs]</a>    <span class="k">def</span> <span class="nf">get_column_names</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;return tuple of column names.</span>
<span class="sd">        Column names can be used for future queries or used to select column from query row results.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sql_query</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;table_name not specified&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sql_query</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span></div>
<div class="viewcode-block" id="sqlite_data.get_column_types"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_utils.html#PyICe.lab_instruments.sqlite_data.get_column_types">[docs]</a>    <span class="k">def</span> <span class="nf">get_column_types</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Return dictionary of data types stored in each column.</span>
<span class="sd">        Note that SQLite does not enforce types within a column, nor does the PyICe logger.</span>
<span class="sd">        The types of data stored in the first row will be returned, which may not match data stored elsewhere in the relation.</span>
<span class="sd">        Used by numpy array conversion to define data stride.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sql_query</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">([(</span><span class="n">k</span><span class="p">,</span><span class="nb">type</span><span class="p">(</span><span class="n">cursor</span><span class="p">[</span><span class="n">k</span><span class="p">]))</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">cursor</span><span class="o">.</span><span class="n">keys</span><span class="p">()])</span></div>
<div class="viewcode-block" id="sqlite_data.get_distinct"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_utils.html#PyICe.lab_instruments.sqlite_data.get_distinct">[docs]</a>    <span class="k">def</span> <span class="nf">get_distinct</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">column_name</span><span class="p">,</span> <span class="n">table_name</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;return one copy of each value (set) in specified column</span>
<span class="sd">        table_name can be an expression returning a synthetic non-table relation.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">table_name</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">table_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table_name</span>
            <span class="k">if</span> <span class="n">table_name</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;table_name not specified&#39;</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;SELECT DISTINCT {} from {};&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">column_name</span><span class="p">,</span> <span class="n">table_name</span><span class="p">))</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">data</span><span class="p">)[</span><span class="mi">0</span><span class="p">]))</span></div>
<div class="viewcode-block" id="sqlite_data.query"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_utils.html#PyICe.lab_instruments.sqlite_data.query">[docs]</a>    <span class="k">def</span> <span class="nf">query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sql_query</span><span class="p">,</span> <span class="o">*</span><span class="n">params</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;return iterable with query results.</span>
<span class="sd">        columns within each row can be accessed by column name or by position</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sql_query</span> <span class="o">=</span> <span class="n">sql_query</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">params</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sql_query</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">)</span></div>
<div class="viewcode-block" id="sqlite_data.zip"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_utils.html#PyICe.lab_instruments.sqlite_data.zip">[docs]</a>    <span class="k">def</span> <span class="nf">zip</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;return query data transposed into column_list of row_lists.&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="p">)</span></div>
<div class="viewcode-block" id="sqlite_data.csv"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_utils.html#PyICe.lab_instruments.sqlite_data.csv">[docs]</a>    <span class="k">def</span> <span class="nf">csv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_file</span><span class="p">,</span> <span class="n">elapsed_time_columns</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">append</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s">&#39;utf-8&#39;</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;write data to csv output_file.</span>
<span class="sd">        set output_file to None to just return csv string.&#39;&#39;&#39;</span>
        <span class="n">output_txt</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
        <span class="n">datetime_col</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">for</span> <span class="n">pos</span><span class="p">,</span><span class="n">column</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_column_names</span><span class="p">()):</span>
                <span class="n">output_txt</span> <span class="o">+=</span> <span class="s">&#39;{},&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">column</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">elapsed_time_columns</span> <span class="ow">and</span> <span class="n">column</span> <span class="o">==</span> <span class="s">&#39;datetime&#39;</span><span class="p">:</span>
                    <span class="n">output_txt</span> <span class="o">+=</span> <span class="s">&#39;elapsed_time,&#39;</span>
                    <span class="n">output_txt</span> <span class="o">+=</span> <span class="s">&#39;elapsed_seconds,&#39;</span>
                    <span class="n">datetime_col</span> <span class="o">=</span> <span class="n">pos</span>
        <span class="n">output_txt</span> <span class="o">=</span> <span class="s">&#39;{}</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">output_txt</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">pos</span><span class="p">,</span><span class="n">column</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
                <span class="n">output_txt</span> <span class="o">+=</span> <span class="s">&#39;{},&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">column</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">start_time</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">pos</span> <span class="o">==</span> <span class="n">datetime_col</span><span class="p">:</span>
                    <span class="n">start_time</span> <span class="o">=</span> <span class="n">column</span>
                <span class="k">if</span> <span class="n">elapsed_time_columns</span> <span class="ow">and</span> <span class="n">pos</span> <span class="o">==</span> <span class="n">datetime_col</span><span class="p">:</span>
                    <span class="n">output_txt</span> <span class="o">+=</span> <span class="s">&#39;{},&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">column</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span> <span class="c">#elapsed_time</span>
                    <span class="n">output_txt</span> <span class="o">+=</span> <span class="s">&#39;{},&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">((</span><span class="n">column</span><span class="o">-</span><span class="n">start_time</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">())</span> <span class="c">#elapsed_seconds</span>
            <span class="n">output_txt</span> <span class="o">=</span> <span class="s">&#39;{}</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">output_txt</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">output_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="s">&#39;a&#39;</span> <span class="k">if</span> <span class="n">append</span> <span class="k">else</span> <span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">output_txt</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">encoding</span><span class="p">))</span>
                <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">print</span> <span class="s">&#39;Output written to {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">output_file</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">output_txt</span></div>
<div class="viewcode-block" id="sqlite_data.xlsx"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_utils.html#PyICe.lab_instruments.sqlite_data.xlsx">[docs]</a>    <span class="k">def</span> <span class="nf">xlsx</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_file</span><span class="p">,</span> <span class="n">elapsed_time_columns</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;write data to excel output_file.&#39;&#39;&#39;</span>
        <span class="kn">import</span> <span class="nn">xlsxwriter</span>
        <span class="n">workbook</span> <span class="o">=</span> <span class="n">xlsxwriter</span><span class="o">.</span><span class="n">Workbook</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="p">{</span><span class="s">&#39;constant_memory&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
                                                     <span class="s">&#39;strings_to_formulas&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
                                                     <span class="s">&#39;strings_to_urls&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
                                                     <span class="s">&#39;strings_to_numbers&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
                                                    <span class="p">})</span>
        <span class="n">formats</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&#39;default&#39;</span>   <span class="p">:</span> <span class="n">workbook</span><span class="o">.</span><span class="n">add_format</span><span class="p">({</span><span class="s">&#39;font_name&#39;</span> <span class="p">:</span> <span class="s">&#39;Courier New&#39;</span><span class="p">,</span> <span class="s">&#39;font_size&#39;</span> <span class="p">:</span> <span class="mi">9</span><span class="p">}),</span>
                    <span class="s">&#39;date_time&#39;</span> <span class="p">:</span> <span class="n">workbook</span><span class="o">.</span><span class="n">add_format</span><span class="p">({</span><span class="s">&#39;num_format&#39;</span><span class="p">:</span> <span class="s">&#39;yyyy/mm/dd hh:mm:ss.000&#39;</span><span class="p">,</span> <span class="s">&#39;font_name&#39;</span> <span class="p">:</span> <span class="s">&#39;Courier New&#39;</span><span class="p">,</span> <span class="s">&#39;font_size&#39;</span> <span class="p">:</span> <span class="mi">9</span><span class="p">}),</span>
                    <span class="s">&#39;delta_time&#39;</span><span class="p">:</span> <span class="n">workbook</span><span class="o">.</span><span class="n">add_format</span><span class="p">({</span><span class="s">&#39;num_format&#39;</span><span class="p">:</span> <span class="s">&#39;hh:mm:ss.000&#39;</span><span class="p">,</span> <span class="s">&#39;font_name&#39;</span> <span class="p">:</span> <span class="s">&#39;Courier New&#39;</span><span class="p">,</span> <span class="s">&#39;font_size&#39;</span> <span class="p">:</span> <span class="mi">9</span><span class="p">}),</span>
                    <span class="s">&#39;row_shade&#39;</span><span class="p">:</span> <span class="n">workbook</span><span class="o">.</span><span class="n">add_format</span><span class="p">({</span><span class="s">&#39;bg_color&#39;</span><span class="p">:</span> <span class="s">&#39;#D0FFD0&#39;</span><span class="p">}),</span>
                  <span class="p">}</span>
        <span class="n">worksheet</span> <span class="o">=</span> <span class="n">workbook</span><span class="o">.</span><span class="n">add_worksheet</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">table_name</span><span class="p">)</span>
        <span class="n">column_width_pad</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">filter_button_width</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="n">row_idx</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">col_idx</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">datetime_col</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_column_names</span><span class="p">():</span>
            <span class="n">worksheet</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">row_idx</span><span class="p">,</span> <span class="n">col_idx</span><span class="p">,</span> <span class="n">column</span><span class="p">)</span>
            <span class="n">worksheet</span><span class="o">.</span><span class="n">set_column</span><span class="p">(</span><span class="n">col_idx</span><span class="p">,</span> <span class="n">col_idx</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">column</span><span class="p">)</span> <span class="o">*</span> <span class="n">column_width_pad</span> <span class="o">+</span> <span class="n">filter_button_width</span><span class="p">,</span> <span class="n">formats</span><span class="p">[</span><span class="s">&#39;default&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">column</span> <span class="o">==</span> <span class="s">&#39;datetime&#39;</span><span class="p">:</span>
                <span class="n">datetime_col</span> <span class="o">=</span> <span class="n">col_idx</span>
                <span class="k">if</span> <span class="n">elapsed_time_columns</span><span class="p">:</span>
                    <span class="n">worksheet</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">row_idx</span><span class="p">,</span> <span class="n">col_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&#39;elapsed_time&#39;</span><span class="p">)</span>
                    <span class="n">worksheet</span><span class="o">.</span><span class="n">set_column</span><span class="p">(</span><span class="n">col_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">col_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="s">&#39;elapsed_time&#39;</span><span class="p">)</span> <span class="o">*</span> <span class="n">column_width_pad</span> <span class="o">+</span> <span class="n">filter_button_width</span><span class="p">,</span> <span class="n">formats</span><span class="p">[</span><span class="s">&#39;default&#39;</span><span class="p">])</span>
                    <span class="n">worksheet</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">row_idx</span><span class="p">,</span> <span class="n">col_idx</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&#39;elapsed_seconds&#39;</span><span class="p">)</span>
                    <span class="n">worksheet</span><span class="o">.</span><span class="n">set_column</span><span class="p">(</span><span class="n">col_idx</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">col_idx</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="s">&#39;elapsed_seconds&#39;</span><span class="p">)</span> <span class="o">*</span> <span class="n">column_width_pad</span> <span class="o">+</span> <span class="n">filter_button_width</span><span class="p">,</span> <span class="n">formats</span><span class="p">[</span><span class="s">&#39;default&#39;</span><span class="p">])</span>
                    <span class="n">col_idx</span> <span class="o">+=</span> <span class="mi">2</span>
            <span class="n">col_idx</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">column_count</span> <span class="o">=</span> <span class="n">col_idx</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">worksheet</span><span class="o">.</span><span class="n">freeze_panes</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="c">#Keep header line at top</span>
        <span class="n">row_idx</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">col_idx</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">row</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">col_idx</span> <span class="o">==</span> <span class="n">datetime_col</span><span class="p">:</span>
                    <span class="n">worksheet</span><span class="o">.</span><span class="n">write_datetime</span><span class="p">(</span><span class="n">row_idx</span><span class="p">,</span> <span class="n">col_idx</span><span class="p">,</span> <span class="n">column</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="bp">None</span><span class="p">),</span> <span class="n">formats</span><span class="p">[</span><span class="s">&#39;date_time&#39;</span><span class="p">])</span> <span class="c">#Excel can&#39;t deal with timezone-aware datetimes. Output Zulu time.</span>
                    <span class="n">worksheet</span><span class="o">.</span><span class="n">set_column</span><span class="p">(</span><span class="n">col_idx</span><span class="p">,</span> <span class="n">col_idx</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">formats</span><span class="p">[</span><span class="s">&#39;date_time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">num_format</span><span class="p">)</span> <span class="o">*</span> <span class="n">column_width_pad</span><span class="p">,</span> <span class="n">worksheet</span><span class="o">.</span><span class="n">col_sizes</span><span class="p">[</span><span class="n">col_idx</span><span class="p">]))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">worksheet</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">row_idx</span><span class="p">,</span> <span class="n">col_idx</span><span class="p">,</span> <span class="n">column</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">worksheet</span><span class="o">.</span><span class="n">set_column</span><span class="p">(</span><span class="n">col_idx</span><span class="p">,</span> <span class="n">col_idx</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">column</span><span class="p">)</span> <span class="o">*</span> <span class="n">column_width_pad</span><span class="p">,</span> <span class="n">worksheet</span><span class="o">.</span><span class="n">col_sizes</span><span class="p">[</span><span class="n">col_idx</span><span class="p">]))</span>
                    <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                        <span class="k">pass</span> <span class="c">#numbers doesn&#39;t have length</span>
                <span class="k">if</span> <span class="n">start_time</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">col_idx</span> <span class="o">==</span> <span class="n">datetime_col</span><span class="p">:</span>
                    <span class="n">start_time</span> <span class="o">=</span> <span class="n">column</span>
                <span class="k">if</span> <span class="n">elapsed_time_columns</span> <span class="ow">and</span> <span class="n">col_idx</span> <span class="o">==</span> <span class="n">datetime_col</span><span class="p">:</span>
                    <span class="n">worksheet</span><span class="o">.</span><span class="n">write_datetime</span><span class="p">(</span><span class="n">row_idx</span><span class="p">,</span> <span class="n">col_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">column</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">,</span> <span class="n">formats</span><span class="p">[</span><span class="s">&#39;delta_time&#39;</span><span class="p">])</span> <span class="c">#elapsed_time</span>
                    <span class="n">worksheet</span><span class="o">.</span><span class="n">set_column</span><span class="p">(</span><span class="n">col_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">col_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">formats</span><span class="p">[</span><span class="s">&#39;delta_time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">num_format</span><span class="p">)</span> <span class="o">*</span> <span class="n">column_width_pad</span><span class="p">,</span> <span class="n">worksheet</span><span class="o">.</span><span class="n">col_sizes</span><span class="p">[</span><span class="n">col_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]))</span>
                    <span class="n">worksheet</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">row_idx</span><span class="p">,</span> <span class="n">col_idx</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="n">column</span><span class="o">-</span><span class="n">start_time</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">())</span> <span class="c">#elapsed_seconds</span>
                    <span class="n">col_idx</span> <span class="o">+=</span> <span class="mi">2</span>
                <span class="n">col_idx</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">row_idx</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">col_idx</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">worksheet</span><span class="o">.</span><span class="n">autofilter</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">row_idx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">column_count</span><span class="p">)</span>
        <span class="n">worksheet</span><span class="o">.</span><span class="n">conditional_format</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">row_idx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">column_count</span><span class="p">,</span> <span class="p">{</span><span class="s">&#39;type&#39;</span><span class="p">:</span> <span class="s">&#39;formula&#39;</span><span class="p">,</span>
                                                                       <span class="s">&#39;criteria&#39;</span><span class="p">:</span> <span class="s">&#39;=MOD(SUBTOTAL(3,$A$1:$A2),2)=0&#39;</span><span class="p">,</span>
                                                                       <span class="s">&#39;format&#39;</span><span class="p">:</span>   <span class="n">formats</span><span class="p">[</span><span class="s">&#39;row_shade&#39;</span><span class="p">]}</span>
                                    <span class="p">)</span>
        <span class="n">icon_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">__file__</span><span class="p">),</span> <span class="s">&quot;tssop.png&quot;</span><span class="p">)</span>
        <span class="n">worksheet</span><span class="o">.</span><span class="n">insert_image</span><span class="p">(</span><span class="n">row_idx</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">icon_path</span><span class="p">,</span> <span class="p">{</span><span class="s">&#39;y_offset&#39;</span><span class="p">:</span> <span class="mi">70</span><span class="p">})</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">io</span><span class="o">,</span> <span class="nn">urllib2</span>
            <span class="n">url</span> <span class="o">=</span> <span class="s">&#39;https://www.python.org/static/community_logos/python-powered-h-140x182.png&#39;</span>
            <span class="n">image_data</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">urllib2</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
            <span class="n">worksheet</span><span class="o">.</span><span class="n">insert_image</span><span class="p">(</span><span class="n">row_idx</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="p">{</span><span class="s">&#39;image_data&#39;</span><span class="p">:</span> <span class="n">image_data</span><span class="p">,</span>
                                                         <span class="s">&#39;x_scale&#39;</span><span class="p">:</span> <span class="mf">1.5</span><span class="p">,</span>
                                                         <span class="s">&#39;y_scale&#39;</span><span class="p">:</span> <span class="mf">1.5</span><span class="p">,</span>
                                                        <span class="p">})</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;INFO: Python logo insertion failed.&quot;</span>
            <span class="c">#print e</span>
        <span class="n">worksheet</span><span class="o">.</span><span class="n">protect</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s">&#39;sort&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
                               <span class="s">&#39;autofilter&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
                               <span class="s">&#39;format_cells&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
                               <span class="s">&#39;format_columns&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
                               <span class="s">&#39;format_rows&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
                              <span class="p">})</span>
        <span class="n">workbook</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">print</span> <span class="s">&#39;Output written to {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">output_file</span><span class="p">)</span></div>
<div class="viewcode-block" id="sqlite_data.to_list"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_utils.html#PyICe.lab_instruments.sqlite_data.to_list">[docs]</a>    <span class="k">def</span> <span class="nf">to_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;return copy of data in list object&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">row</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span></div>
<div class="viewcode-block" id="sqlite_data.numpy_recarray"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_utils.html#PyICe.lab_instruments.sqlite_data.numpy_recarray">[docs]</a>    <span class="k">def</span> <span class="nf">numpy_recarray</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">force_float_dtype</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">data_types</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;return NumPy record array containing data.</span>
<span class="sd">        Rows can be accessed by index, ex arr[2].</span>
<span class="sd">        Columns can be accessed by column name attribute, ex arr.vbat.</span>
<span class="sd">        Use with data filtering, smoothing, compressing, etc matrix operations provided by SciPy and lab_utils.transform, lab_utils.decimate.</span>
<span class="sd">        Use automaticic column names, but force data type to float with force_float_dtype boolean argument.</span>
<span class="sd">        Override automatic coulumn names and data types (first row) by specifying data_type iterable of (column_name,example_contents) for each column matching query order.</span>
<span class="sd">        http://docs.scipy.org/doc/numpy-1.10.1/reference/generated/numpy.recarray.html</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">force_float_dtype</span> <span class="ow">and</span> <span class="n">data_types</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">dtype</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">([(</span><span class="n">key</span><span class="p">,</span><span class="nb">type</span><span class="p">(</span><span class="nb">float</span><span class="p">()))</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_column_types</span><span class="p">()])</span>
        <span class="k">elif</span> <span class="n">force_float_dtype</span> <span class="ow">and</span> <span class="n">data_types</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;Specify only one of force_float_dtype, data_types arguments.&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">data_types</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">dtype</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">([(</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_column_types</span><span class="p">()</span><span class="o">.</span><span class="n">iteritems</span><span class="p">()])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dtype</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">([(</span><span class="n">column_name</span><span class="p">,</span><span class="nb">type</span><span class="p">(</span><span class="n">example_contents</span><span class="p">))</span> <span class="k">for</span> <span class="n">column_name</span><span class="p">,</span><span class="n">example_contents</span> <span class="ow">in</span> <span class="n">data_types</span><span class="p">])</span>
        <span class="n">arr</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">tuple</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">],</span> <span class="n">dtype</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">arr</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">recarray</span><span class="p">)</span></div>
<div class="viewcode-block" id="sqlite_data.column_query"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_utils.html#PyICe.lab_instruments.sqlite_data.column_query">[docs]</a>    <span class="k">def</span> <span class="nf">column_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">column_list</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;return partial query string separating column names with comma characters.&#39;&#39;&#39;</span>
        <span class="nb">str</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">column_list</span><span class="p">:</span>
            <span class="nb">str</span> <span class="o">+=</span> <span class="s">&#39;{},&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">column</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span></div>
<div class="viewcode-block" id="sqlite_data.time_delta_query"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_utils.html#PyICe.lab_instruments.sqlite_data.time_delta_query">[docs]</a>    <span class="k">def</span> <span class="nf">time_delta_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">time_div</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">column_name</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;return partial query string which will compute fractional delta seconds from first entry in the table as a column.</span>
<span class="sd">        Feed back into query to get elapsed time column.</span>
<span class="sd">        Ex &quot;SELECT rowid, {}, * FROM ...&quot;.format(sqlite_data_obj.time_delta_query())</span>
<span class="sd">        Use time_div to convert from second to your choice of time scales, example: time_div=3600 would be hours.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">column_name</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">time_div</span> <span class="o">==</span> <span class="mf">0.001</span><span class="p">:</span>
                <span class="n">column_name</span> <span class="o">=</span> <span class="s">&quot;elapsed_milliseconds&quot;</span>
            <span class="k">elif</span> <span class="n">time_div</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">column_name</span> <span class="o">=</span> <span class="s">&quot;elapsed_seconds&quot;</span>
            <span class="k">elif</span> <span class="n">time_div</span> <span class="o">==</span> <span class="mi">60</span><span class="p">:</span>
                <span class="n">column_name</span> <span class="o">=</span> <span class="s">&quot;elapsed_minutes&quot;</span>
            <span class="k">elif</span> <span class="n">time_div</span> <span class="o">==</span> <span class="mi">3600</span><span class="p">:</span>
                <span class="n">column_name</span> <span class="o">=</span> <span class="s">&quot;elapsed_hours&quot;</span>
            <span class="k">elif</span> <span class="n">time_div</span> <span class="o">==</span> <span class="mi">86400</span><span class="p">:</span>
                <span class="n">column_name</span> <span class="o">=</span> <span class="s">&quot;elapsed_days&quot;</span>
            <span class="k">elif</span> <span class="n">time_div</span> <span class="o">==</span> <span class="mi">31536000</span><span class="p">:</span>
                <span class="n">column_name</span> <span class="o">=</span> <span class="s">&quot;elapsed_years&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">column_name</span> <span class="o">=</span> <span class="s">&quot;elapsed_time&quot;</span>
        <span class="n">frac_s_str</span> <span class="o">=</span> <span class="s">&quot;strftime(&#39;</span><span class="si">%s</span><span class="s">&#39;,datetime)+strftime(&#39;</span><span class="si">%f</span><span class="s">&#39;,datetime)-strftime(&#39;%S&#39;,datetime)&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">table_name</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;table_name not specified&#39;</span><span class="p">)</span>
        <span class="n">first_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;SELECT {} FROM {} ORDER BY rowid ASC;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">frac_s_str</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">table_name</span><span class="p">))</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="s">&quot;({}-{})/{} AS {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">frac_s_str</span><span class="p">,</span><span class="n">first_time</span><span class="p">,</span><span class="n">time_div</span><span class="p">,</span><span class="n">column_name</span><span class="p">)</span></div>
<div class="viewcode-block" id="sqlite_data.filter_change"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_utils.html#PyICe.lab_instruments.sqlite_data.filter_change">[docs]</a>    <span class="k">def</span> <span class="nf">filter_change</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">column_name_list</span><span class="p">,</span> <span class="n">table_name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">first_row</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">preceding_row</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;return tuple of rowid values where any column in column_name_list changed value.</span>
<span class="sd">        result tuple can be fed into a new query(&quot;SELECT ... WHERE rowid in {}&quot;.format(sqlite_data_obj.filter_change())).</span>
<span class="sd">        it table_name is omitted, instance default will be used.</span>
<span class="sd">        setting preceding_row to True will also return the rowid before the change occurred.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">table_name</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">table_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table_name</span>
            <span class="k">if</span> <span class="n">table_name</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;table_name not specified&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">first_row</span><span class="p">:</span>
            <span class="n">first_row</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">first_row</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">()</span>
        <span class="n">sql_query</span> <span class="o">=</span> <span class="s">&#39;SELECT delay.rowid from {table_name} as orig JOIN {table_name} as delay ON orig.rowid = delay.rowid-1 WHERE &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">table_name</span><span class="o">=</span><span class="n">table_name</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">column_name</span> <span class="ow">in</span> <span class="n">column_name_list</span><span class="p">:</span>
            <span class="n">sql_query</span> <span class="o">+=</span> <span class="s">&#39;orig.{column_name} IS NOT delay.{column_name} OR &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">column_name</span><span class="o">=</span><span class="n">column_name</span><span class="p">)</span>
        <span class="n">sql_query</span> <span class="o">=</span> <span class="n">sql_query</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">row_ids</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql_query</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">IndexError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c">#no changes</span>
            <span class="k">return</span> <span class="n">first_row</span>
        <span class="k">if</span> <span class="n">preceding_row</span><span class="p">:</span>
            <span class="n">preceding_row_ids</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">row</span> <span class="o">-</span><span class="mi">1</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">row_ids</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">first_row</span> <span class="o">+</span> <span class="n">row_ids</span> <span class="o">+</span> <span class="n">preceding_row_ids</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">first_row</span> <span class="o">+</span> <span class="n">row_ids</span><span class="p">))</span></div>
<div class="viewcode-block" id="sqlite_data.optimize"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_utils.html#PyICe.lab_instruments.sqlite_data.optimize">[docs]</a>    <span class="k">def</span> <span class="nf">optimize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Defragment database file, reducing file size and speeding future queries.</span>
<span class="sd">        Also re-runs query plan optimizer to spped future queries.</span>
<span class="sd">        WARNING: May take a lot time to complete when operating on a large database.</span>
<span class="sd">        WARNING: May re-order rowid&#39;s</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;VACUUM;&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;ANALYZE;&quot;</span><span class="p">)</span></div>
<div class="viewcode-block" id="sqlite_data.expand_vector_data"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_utils.html#PyICe.lab_instruments.sqlite_data.expand_vector_data">[docs]</a>    <span class="k">def</span> <span class="nf">expand_vector_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">csv_filename</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">csv_append</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">csv_encoding</span><span class="o">=</span><span class="s">&#39;utf-8&#39;</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Expand vector list data (from oscilloscope, network analyzer, etc) to full row-rank.</span>
<span class="sd">        Scalar data will be expanded to vector length.</span>
<span class="sd">        Returns numpy record array.</span>
<span class="sd">        Optionally write output to comma separated file if csv_filname argument is specified.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">dtypes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">data_length</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">column_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_column_names</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">column_names</span><span class="p">:</span>
            <span class="n">columns</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">row</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="n">column</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;[&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">row</span><span class="p">[</span><span class="n">column</span><span class="p">]</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;]&#39;</span><span class="p">):</span>
                        <span class="n">column_data</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">row</span><span class="p">[</span><span class="n">column</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">&quot;[]&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;,&quot;</span><span class="p">)]</span>
                        <span class="k">if</span> <span class="n">data_length</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">column_data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">data_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">column_data</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">column_data</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">column_data</span><span class="p">)</span> <span class="o">!=</span> <span class="n">data_length</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;Inconsistent data length in vector expansion: {} and {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">columns</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span><span class="n">data_length</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">column_data</span> <span class="o">=</span> <span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="n">column</span><span class="p">]]</span>
                <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                    <span class="n">column_data</span> <span class="o">=</span> <span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="n">column</span><span class="p">]]</span>
                <span class="n">columns</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">column_data</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">data_length</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;WARNING: No vector data found.&quot;</span>
            <span class="n">data_length</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">column</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">columns</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">column</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">dtypes</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">column_names</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="nb">type</span><span class="p">(</span><span class="n">column</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dtypes</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">column_names</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="nb">float</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">rowcount</span><span class="p">,</span><span class="n">rowcoldata</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">column</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rowcoldata</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="c">#expand scalar data to vector length</span>
                    <span class="n">column</span><span class="p">[</span><span class="n">rowcount</span><span class="p">]</span> <span class="o">=</span> <span class="n">rowcoldata</span> <span class="o">*</span> <span class="n">data_length</span>
        <span class="c">#flatten row data</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">rowid</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rowcount</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">rowdata</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">columnid</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">rowdata</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">columns</span><span class="p">[</span><span class="n">columnid</span><span class="p">][</span><span class="n">rowid</span><span class="p">])</span>
            <span class="n">data</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">rowdata</span><span class="p">))</span>
        <span class="c">#csv output</span>
        <span class="k">if</span> <span class="n">csv_filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">csv_txt</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
            <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">column_names</span><span class="p">:</span>
                    <span class="n">csv_txt</span> <span class="o">+=</span> <span class="s">&#39;{},&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">column</span><span class="p">)</span>
            <span class="n">csv_txt</span> <span class="o">=</span> <span class="s">&#39;{}</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">csv_txt</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">row</span><span class="p">:</span>
                    <span class="n">csv_txt</span> <span class="o">+=</span> <span class="s">&#39;{},&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">column</span><span class="p">)</span>
                <span class="n">csv_txt</span> <span class="o">=</span> <span class="s">&#39;{}</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">csv_txt</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">csv_filename</span><span class="p">,</span> <span class="s">&#39;a&#39;</span> <span class="k">if</span> <span class="n">csv_append</span> <span class="k">else</span> <span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">csv_txt</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">csv_encoding</span><span class="p">))</span>
                <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">print</span> <span class="s">&#39;Output written to {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">csv_filename</span><span class="p">)</span>
        <span class="n">array</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtypes</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">array</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">recarray</span><span class="p">)</span>
</div></div>
<div class="viewcode-block" id="vector_transform"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_utils.html#PyICe.lab_instruments.vector_transform">[docs]</a><span class="k">def</span> <span class="nf">vector_transform</span><span class="p">(</span><span class="n">rec_array</span><span class="p">,</span> <span class="n">column_vector_functions</span><span class="p">,</span> <span class="n">column_names</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Generic filter function.</span>
<span class="sd">    column_vector_functions is a list of functions for each column and should have a length equal to the number of columns.</span>
<span class="sd">    To leave a column unchanged, set column vector function to None.</span>
<span class="sd">    Each column vector function will be applied to the whole column vector.</span>
<span class="sd">    Thus it is appropriate for 1-d filtering and decimation where access to values in adjacent columns is not required.</span>
<span class="sd">    column_names is a list of names for each column in the returned record array.</span>
<span class="sd">    To leave a column name unchanged from input record array, set column name to None.</span>
<span class="sd">    To leave all column names unchanged from input record array, set column_names to None.</span>
<span class="sd">    To smooth data, use something like scipy.signal.filtfilt and scipy.signal.butter for the column_vector_functions</span>
<span class="sd">    http://docs.scipy.org/doc/scipy/reference/generated/scipy.signal.filtfilt.html</span>
<span class="sd">    http://docs.scipy.org/doc/scipy-0.14.0/reference/generated/scipy.signal.butter.html</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">rec_array</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">column_vector_functions</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">column_names</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">column_names</span> <span class="o">=</span> <span class="p">[</span><span class="bp">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">column_vector_functions</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">column_vector_functions</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">column_names</span><span class="p">)</span>
    <span class="n">filt_cols</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">filt_names</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">column_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rec_array</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">column_vector_functions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">filt_cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">column_vector_functions</span><span class="p">[</span><span class="n">i</span><span class="p">](</span><span class="n">rec_array</span><span class="p">[</span><span class="n">column_name</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">filt_cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rec_array</span><span class="p">[</span><span class="n">column_name</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">column_names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">filt_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">column_names</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">filt_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">column_name</span><span class="p">)</span> <span class="c">#use old name</span>
    <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">records</span><span class="o">.</span><span class="n">fromarrays</span><span class="p">(</span><span class="n">filt_cols</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="n">filt_names</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="decimate"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_utils.html#PyICe.lab_instruments.decimate">[docs]</a><span class="k">def</span> <span class="nf">decimate</span><span class="p">(</span><span class="n">rec_array</span><span class="p">,</span> <span class="n">downsample_factor</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Reduce row count by factor of downsample_factor.</span>
<span class="sd">     By default an order 8 Chebyshev type I filter is used independently on each column.</span>
<span class="sd">     Set kwarg ftype=&#39;fir&#39; to instead use a 30 point FIR filter with hamming window (recommended).</span>
<span class="sd">     http://docs.scipy.org/doc/scipy-0.16.1/reference/generated/scipy.signal.decimate.html</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="n">vector_transform</span><span class="p">(</span><span class="n">rec_array</span><span class="p">,</span> <span class="p">[</span><span class="k">lambda</span> <span class="n">col</span><span class="p">:</span> <span class="n">scipy</span><span class="o">.</span><span class="n">signal</span><span class="o">.</span><span class="n">decimate</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">col</span><span class="p">,</span><span class="n">q</span><span class="o">=</span><span class="n">downsample_factor</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">rec_array</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">))</span>
    </div>
<div class="viewcode-block" id="ramer_douglas_peucker"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_utils.html#PyICe.lab_instruments.ramer_douglas_peucker">[docs]</a><span class="k">def</span> <span class="nf">ramer_douglas_peucker</span><span class="p">(</span><span class="n">rec_array</span><span class="p">,</span> <span class="n">epsilon</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;reduce number of points in line-sigment curve such that reduced line segment count approximates original curve within epsilon tolerance.</span>
<span class="sd">    https://en.wikipedia.org/wiki/Ramer%E2%80%93Douglas%E2%80%93Peucker_algorithm&#39;&#39;&#39;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">rdp</span> <span class="kn">import</span> <span class="n">rdp</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&quot;Install Ramer-Douglas-Peucker package.</span><span class="se">\n</span><span class="s">https://pypi.python.org/pypi/rdp&quot;</span>
        <span class="k">raise</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">column_type</span> <span class="o">=</span> <span class="s">&#39;float&#39;</span>
    <span class="c">#column_type = &#39;&lt;f8&#39;</span>
    <span class="n">old_dtype</span> <span class="o">=</span> <span class="n">rec_array</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">descr</span>
    <span class="n">new_dtype</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">([(</span><span class="n">column</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">column_type</span><span class="p">)</span> <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">old_dtype</span><span class="p">])</span>
    <span class="n">np_array</span> <span class="o">=</span> <span class="n">rec_array</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">new_dtype</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">column_type</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">reduced_array</span> <span class="o">=</span> <span class="n">rdp</span><span class="p">(</span><span class="n">np_array</span><span class="p">,</span> <span class="n">epsilon</span><span class="p">)</span>
    <span class="n">reduced_rec_array</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">fromiter</span><span class="p">(</span><span class="n">reduced_array</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">new_dtype</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">recarray</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="n">stop_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">print</span> <span class="s">&quot;RDP reduced {} data set from {} to {} points ({:3.1f}%) in {} seconds with epsilon={}.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">old_dtype</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="nb">len</span><span class="p">(</span><span class="n">rec_array</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">reduced_rec_array</span><span class="p">),</span><span class="mf">100.</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">reduced_rec_array</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">rec_array</span><span class="p">),</span><span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">((</span><span class="n">stop_time</span><span class="o">-</span><span class="n">start_time</span><span class="p">))),</span><span class="n">epsilon</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">reduced_rec_array</span>
</div>
<div class="viewcode-block" id="smooth_spline"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_utils.html#PyICe.lab_instruments.smooth_spline">[docs]</a><span class="k">def</span> <span class="nf">smooth_spline</span><span class="p">(</span><span class="n">rec_array</span><span class="p">,</span> <span class="n">rms_error</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;uses http://scipy.github.io/devdocs/generated/scipy.interpolate.UnivariateSpline.html with movable knots</span>
<span class="sd">    set rms_error to change number of knots to bound smoothed data rms deviation from original data points.</span>
<span class="sd">    rec_array is modified in place</span>
<span class="sd">    returns number of knots used to contstruct spline&#39;&#39;&#39;</span>
    <span class="n">point_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">rec_array</span><span class="p">)</span>
    <span class="n">rss</span> <span class="o">=</span> <span class="n">rms_error</span> <span class="o">*</span> <span class="n">point_count</span><span class="o">**</span><span class="mf">0.5</span>
    <span class="n">spl</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">interpolate</span><span class="o">.</span><span class="n">UnivariateSpline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">rec_array</span><span class="p">[</span><span class="n">rec_array</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span><span class="n">y</span><span class="o">=</span><span class="n">rec_array</span><span class="p">[</span><span class="n">rec_array</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span><span class="n">s</span><span class="o">=</span><span class="n">rss</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">knot_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">spl</span><span class="o">.</span><span class="n">get_knots</span><span class="p">())</span>
    <span class="n">first_x</span> <span class="o">=</span> <span class="n">rec_array</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">last_x</span> <span class="o">=</span> <span class="n">rec_array</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">new_x</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">first_x</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="n">last_x</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">point_count</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">type</span><span class="p">(</span><span class="nb">float</span><span class="p">()))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">point_count</span><span class="p">):</span> <span class="c">#replace old array in-place</span>
        <span class="n">rec_array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">new_x</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">spl</span><span class="p">(</span><span class="n">new_x</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&quot;rms_error {} constructed {} knots from {} original data points.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rms_error</span><span class="p">,</span> <span class="n">knot_count</span><span class="p">,</span> <span class="n">point_count</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">knot_count</span>
</div>
<div class="viewcode-block" id="smooth_filtfile"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_utils.html#PyICe.lab_instruments.smooth_filtfile">[docs]</a><span class="k">def</span> <span class="nf">smooth_filtfile</span><span class="p">(</span><span class="n">rec_array</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;somebody finish this.</span>
<span class="sd">    https://docs.scipy.org/doc/scipy-0.18.1/reference/generated/scipy.signal.filtfilt.html&#39;&#39;&#39;</span>
    </div>
<div class="viewcode-block" id="polyfit"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_utils.html#PyICe.lab_instruments.polyfit">[docs]</a><span class="k">def</span> <span class="nf">polyfit</span><span class="p">(</span><span class="n">rec_array</span><span class="p">,</span> <span class="n">degree</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;returns polynomial fit coefficients list, highest order first</span>
<span class="sd">    https://docs.scipy.org/doc/numpy/reference/generated/numpy.polyfit.html</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">rec_array</span><span class="p">[</span><span class="n">rec_array</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">y</span><span class="o">=</span><span class="n">rec_array</span><span class="p">[</span><span class="n">rec_array</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="n">deg</span><span class="o">=</span><span class="n">degree</span><span class="p">)</span>
    
</div>
<span class="k">def</span> <span class="nf">_detrend</span><span class="p">(</span><span class="n">rec_array</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;http://docs.scipy.org/doc/scipy/reference/generated/scipy.signal.detrend.html&#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="n">vector_transform</span><span class="p">(</span><span class="n">rec_array</span><span class="p">,</span> <span class="p">[</span><span class="bp">None</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">col</span><span class="p">:</span> <span class="n">scipy</span><span class="o">.</span><span class="n">signal</span><span class="o">.</span><span class="n">detrend</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">col</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)]</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rec_array</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>

<div class="viewcode-block" id="detrend_constant"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_utils.html#PyICe.lab_instruments.detrend_constant">[docs]</a><span class="k">def</span> <span class="nf">detrend_constant</span><span class="p">(</span><span class="n">rec_array</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Remove data mean from all columns except first one (assumed x-axis)</span>
<span class="sd">    http://docs.scipy.org/doc/scipy/reference/generated/scipy.signal.detrend.html</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="n">_detrend</span><span class="p">(</span><span class="n">rec_array</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s">&#39;constant&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="detrend_linear"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_utils.html#PyICe.lab_instruments.detrend_linear">[docs]</a><span class="k">def</span> <span class="nf">detrend_linear</span><span class="p">(</span><span class="n">rec_array</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Remove data mean from all columns except first one (assumed x-axis)</span>
<span class="sd">    http://docs.scipy.org/doc/scipy/reference/generated/scipy.signal.detrend.html</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="n">_detrend</span><span class="p">(</span><span class="n">rec_array</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s">&#39;linear&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="integral_nonlinearity"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_utils.html#PyICe.lab_instruments.integral_nonlinearity">[docs]</a><span class="k">def</span> <span class="nf">integral_nonlinearity</span><span class="p">(</span><span class="n">rec_array</span><span class="p">,</span> <span class="n">lsb_size</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;transform (code, voltage) data into INL</span>
<span class="sd">    optional lsb_size argument scales y-axis data from real units to lsb count.&#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="n">scalar_transform</span><span class="p">(</span><span class="n">detrend_linear</span><span class="p">(</span><span class="n">rec_array</span><span class="p">),</span> <span class="p">[</span><span class="bp">None</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">lsb_size</span><span class="p">)])</span>
</div>
<div class="viewcode-block" id="differential_nonlinearity"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_utils.html#PyICe.lab_instruments.differential_nonlinearity">[docs]</a><span class="k">def</span> <span class="nf">differential_nonlinearity</span><span class="p">(</span><span class="n">rec_array</span><span class="p">,</span> <span class="n">lsb_size</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;transform (code, voltage) data into DNL.</span>
<span class="sd">    optional lsb_size argument scales y-axis data from real units to lsb count.&#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="n">scalar_transform</span><span class="p">(</span><span class="n">vector_transform</span><span class="p">(</span><span class="n">rec_array</span><span class="p">,</span> <span class="p">[</span><span class="k">lambda</span> <span class="n">col</span><span class="p">:</span> <span class="n">col</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="k">lambda</span> <span class="n">col</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">col</span><span class="p">)]),</span> <span class="p">[</span><span class="bp">None</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">lsb_size</span><span class="p">)])</span>
</div>
<div class="viewcode-block" id="scalar_transform"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_utils.html#PyICe.lab_instruments.scalar_transform">[docs]</a><span class="k">def</span> <span class="nf">scalar_transform</span><span class="p">(</span><span class="n">rec_array</span><span class="p">,</span> <span class="n">column_scalar_functions</span><span class="p">,</span> <span class="n">column_names</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Transform column data by processing through user-supplied function</span>
<span class="sd">    column_scalar_functions is a list of functions for each column and should have a length equal to the number of columns.</span>
<span class="sd">    To leave a column unchanged, set column scalar function to None.</span>
<span class="sd">    The column scalar function will be applied to each point in the column individually.</span>
<span class="sd">    Thus it is appropriate for scaling, offseting changing data type, etc.</span>
<span class="sd">    This function cannot be used for filtering or convolution operations that need access to adjacent data points.</span>
<span class="sd">    Instead, use vector_transform().</span>
<span class="sd">    column_names is a list of names for each column in the returned record array.</span>
<span class="sd">    To leave a column name unchanged from input record array, set column name to None.</span>
<span class="sd">    To leave all column names unchanged from input record array, set column_names to None.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">column_vector_functions</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">csf</span> <span class="ow">in</span> <span class="n">column_scalar_functions</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">csf</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">column_vector_functions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">column_vector_functions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="k">lambda</span> <span class="n">column</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="n">csf</span><span class="p">:</span> <span class="p">[</span><span class="n">func</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">column</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">vector_transform</span><span class="p">(</span><span class="n">rec_array</span><span class="p">,</span> <span class="n">column_vector_functions</span><span class="p">,</span> <span class="n">column_names</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="US_Time_Zone"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_utils.html#PyICe.lab_instruments.US_Time_Zone">[docs]</a><span class="k">class</span> <span class="nc">US_Time_Zone</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">tzinfo</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Generic Timezone parent class.</span>
<span class="sd">    Implements methods required by datetime.tzinfo with US DST rules (second Sunday of March and first Sunday of November).</span>
<span class="sd">    Requires subclass to define local timezone parameters:</span>
<span class="sd">        self.tz_name</span>
<span class="sd">        self.tz_name_dst</span>
<span class="sd">        self.gmt_offset</span>
<span class="sd">        self.dst_offset</span>
<span class="sd">    &#39;&#39;&#39;</span>
<div class="viewcode-block" id="US_Time_Zone.first_sunday_on_or_after"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_utils.html#PyICe.lab_instruments.US_Time_Zone.first_sunday_on_or_after">[docs]</a>    <span class="k">def</span> <span class="nf">first_sunday_on_or_after</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dt</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;return date of first Sunday on or after dt.&#39;&#39;&#39;</span>
        <span class="n">days_to_go</span> <span class="o">=</span> <span class="mi">6</span> <span class="o">-</span> <span class="n">dt</span><span class="o">.</span><span class="n">weekday</span><span class="p">()</span>
        <span class="c">#if days_to_go:</span>
        <span class="n">dt</span> <span class="o">+=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days_to_go</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dt</span></div>
<div class="viewcode-block" id="US_Time_Zone.utcoffset"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_utils.html#PyICe.lab_instruments.US_Time_Zone.utcoffset">[docs]</a>    <span class="k">def</span> <span class="nf">utcoffset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;return DST aware offset from GMT/UTC based on calendar date.&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gmt_offset</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dst</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span></div>
<div class="viewcode-block" id="US_Time_Zone.dst"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_utils.html#PyICe.lab_instruments.US_Time_Zone.dst">[docs]</a>    <span class="k">def</span> <span class="nf">dst</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;return DST offset from standard local time based on calendar date.&#39;&#39;&#39;</span>
        <span class="c"># DST starts second Sunday in March</span>
        <span class="c"># ends first Sunday in November</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dston</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">first_sunday_on_or_after</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dstoff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">first_sunday_on_or_after</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dston</span> <span class="o">&lt;=</span> <span class="n">dt</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">dstoff</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dst_offset</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span></div>
<div class="viewcode-block" id="US_Time_Zone.tzname"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_utils.html#PyICe.lab_instruments.US_Time_Zone.tzname">[docs]</a>    <span class="k">def</span> <span class="nf">tzname</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dt</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;return DST aware local time zone name based on calendar date.&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dst</span><span class="p">(</span><span class="n">dt</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tz_name_dst</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tz_name</span></div></div>
<div class="viewcode-block" id="UTC"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_utils.html#PyICe.lab_instruments.UTC">[docs]</a><span class="k">class</span> <span class="nc">UTC</span><span class="p">(</span><span class="n">US_Time_Zone</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;UTC / GMT / Zulu time zone.&#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tz_name</span> <span class="o">=</span> <span class="s">&quot;UTC&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tz_name_dst</span> <span class="o">=</span> <span class="s">&quot;UTC&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gmt_offset</span> <span class="o">=</span> <span class="o">+</span><span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dst_offset</span> <span class="o">=</span> <span class="o">+</span><span class="mi">0</span></div>
<div class="viewcode-block" id="US_Eastern_Time"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_utils.html#PyICe.lab_instruments.US_Eastern_Time">[docs]</a><span class="k">class</span> <span class="nc">US_Eastern_Time</span><span class="p">(</span><span class="n">US_Time_Zone</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;US Eastern time zone. (NYC/BOS)&#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tz_name</span> <span class="o">=</span> <span class="s">&quot;EST&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tz_name_dst</span> <span class="o">=</span> <span class="s">&quot;EDT&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gmt_offset</span> <span class="o">=</span> <span class="o">-</span><span class="mi">5</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dst_offset</span> <span class="o">=</span> <span class="o">+</span><span class="mi">1</span></div>
<div class="viewcode-block" id="US_Pacific_Time"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_utils.html#PyICe.lab_instruments.US_Pacific_Time">[docs]</a><span class="k">class</span> <span class="nc">US_Pacific_Time</span><span class="p">(</span><span class="n">US_Time_Zone</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;US Pacific time zone. (LAX/SMF)&#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tz_name</span> <span class="o">=</span> <span class="s">&quot;PST&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tz_name_dst</span> <span class="o">=</span> <span class="s">&quot;PDT&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gmt_offset</span> <span class="o">=</span> <span class="o">-</span><span class="mi">8</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dst_offset</span> <span class="o">=</span> <span class="o">+</span><span class="mi">1</span>
</div>
<div class="viewcode-block" id="logger_time_str"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_utils.html#PyICe.lab_instruments.logger_time_str">[docs]</a><span class="k">def</span> <span class="nf">logger_time_str</span><span class="p">(</span><span class="n">datetime</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;return time string in same format as used by lab_core.logger.</span>
<span class="sd">    Requires timezone-aware datetime object argument to correctly convert to UTC times used by logger.</span>
<span class="sd">    if datetime object is naieve of timezone, add it with datetime.replace(tzinfo=lab_utils.US_Eastern_Time()) or datetime.replace(tzinfo=lab_utils.UTC())</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">astimezone</span><span class="p">(</span><span class="n">UTC</span><span class="p">())</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&#39;%Y-%m-</span><span class="si">%d</span><span class="s">T%H:%M:%S.</span><span class="si">%f</span><span class="s">Z&#39;</span><span class="p">)</span>
</div>
<span class="k">class</span> <span class="nc">dlog</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s">&quot;output.txt&quot;</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Open filehandle to filename.  If omitted, filename defaults to &quot;output.txt&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">errcnt</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="s">&#39;w&#39;</span><span class="p">)</span>
        <span class="c"># note the time.clock function won&#39;t work well for linux...</span>
        <span class="c"># this is written for windows</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timezero</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">clock</span><span class="p">()</span>
        <span class="c"># time/date stamp header </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_notime</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&quot;%a, </span><span class="si">%d</span><span class="s"> %b %Y %H:%M:%S&quot;</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>
    <span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">None</span>
    <span class="k">def</span> <span class="nf">log_notime</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">data</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Write data to file with trailing newline&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>        
    <span class="k">def</span> <span class="nf">log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">data</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Write data to file with timestamp and trailing newline&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_notime</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">clock</span><span class="p">()</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">timezero</span><span class="p">)</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">create_error</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;This function doesn&#39;t appear to actually do much.  self.errcnt is never written to the dlog.&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">errcnt</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">def</span> <span class="nf">finish</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Write final timestamp and close filehandle&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_notime</span><span class="p">(</span><span class="s">&quot;Data log closed at {}.  Elapsed time: {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&quot;%a, </span><span class="si">%d</span><span class="s"> %b %Y %H:%M:%S&quot;</span><span class="p">),</span> <span class="n">time</span><span class="o">.</span><span class="n">clock</span><span class="p">()</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">timezero</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<div class="viewcode-block" id="debug_log"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_utils.html#PyICe.lab_instruments.debug_log">[docs]</a><span class="k">class</span> <span class="nc">debug_log</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Log messages into a file and optionally print to screen.&#39;&#39;&#39;</span>
    <span class="c"># This class used in most of Frank&#39;s tests.</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">log_file_name</span><span class="o">=</span><span class="n">__name__</span><span class="o">+</span><span class="s">&quot;.log&quot;</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="o">=</span> <span class="n">debug</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">log_file_name</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fileno</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">fileno</span>
        <span class="c"># atexit.register(self.__del__)  # Tries to close the debug_log file if the program exits for any reason.</span>
    <span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>
    <span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">None</span>
<div class="viewcode-block" id="debug_log.write"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_utils.html#PyICe.lab_instruments.debug_log.write">[docs]</a>    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Add a message to the log file. Also print the message if debug is True&#39;&#39;&#39;</span>
        <span class="n">t_str</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">asctime</span><span class="p">()</span>
        <span class="n">m_str</span> <span class="o">=</span> <span class="s">&quot;{} :: {}</span><span class="se">\n</span><span class="s">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">t_str</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
            <span class="k">print</span> <span class="n">m_str</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">m_str</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        
    <span class="c"># def __del__(self):</span>
        <span class="c"># self.f.flush()</span>
        <span class="c"># os.fsync(self.fileno)</span>
        <span class="c"># self.f.close()</span>
</div></div>
<span class="k">class</span> <span class="nc">interpolator</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_points</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_points_ysort</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y_slope</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">def</span> <span class="nf">check_monotonicity</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_points</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">x_pts</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_points</span><span class="p">]</span>
            <span class="n">y_pts</span> <span class="o">=</span> <span class="p">[</span><span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_points</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">y_slope</span> <span class="o">=</span> <span class="nb">cmp</span><span class="p">(</span><span class="n">y_pts</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">y_pts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_points</span><span class="p">)):</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x_pts</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">x_pts</span><span class="p">)):</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;duplicated x column value&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_slope</span><span class="o">*</span><span class="n">y_pts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_slope</span><span class="o">*</span><span class="n">y_pts</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;y column values are not monotonically increasing or decreasing relative to x-column values at point ({},{})&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_points</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">_points</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">def</span> <span class="nf">sort</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_points</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">operator</span><span class="o">.</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="c">#increasing values in x</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_points_ysort</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_points</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">operator</span><span class="o">.</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="c">#increasing values in y</span>
    <span class="k">def</span> <span class="nf">add_point</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_val</span><span class="p">,</span> <span class="n">y_val</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_points</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">x_val</span><span class="p">,</span><span class="n">y_val</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_monotonicity</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">add_points</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">point_list</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;expects 2d list of the form [[x0,y0],[x1,y1],...[xn,yn]]</span>
<span class="sd">        the points must be strictly monotonic, but not necessarily sorted&#39;&#39;&#39;</span>
        <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="n">point_list</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_point</span><span class="p">(</span><span class="n">point</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">point</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">def</span> <span class="nf">find</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">sorted_key_list</span><span class="p">,</span> <span class="n">value_list</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;function operates independent of object internal data</span>
<span class="sd">        expects sorted_key_list to increase strictly monotonically</span>
<span class="sd">        will return linear combination of two values from value list weighted by distance from two enclosing points of key in sorted_key_list</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">points</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">sorted_key_list</span><span class="p">,</span> <span class="n">value_list</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">points</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;At least two points are required to define a line.&#39;</span><span class="p">)</span>
        <span class="n">low_pts</span> <span class="o">=</span> <span class="p">[</span><span class="n">pt</span> <span class="k">for</span> <span class="n">pt</span> <span class="ow">in</span> <span class="n">points</span> <span class="k">if</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">key</span><span class="p">]</span>
        <span class="n">high_pts</span> <span class="o">=</span> <span class="p">[</span><span class="n">pt</span> <span class="k">for</span> <span class="n">pt</span> <span class="ow">in</span> <span class="n">points</span> <span class="k">if</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">key</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">low_pts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c">#no points below value; extrapolate from first two points</span>
            <span class="c">#print &#39;Bottom extrapolation&#39;</span>
            <span class="n">low_pt</span> <span class="o">=</span> <span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">high_pt</span> <span class="o">=</span> <span class="n">points</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">high_pts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c">#no points above value; extrapolate from last two points</span>
            <span class="c">#print &#39;Top extrapolation&#39;</span>
            <span class="n">low_pt</span> <span class="o">=</span> <span class="n">points</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">high_pt</span> <span class="o">=</span> <span class="n">points</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c">#interpolate between points lower and higher than key argument</span>
            <span class="c">#print &#39;Interpolation&#39;</span>
            <span class="n">low_pt</span> <span class="o">=</span> <span class="n">low_pts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">high_pt</span> <span class="o">=</span> <span class="n">high_pts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">low_pt</span> <span class="o">==</span> <span class="n">high_pt</span><span class="p">:</span>
            <span class="c">#avoid divide by 0</span>
            <span class="k">return</span> <span class="n">low_pt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">low_pt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">key</span><span class="o">-</span><span class="n">low_pt</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">high_pt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">low_pt</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">high_pt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">low_pt</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="c">#prevent integer divide</span>
    <span class="k">def</span> <span class="nf">get_x_val</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y_val</span><span class="p">):</span>
        <span class="p">[</span><span class="n">x_pts</span><span class="p">,</span><span class="n">y_pts</span><span class="p">]</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_points_ysort</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">y_val</span><span class="p">,</span> <span class="n">y_pts</span><span class="p">,</span> <span class="n">x_pts</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">get_y_val</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_val</span><span class="p">):</span>
        <span class="p">[</span><span class="n">x_pts</span><span class="p">,</span><span class="n">y_pts</span><span class="p">]</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_points</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">x_val</span><span class="p">,</span> <span class="n">x_pts</span><span class="p">,</span> <span class="n">y_pts</span><span class="p">)</span>

<div class="viewcode-block" id="eng_string"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_utils.html#PyICe.lab_instruments.eng_string">[docs]</a><span class="k">def</span> <span class="nf">eng_string</span><span class="p">(</span> <span class="n">x</span><span class="p">,</span> <span class="n">fmt</span> <span class="o">=</span> <span class="s">&#39;:.3g&#39;</span><span class="p">,</span> <span class="n">si</span> <span class="o">=</span> <span class="bp">True</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Returns float/int value &lt;x&gt; formatted in a simplified engineering format -</span>
<span class="sd">    using an exponent that is a multiple of 3.</span>

<span class="sd">    format: printf-style string used to format the value before the exponent.</span>

<span class="sd">    si: if true, use SI suffix for exponent, e.g. k instead of e3, n instead of</span>
<span class="sd">    e-9 etc.</span>

<span class="sd">    E.g. with format=&#39;%.2f&#39;:</span>
<span class="sd">        1.23e-08 =&gt; 12.30e-9</span>
<span class="sd">             123 =&gt; 123.00</span>
<span class="sd">          1230.0 =&gt; 1.23e3</span>
<span class="sd">      -1230000.0 =&gt; -1.23e6</span>

<span class="sd">    and with si=True:</span>
<span class="sd">          1230.0 =&gt; 1.23k</span>
<span class="sd">      -1230000.0 =&gt; -1.23M</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">numbers</span><span class="o">.</span><span class="n">Number</span><span class="p">)</span>
    <span class="c">#why is this here? in case x is a string? if so, int(&#39;5e3&#39;) won&#39;t work</span>
    <span class="c">#if int(x) != float(x):</span>
    <span class="c">#    x = float(x)</span>
    <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="s">&#39;{{{}}}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fmt</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">sign</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
    <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="o">-</span><span class="n">x</span>
        <span class="n">sign</span> <span class="o">=</span> <span class="s">&#39;-&#39;</span>
    <span class="n">exp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span> <span class="n">math</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span> <span class="n">x</span><span class="p">)))</span>
    <span class="n">exp3</span> <span class="o">=</span> <span class="n">exp</span> <span class="o">-</span> <span class="p">(</span> <span class="n">exp</span> <span class="o">%</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">x3</span> <span class="o">=</span> <span class="n">x</span> <span class="o">/</span> <span class="p">(</span> <span class="mi">10</span> <span class="o">**</span> <span class="n">exp3</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">si</span> <span class="ow">and</span> <span class="n">exp3</span> <span class="o">&gt;=</span> <span class="o">-</span><span class="mi">24</span> <span class="ow">and</span> <span class="n">exp3</span> <span class="o">&lt;=</span> <span class="mi">24</span> <span class="ow">and</span> <span class="n">exp3</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">exp3_text</span> <span class="o">=</span> <span class="s">u&#39;yzafpnm kMGTPEZY&#39;</span><span class="p">[</span> <span class="p">(</span> <span class="n">exp3</span> <span class="o">-</span> <span class="p">(</span><span class="o">-</span><span class="mi">24</span><span class="p">))</span> <span class="o">/</span> <span class="mi">3</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">exp3</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">exp3_text</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">exp3_text</span> <span class="o">=</span> <span class="s">&#39;e</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">exp3</span>
    <span class="n">s1</span> <span class="o">=</span> <span class="s">&quot;{}{{{}}}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sign</span><span class="p">,</span><span class="n">fmt</span><span class="p">)</span>
    <span class="n">s2</span> <span class="o">=</span> <span class="n">s1</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="n">x3</span> <span class="p">)</span>
    <span class="k">return</span> <span class="s">u&quot;{}{}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">s2</span><span class="p">,</span><span class="n">exp3_text</span><span class="p">)</span>
</div>
<span class="k">class</span> <span class="nc">ordered_pair</span><span class="p">(</span><span class="nb">list</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_transform</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">y_transform</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;executes x_transform function on first (x) element of each ordered pair data point</span>
<span class="sd">           executes y_transform function on second (y) element of each ordered pair data point</span>
<span class="sd">           returns None, data changed in place</span>
<span class="sd">           not appropriate for filtering functions that require access to adjacent (in time or space) data point values&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">x_transform</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">x_transform</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span>
        <span class="k">if</span> <span class="n">y_transform</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">y_transform</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">y</span><span class="p">:</span> <span class="n">y</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)):</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">x_transform</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span> <span class="n">y_transform</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">])]</span>
    <span class="k">def</span> <span class="nf">x_sql_time</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;convert sqlite database datetime string in x-axis data to python datetime object&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">x_transform</span><span class="o">=</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="s">&#39;%Y-%m-</span><span class="si">%d</span><span class="s">T%H:%M:%S.</span><span class="si">%f</span><span class="s">Z&#39;</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">x_sql_elapsed_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seconds</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">minutes</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">hours</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">days</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;convert sqlite database datetime string in x-axis data to python timedelta object</span>
<span class="sd">        access properties of days, seconds (0 to 86399 inclusive) and microseconds (0 to 999999 inclusive) or method total_seconds()</span>
<span class="sd">        optionally, instead return numeric total seconds, minutes, hours or days by setting respective argument to True&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x_sql_time</span><span class="p">()</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">x_transform</span><span class="o">=</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">t</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">seconds</span> <span class="ow">or</span> <span class="n">minutes</span> <span class="ow">or</span> <span class="n">hours</span> <span class="ow">or</span> <span class="n">days</span><span class="p">):</span>
            <span class="k">pass</span>
        <span class="k">elif</span> <span class="n">seconds</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="n">minutes</span> <span class="ow">or</span> <span class="n">hours</span> <span class="ow">or</span> <span class="n">days</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">x_transform</span><span class="o">=</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">())</span>
        <span class="k">elif</span> <span class="n">minutes</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="n">seconds</span> <span class="ow">or</span> <span class="n">hours</span> <span class="ow">or</span> <span class="n">days</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">x_transform</span><span class="o">=</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">/</span> <span class="mf">60.0</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">hours</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="n">seconds</span> <span class="ow">or</span> <span class="n">minutes</span> <span class="ow">or</span> <span class="n">days</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">x_transform</span><span class="o">=</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">/</span> <span class="mf">3600.0</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">days</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="n">seconds</span> <span class="ow">or</span> <span class="n">minutes</span> <span class="ow">or</span> <span class="n">hours</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">x_transform</span><span class="o">=</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">/</span> <span class="mf">86400.0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;Specify at most one of (seconds, minutes, hours, days)&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">xscale</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_scale</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;changes list in place with x points multiplied by x_scale and y points unaltered&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">x_transform</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">*</span> <span class="n">x_scale</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">yscale</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y_scale</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;changes list in place with x points unaltered and y points multiplied by y_scale&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">y_transform</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">y</span><span class="p">:</span> <span class="n">y</span> <span class="o">*</span> <span class="n">y_scale</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">xoffset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_offset</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">x_transform</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">+</span> <span class="n">x_offset</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">yoffset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y_offset</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">y_transform</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">y</span><span class="p">:</span> <span class="n">y</span> <span class="o">+</span> <span class="n">y_offset</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">xyscale</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_scale</span><span class="p">,</span> <span class="n">y_scale</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;changes list in place with x points multiplied by x_scale and y points multiplied by y_scale&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">x_transform</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">*</span><span class="n">x_scale</span><span class="p">,</span> <span class="n">y_transform</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">y</span><span class="p">:</span> <span class="n">y</span><span class="o">*</span><span class="n">y_scale</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">truncate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">orig_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">del</span> <span class="bp">self</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">offset</span><span class="p">]</span> <span class="c">#offset or offset+1?</span>
        <span class="k">if</span> <span class="n">length</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">elif</span> <span class="n">length</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">length</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">new_len</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">length</span><span class="o">*</span><span class="n">orig_len</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">new_len</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;Record too short after offset to return {}</span><span class="si">% o</span><span class="s">f original length.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">length</span><span class="o">*</span><span class="mi">100</span><span class="p">))</span>
            <span class="k">del</span> <span class="bp">self</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">length</span><span class="o">*</span><span class="n">orig_len</span><span class="p">)):</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)]</span> <span class="c">#percentage of orignial data?</span>
            <span class="c">#xydata = xydata[:int(round(length*len(xydata)))] #percentage of offset data?</span>
            <span class="k">print</span> <span class="s">&#39;Truncating record from {} to {} points starting at {}.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">orig_len</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">length</span><span class="o">*</span><span class="n">orig_len</span><span class="p">)),</span><span class="n">offset</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">length</span> <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">int</span><span class="p">(</span><span class="n">length</span><span class="p">)</span> <span class="o">==</span> <span class="n">length</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="p">[</span><span class="n">length</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)]</span>
            <span class="k">print</span> <span class="s">&#39;Truncating record from {} to {} points starting at {}.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">orig_len</span><span class="p">,</span><span class="n">length</span><span class="p">,</span><span class="n">offset</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;length argument should be 0-1 percentage of original record length or integer desired record length.&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">decimate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scale</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">scale</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="k">assert</span> <span class="n">scale</span> <span class="o">&lt;=</span> <span class="mi">1</span>
        <span class="n">old_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">new_len</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">scale</span><span class="o">*</span><span class="n">old_len</span><span class="p">))</span> 
        <span class="k">print</span> <span class="s">&#39;Decimating record from {} to {} points.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span><span class="n">new_len</span><span class="p">)</span>
        <span class="n">accumulator</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">decimated_data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">incr</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="mf">1.0</span><span class="o">*</span><span class="n">new_len</span><span class="o">/</span><span class="n">old_len</span><span class="p">)</span>
        <span class="n">del_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)):</span>
            <span class="n">accumulator</span> <span class="o">+=</span> <span class="n">incr</span>
            <span class="k">if</span> <span class="n">accumulator</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c"># print &#39;dropping point {}:{}&#39;.format(i,self[i])</span>
                <span class="n">accumulator</span> <span class="o">-=</span> <span class="mi">1</span>
                <span class="n">del_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="c">#don&#39;t change list length while iterating it</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">del_list</span><span class="p">):</span>
            <span class="k">del</span> <span class="bp">self</span><span class="p">[</span><span class="n">del_list</span><span class="o">.</span><span class="n">pop</span><span class="p">()]</span>
    <span class="k">def</span> <span class="nf">numpy_recarray</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">force_float_dtype</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">data_types</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;return NumPy record array containing data.</span>
<span class="sd">        Rows can be accessed by index, ex arr[2].</span>
<span class="sd">        Columns can be accessed by column name attribute, ex arr.vbat.</span>
<span class="sd">        Use with data filtering, smoothing, compressing, etc matrix operations provided by SciPy and lab_utils.transform, lab_utils.decimate.</span>
<span class="sd">        Use automaticic column names, but force data type to float with force_float_dtype boolean argument.</span>
<span class="sd">        Override automatic coulumn names and data types (first row) by specifying data_type iterable of (column_name,example_contents) for each column matching query order.</span>
<span class="sd">        http://docs.scipy.org/doc/numpy-1.10.1/reference/generated/numpy.recarray.html</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">force_float_dtype</span> <span class="ow">and</span> <span class="n">data_types</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">dtype</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">([(</span><span class="s">&#39;x&#39;</span><span class="p">,</span><span class="nb">type</span><span class="p">(</span><span class="nb">float</span><span class="p">())),</span> <span class="p">(</span><span class="s">&#39;y&#39;</span><span class="p">,</span><span class="nb">type</span><span class="p">(</span><span class="nb">float</span><span class="p">()))])</span>
        <span class="k">elif</span> <span class="n">force_float_dtype</span> <span class="ow">and</span> <span class="n">data_types</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;Specify only one of force_float_dtype, data_types arguments.&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">data_types</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">dtype</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">([(</span><span class="s">&#39;x&#39;</span><span class="p">,</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])),</span> <span class="p">(</span><span class="s">&#39;x&#39;</span><span class="p">,</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]))])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dtype</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">([(</span><span class="n">column_name</span><span class="p">,</span><span class="nb">type</span><span class="p">(</span><span class="n">example_contents</span><span class="p">))</span> <span class="k">for</span> <span class="n">column_name</span><span class="p">,</span><span class="n">example_contents</span> <span class="ow">in</span> <span class="n">data_types</span><span class="p">])</span>
        <span class="n">arr</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">tuple</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">],</span> <span class="n">dtype</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">arr</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">recarray</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">ramer_douglas_peucker</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epsilon</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">force_float_dtype</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">data_types</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;reduce number of points in line-sigment curve such that reduced line segment count approximates original curve within epsilon tolerance.</span>
<span class="sd">        https://en.wikipedia.org/wiki/Ramer%E2%80%93Douglas%E2%80%93Peucker_algorithm&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="n">ramer_douglas_peucker</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">numpy_recarray</span><span class="p">(</span><span class="n">force_float_dtype</span><span class="p">,</span> <span class="n">data_types</span><span class="p">),</span> <span class="n">epsilon</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_smooth</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axis</span><span class="p">,</span> <span class="n">window</span><span class="p">,</span> <span class="n">extrapolation_window</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">window</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">window</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">window</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">window</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">window</span><span class="o">%</span><span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&#39;*** WARNING ***&#39;</span>
            <span class="k">print</span> <span class="s">&quot;Even window sizes like {} have a missing centroid and will slide the data downward using this smoothing function.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">window</span><span class="p">))</span>
            <span class="k">print</span> <span class="s">&quot;I&#39;m incrementing the window by one to {} to correct for this.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">window</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">window</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">axis</span> <span class="o">==</span> <span class="s">&#39;y&#39;</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">y</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">y</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">spacing</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="c"># fit_lower and fit_upper are linear extrapolations off the left and right sides using the extrapolation_window</span>
        <span class="n">fit_lower</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">poly1d</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:</span><span class="n">extrapolation_window</span><span class="p">],</span> <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="p">[:</span><span class="n">extrapolation_window</span><span class="p">],</span> <span class="n">deg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">fit_upper</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">poly1d</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="n">extrapolation_window</span><span class="p">:],</span> <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="n">extrapolation_window</span><span class="p">:],</span> <span class="n">deg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">xpoints_lo</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">spacing</span> <span class="o">*</span> <span class="p">(</span><span class="n">points</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">points</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">window</span><span class="p">)])</span>
        <span class="n">xpoints_hi</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">spacing</span> <span class="o">*</span> <span class="p">(</span><span class="n">points</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">points</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">window</span><span class="p">)])</span>
        <span class="n">values_lo</span> <span class="o">=</span> <span class="p">[</span><span class="n">fit_lower</span><span class="p">(</span><span class="n">point</span><span class="p">)</span> <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="n">xpoints_lo</span><span class="p">]</span>
        <span class="n">values_hi</span> <span class="o">=</span> <span class="p">[</span><span class="n">fit_upper</span><span class="p">(</span><span class="n">point</span><span class="p">)</span> <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="n">xpoints_hi</span><span class="p">]</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">values_lo</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">+</span> <span class="n">values_hi</span>                                  <span class="c"># Extend data end points left/right</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">window</span><span class="p">)</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">window</span><span class="p">),</span> <span class="s">&#39;same&#39;</span><span class="p">)</span>         <span class="c"># to assist running average algorithm</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>                                            <span class="c"># Convert array back to list</span>
        <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">window</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>                                                     <span class="c"># Strip off left padding</span>
        <span class="n">data</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">-</span><span class="n">window</span><span class="p">:]</span> <span class="o">=</span> <span class="p">[]</span>                                            <span class="c"># Strip off right padding</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">axis</span> <span class="o">==</span> <span class="s">&#39;y&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
    <span class="k">def</span> <span class="nf">smooth_y</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">window</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="n">extrapolation_window</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">iterations</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Smooths a data set&#39;s y axis data for publication.</span>
<span class="sd">        &#39;window&#39; is the size of the main filtering window.</span>
<span class="sd">            The data is convolved with a block of &#39;1s&#39;.</span>
<span class="sd">            The length of the block determines the aggressiveness of the filtering.</span>
<span class="sd">            A large window size is like having a low frequency pole.</span>
<span class="sd">            The larger it is the more distortion there will be.</span>
<span class="sd">        &#39;extrapolation_window&#39; is the size of the window used to determine the line for linear extrapolation off the ends of the data set.</span>
<span class="sd">            The data needs to be extended so the convolution doesn&#39;t run out of data on the ends.</span>
<span class="sd">            The default extrapolation window is set to the main window but can be reduced to reduce distortion or more properly model the end point derivatives.</span>
<span class="sd">        &#39;iterations&#39; is the number of iterations the smoothing function runs.</span>
<span class="sd">            Increasing the iterations is like having more poles at the same frequency thereby producing essentially a &#39;brick wall&#39; filter.</span>
<span class="sd">            *****************</span>
<span class="sd">            **** WARNING ****</span>
<span class="sd">            *****************</span>
<span class="sd">            Iterations should be used judiciously as it can lead to large phase shifting which moves the data a great distance on the independent axis.</span>
<span class="sd">            It&#39;s a good idea to always plot the original data and the massaged data together to ensure that the massaged data has not been seriously distorted.&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">extrapolation_window</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">extrapolation_window</span> <span class="o">=</span> <span class="n">window</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">iterations</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_smooth</span><span class="p">(</span><span class="n">axis</span> <span class="o">=</span> <span class="s">&#39;y&#39;</span><span class="p">,</span> <span class="n">window</span> <span class="o">=</span> <span class="n">window</span><span class="p">,</span> <span class="n">extrapolation_window</span> <span class="o">=</span> <span class="n">extrapolation_window</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">smooth_x</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">window</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="n">extrapolation_window</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">iterations</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Smooths a data set&#39;s x axis data for publication.</span>
<span class="sd">        &#39;window&#39; is the size of the main filtering window.</span>
<span class="sd">            The data is convolved with a block of &#39;1s&#39;.</span>
<span class="sd">            The length of the block determines the aggressiveness of the filtering.</span>
<span class="sd">            A large window size is like having a low frequency pole.</span>
<span class="sd">            The larger it is the more distortion there will be.</span>
<span class="sd">        &#39;extrapolation_window&#39; is the size of the window used to determine the line for linear extrapolation off the ends of the data set.</span>
<span class="sd">            The data needs to be extended so the convolution doesn&#39;t run out of data on the ends.</span>
<span class="sd">            The default extrapolation window is set to the main window but can be reduced to reduce distortion or more properly model the end point derivatives.</span>
<span class="sd">        &#39;iterations&#39; is the number of iterations the smoothing function runs.</span>
<span class="sd">            Increasing the iterations is like having more poles at the same frequency thereby producing essentially a &#39;brick wall&#39; filter.</span>
<span class="sd">            *****************</span>
<span class="sd">            **** WARNING ****</span>
<span class="sd">            *****************</span>
<span class="sd">            Iterations should be used judiciously as it can lead to large phase shifting which moves the data a great distance on the independent axis.</span>
<span class="sd">            It&#39;s a good idea to always plot the original data and the massaged data together to ensure that the massaged data has not been seriously distorted.&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">extrapolation_window</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">extrapolation_window</span> <span class="o">=</span> <span class="n">window</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">iterations</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_smooth</span><span class="p">(</span><span class="n">axis</span> <span class="o">=</span> <span class="s">&#39;x&#39;</span><span class="p">,</span> <span class="n">window</span> <span class="o">=</span> <span class="n">window</span><span class="p">,</span> <span class="n">extrapolation_window</span> <span class="o">=</span> <span class="n">extrapolation_window</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">oscilloscope_channel</span><span class="p">(</span><span class="n">ordered_pair</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">time_points</span><span class="p">,</span> <span class="n">channel_data</span><span class="p">):</span>
        <span class="nb">list</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="sd">&#39;&#39;&#39;takes string data, likely from a two-column sql database query of an oscilloscope trace</span>
<span class="sd">       and returns a list of (x,y) ordered pairs of floats appropriate for plotting or further manipulation</span>
<span class="sd">       expects time and channel series data to be surrounded with square braces and comma separated</span>
<span class="sd">       time_points and channel_data should be of equal length&#39;&#39;&#39;</span>
        <span class="n">xvalues</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">time_points</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">&quot;[]&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;,&quot;</span><span class="p">)]</span>
        <span class="n">yvalues</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">channel_data</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">&quot;[]&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;,&quot;</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">xvalues</span><span class="p">,</span> <span class="n">yvalues</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">array</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">xvalues</span><span class="p">,</span> <span class="n">yvalues</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="p">[(</span><span class="s">&#39;x&#39;</span><span class="p">,</span> <span class="nb">float</span><span class="p">),</span> <span class="p">(</span><span class="s">&#39;y&#39;</span><span class="p">,</span> <span class="nb">float</span><span class="p">)])</span>
    <span class="k">def</span> <span class="nf">to_recarray</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">recarray</span><span class="p">)</span>

<div class="viewcode-block" id="egg_timer"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_utils.html#PyICe.lab_instruments.egg_timer">[docs]</a><span class="k">def</span> <span class="nf">egg_timer</span><span class="p">(</span><span class="n">timeout</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">display_callback</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Provides a blocking delay with a graphic to indicate progress so far so the computer doesn&#39;t look idle</span>
<span class="sd">    optionally, display a message on the line above the timer graphic</span>
<span class="sd">    optionally, specify a display_callback function to insert extra progress information after the timer display.</span>
<span class="sd">    display_callback function should accept a single dictionary argument and return a string.&#39;&#39;&#39;</span>
    <span class="n">light_shade</span> <span class="o">=</span> <span class="s">u&quot;&quot;</span> <span class="c">#\u2592</span>
    <span class="n">dark_shade</span> <span class="o">=</span> <span class="s">u&quot;&quot;</span> <span class="c">#\u2588</span>
    <span class="n">digits</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">timeout</span><span class="p">)))</span>
    <span class="n">longest_line_len</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">status</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">status</span><span class="p">[</span><span class="s">&#39;start_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">status</span><span class="p">[</span><span class="s">&#39;total_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">timeout</span>
    <span class="n">status</span><span class="p">[</span><span class="s">&#39;callback_disp_str&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
    <span class="n">status</span><span class="p">[</span><span class="s">&#39;elapsed_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">status</span><span class="p">[</span><span class="s">&#39;message&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">message</span>
    <span class="k">if</span> <span class="n">message</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">print</span> <span class="n">message</span>
    <span class="k">while</span> <span class="n">status</span><span class="p">[</span><span class="s">&#39;elapsed_time&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">status</span><span class="p">[</span><span class="s">&#39;total_time&#39;</span><span class="p">]:</span>
        <span class="n">status</span><span class="p">[</span><span class="s">&#39;present_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">status</span><span class="p">[</span><span class="s">&#39;elapsed_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">status</span><span class="p">[</span><span class="s">&#39;present_time&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">status</span><span class="p">[</span><span class="s">&#39;start_time&#39;</span><span class="p">],</span> <span class="n">status</span><span class="p">[</span><span class="s">&#39;total_time&#39;</span><span class="p">])</span>
        <span class="n">status</span><span class="p">[</span><span class="s">&#39;remaining_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">status</span><span class="p">[</span><span class="s">&#39;total_time&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">status</span><span class="p">[</span><span class="s">&#39;elapsed_time&#39;</span><span class="p">]</span>
        <span class="n">status</span><span class="p">[</span><span class="s">&#39;percent_complete&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">status</span><span class="p">[</span><span class="s">&#39;elapsed_time&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">status</span><span class="p">[</span><span class="s">&#39;total_time&#39;</span><span class="p">]</span>
        <span class="n">complete_length</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">status</span><span class="p">[</span><span class="s">&#39;percent_complete&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">length</span><span class="p">)</span>
        <span class="n">status</span><span class="p">[</span><span class="s">&#39;dark&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">u&quot;&quot;</span> <span class="o">*</span> <span class="n">complete_length</span>
        <span class="n">status</span><span class="p">[</span><span class="s">&#39;light&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">u&quot;&quot;</span> <span class="o">*</span> <span class="p">(</span><span class="n">length</span><span class="o">-</span><span class="n">complete_length</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">display_callback</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">status</span><span class="p">[</span><span class="s">&#39;callback_disp_str&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">display_callback</span><span class="p">(</span><span class="n">status</span><span class="p">)</span>
        <span class="n">print_str</span> <span class="o">=</span>  <span class="s">u&quot;</span><span class="se">\r</span><span class="s">{{dark}}{{light}} {{remaining_time:{digits}.0f}}/{{total_time:{digits}.0f}}s remaining. ({{percent_complete:3.1%}}). {{callback_disp_str}}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">digits</span><span class="o">=</span><span class="n">digits</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">status</span><span class="p">)</span> <span class="c">#</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">print_str</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">longest_line_len</span><span class="p">:</span>
            <span class="n">pad</span> <span class="o">=</span> <span class="s">&quot; &quot;</span> <span class="o">*</span> <span class="p">(</span><span class="n">longest_line_len</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">print_str</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pad</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
            <span class="n">longest_line_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">print_str</span><span class="p">)</span>
        <span class="k">print</span> <span class="n">print_str</span> <span class="o">+</span> <span class="n">pad</span><span class="p">,</span>
        <span class="n">loop_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">status</span><span class="p">[</span><span class="s">&#39;present_time&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">loop_time</span> <span class="o">&lt;</span> <span class="mf">0.1</span><span class="p">:</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span> <span class="o">-</span> <span class="n">loop_time</span><span class="p">)</span>
    <span class="k">print</span>
        </div>
<div class="viewcode-block" id="expand_tabs"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_utils.html#PyICe.lab_instruments.expand_tabs">[docs]</a><span class="k">def</span> <span class="nf">expand_tabs</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="o">*</span><span class="n">column_widths</span><span class="p">,</span> <span class="o">**</span><span class="n">default_column_width</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;like string.expandtabs, but works only on a single line and allows for varying column widths.</span>
<span class="sd">    accepts variable number of positional arguments for each column width.</span>
<span class="sd">    accepts keyword argument &quot;default_column_width&quot; if not all column widths are specified.</span>
<span class="sd">    accepts keyword argument &quot;verbose&quot; to warn if column width is too narrow for contents.&#39;&#39;&#39;</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">default_column_width</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">key</span> <span class="o">!=</span> <span class="s">&quot;default_column_width&quot;</span> <span class="ow">and</span> <span class="n">key</span> <span class="o">!=</span> <span class="s">&quot;verbose&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;&quot;default_column_width&quot; and &quot;verbose&quot; are the only allowed keyword arguments.&#39;</span><span class="p">)</span>
    <span class="n">columns</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="n">out_str</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">column</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">columns</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">column_width</span> <span class="o">=</span> <span class="n">column_widths</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">IndexError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="s">&quot;default_column_width&quot;</span> <span class="ow">in</span> <span class="n">default_column_width</span><span class="p">:</span>
                <span class="n">column_width</span> <span class="o">=</span> <span class="n">default_column_width</span><span class="p">[</span><span class="s">&quot;default_column_width&quot;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;Specify width of each column or specify keyword argument &quot;default_column_width&quot;&#39;</span><span class="p">)</span>
        <span class="n">pad</span> <span class="o">=</span> <span class="n">column_width</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">column</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pad</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">default_column_width</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;verbose&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">):</span>
                <span class="k">print</span> <span class="s">&quot;Column {} undersize by {}.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="mi">1</span><span class="o">-</span><span class="n">pad</span><span class="p">)</span>
            <span class="n">pad</span> <span class="o">=</span> <span class="mi">1</span>
            
        <span class="n">space</span> <span class="o">=</span> <span class="s">&#39; &#39;</span> <span class="o">*</span> <span class="n">pad</span>
        <span class="n">out_str</span> <span class="o">+=</span> <span class="n">column</span> <span class="o">+</span> <span class="n">space</span>
    <span class="k">return</span> <span class="n">out_str</span>
</div>
<div class="viewcode-block" id="column_formatter"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_utils.html#PyICe.lab_instruments.column_formatter">[docs]</a><span class="k">def</span> <span class="nf">column_formatter</span><span class="p">(</span><span class="n">rows_of_columns</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">justification</span><span class="o">=</span><span class="s">&quot;left&quot;</span><span class="p">,</span> <span class="n">fist_line_justification</span><span class="o">=</span><span class="s">&quot;center&quot;</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;takes data of form: [[&#39;ID:&#39;, &#39;REL_NOW_TIME&#39;, &#39;DURATION&#39;, &#39;FMT&#39;, &#39;RAW &#39;, &#39;COUNT&#39;],</span>
<span class="sd">                            [u&#39;00:&#39;, &#39;-00:00:35.290 &#39;, &#39; 00:00:00.431 &#39;, u&#39;41.974488V&#39;, 28438, 1],</span>
<span class="sd">                            [u&#39;01:&#39;, &#39;-00:00:34.859 &#39;, &#39; 00:00:07.216 &#39;, u&#39;-20.675808V&#39;, 51528, 1],</span>
<span class="sd">                            [u&#39;02:&#39;, &#39;-00:00:27.643 &#39;, &#39; 00:00:00.586 &#39;, u&#39;-30.318516V&#39;, 44995, 1],</span>
<span class="sd">                            [u&#39;03:&#39;, &#39;-00:00:27.057 &#39;, &#39; 00:00:17.777 &#39;, u&#39;38.97378V&#39;, 26405, 1],</span>
<span class="sd">                            [u&#39;04:&#39;, &#39;-00:00:09.280 &#39;, &#39; 00:00:00.897 &#39;, u&#39;21.428568V&#39;, 14518, 1],</span>
<span class="sd">                            [u&#39;05:&#39;, &#39;-00:00:08.383 &#39;, &#39; 00:00:08.383+&#39;, u&#39;-23.781312V&#39;, 49424, 1]</span>
<span class="sd">                           ]</span>
<span class="sd">    produces formatted output of form: ID:    REL_NOW_TIME       DURATION          FMT        RAW    COUNT</span>
<span class="sd">                                       00:   -00:00:35.290     00:00:00.431    41.974488V    28438   1</span>
<span class="sd">                                       01:   -00:00:34.859     00:00:07.216    -20.675808V   51528   1</span>
<span class="sd">                                       02:   -00:00:27.643     00:00:00.586    -30.318516V   44995   1</span>
<span class="sd">                                       03:   -00:00:27.057     00:00:17.777    38.97378V     26405   1</span>
<span class="sd">                                       04:   -00:00:09.280     00:00:00.897    21.428568V    14518   1</span>
<span class="sd">                                       05:   -00:00:08.383     00:00:08.383+   -23.781312V   49424   1</span>
<span class="sd">    padding sets spacing between columns</span>
<span class="sd">    first_line_justification and justification control aligment for first and subsequent lines respectively.</span>
<span class="sd">        valid arguments are &#39;left&#39;,&#39;right&#39; and &#39;center&#39;</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">justification</span> <span class="o">==</span> <span class="s">&quot;left&quot;</span><span class="p">:</span>
        <span class="n">sljmethod</span> <span class="o">=</span> <span class="nb">unicode</span><span class="o">.</span><span class="n">ljust</span>
    <span class="k">elif</span> <span class="n">justification</span> <span class="o">==</span> <span class="s">&quot;right&quot;</span><span class="p">:</span>
        <span class="n">sljmethod</span> <span class="o">=</span> <span class="nb">unicode</span><span class="o">.</span><span class="n">rjust</span>
    <span class="k">elif</span> <span class="n">justification</span> <span class="o">==</span> <span class="s">&quot;center&quot;</span><span class="p">:</span>
        <span class="n">sljmethod</span> <span class="o">=</span> <span class="nb">unicode</span><span class="o">.</span><span class="n">center</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;Valid justification arguments are &#39;left&#39;,&#39;right&#39; and &#39;center&#39;&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">fist_line_justification</span> <span class="o">==</span> <span class="s">&quot;left&quot;</span><span class="p">:</span>
        <span class="n">fljmethod</span> <span class="o">=</span> <span class="nb">unicode</span><span class="o">.</span><span class="n">ljust</span>
    <span class="k">elif</span> <span class="n">fist_line_justification</span> <span class="o">==</span> <span class="s">&quot;right&quot;</span><span class="p">:</span>
        <span class="n">fljmethod</span> <span class="o">=</span> <span class="nb">unicode</span><span class="o">.</span><span class="n">rjust</span>
    <span class="k">elif</span> <span class="n">fist_line_justification</span> <span class="o">==</span> <span class="s">&quot;center&quot;</span><span class="p">:</span>
        <span class="n">fljmethod</span> <span class="o">=</span> <span class="nb">unicode</span><span class="o">.</span><span class="n">center</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;Valid fist_line_justification arguments are &#39;left&#39;,&#39;right&#39; and &#39;center&#39;&quot;</span><span class="p">)</span>
    <span class="n">col_widths</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">rows_of_columns</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows_of_columns</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
            <span class="n">col_widths</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">col_widths</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="nb">unicode</span><span class="p">(</span><span class="n">col</span><span class="p">)))</span>
    <span class="n">ret_str</span> <span class="o">=</span> <span class="s">u&#39;&#39;</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span><span class="n">row</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rows_of_columns</span><span class="p">):</span>
        <span class="n">jmethod</span> <span class="o">=</span> <span class="n">fljmethod</span> <span class="k">if</span> <span class="n">idx</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">sljmethod</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span><span class="n">col</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
            <span class="n">ret_str</span> <span class="o">+=</span> <span class="s">u&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">jmethod</span><span class="p">(</span><span class="nb">unicode</span><span class="p">(</span><span class="n">col</span><span class="p">),</span> <span class="n">col_widths</span><span class="p">[</span><span class="n">idx</span><span class="p">]))</span>
            <span class="n">ret_str</span> <span class="o">+=</span> <span class="s">&quot; &quot;</span> <span class="o">*</span> <span class="n">padding</span>
        <span class="n">ret_str</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
    <span class="k">return</span> <span class="n">ret_str</span>
</div>
<span class="k">class</span> <span class="nc">ticker</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">stock_list</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">stock_list</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stock_list</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;LLTC&#39;</span><span class="p">,</span> <span class="s">&#39;ADI&#39;</span><span class="p">,</span> <span class="s">&#39;TXN&#39;</span><span class="p">,</span> <span class="s">&#39;AAPL&#39;</span><span class="p">,</span> <span class="s">&#39;GOOG&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stock_list</span> <span class="o">=</span> <span class="n">stock_list</span>
    <span class="k">def</span> <span class="nf">get_quote</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">symbol</span><span class="p">):</span>
        <span class="n">url</span> <span class="o">=</span> <span class="s">&#39;http://finance.yahoo.com/d/quotes.csv?s=+{}&amp;f=snl1&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ticker</span><span class="p">,</span> <span class="n">desc</span><span class="p">,</span> <span class="n">price</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">([</span><span class="n">urllib</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()])</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
            <span class="k">return</span> <span class="p">{</span><span class="s">&#39;ticker&#39;</span><span class="p">:</span><span class="n">ticker</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;&quot;&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">),</span> <span class="s">&#39;desc&#39;</span><span class="p">:</span><span class="n">desc</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;&quot;&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">),</span> <span class="s">&#39;price&#39;</span><span class="p">:</span><span class="n">price</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;&quot;&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">)}</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">print</span> <span class="n">e</span>
            <span class="k">return</span> <span class="p">{</span><span class="s">&#39;ticker&#39;</span><span class="p">:</span><span class="bp">None</span><span class="p">,</span> <span class="s">&#39;desc&#39;</span><span class="p">:</span><span class="bp">None</span><span class="p">,</span> <span class="s">&#39;price&#39;</span><span class="p">:</span><span class="bp">None</span><span class="p">}</span>
    <span class="k">def</span> <span class="nf">build_tape</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">str</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="k">for</span> <span class="n">stock</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stock_list</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_quote</span><span class="p">(</span><span class="n">stock</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">str</span> <span class="o">+=</span> <span class="s">&#39;{}: {}   &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s">&#39;ticker&#39;</span><span class="p">],</span><span class="n">data</span><span class="p">[</span><span class="s">&#39;price&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">str</span>
    <span class="k">def</span> <span class="nf">rotate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">str</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">str</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">str</span>
    <span class="k">def</span> <span class="nf">tick</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">display_function</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">character_time</span><span class="o">=</span><span class="mf">0.15</span><span class="p">,</span> <span class="n">refresh_time</span><span class="o">=</span><span class="mi">45</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">display_function</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">display_function</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">msg</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">disp</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="n">refresh_cycles</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">refresh_time</span> <span class="o">/</span> <span class="n">character_time</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">build_tape</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">refresh_cycles</span><span class="p">):</span>
                <span class="n">display_function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rotate</span><span class="p">())</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">character_time</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">disp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="k">print</span> <span class="s">&#39;{}</span><span class="se">\r</span><span class="s">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">msg</span><span class="p">),</span>

<div class="viewcode-block" id="modulate"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_utils.html#PyICe.lab_instruments.modulate">[docs]</a><span class="k">def</span> <span class="nf">modulate</span><span class="p">(</span><span class="n">data1</span><span class="p">,</span> <span class="n">data2</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;data1 and data2 are tuples of x and y data that may not have the same number of &#39;x&#39; values. The result is interpolated up to the higher of the two.&#39;&#39;&#39;</span>
    <span class="n">independent</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">product</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">data2</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">data1</span><span class="p">:</span>
            <span class="n">xvalue</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">data2_value</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">xvalue</span><span class="p">,</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">data2</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">data2</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">independent</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xvalue</span><span class="p">)</span>
            <span class="n">product</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">data2_value</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">data2</span><span class="p">:</span>
            <span class="n">xvalue</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">data1_value</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">xvalue</span><span class="p">,</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">data1</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">data1</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">independent</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xvalue</span><span class="p">)</span>
            <span class="n">product</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">data1_value</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">zip</span><span class="p">(</span><span class="n">independent</span><span class="p">,</span> <span class="n">product</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="delete_file"><a class="viewcode-back" href="../../_autosummary/PyICe.lab_utils.html#PyICe.lab_instruments.delete_file">[docs]</a><span class="k">def</span> <span class="nf">delete_file</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">max_tries</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">retry_delay</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Tries to delete a file, retrying if the file is locked (e.g. because it is open</span>
<span class="sd">    in Notepad++, SQLite Manager, or another program), failing gracefully if the file</span>
<span class="sd">    doesn&#39;t (yet) exist. Gives up after a number of retries and raises RuntimeError.</span>
<span class="sd">    Good for removing stale sqlite DBs and log files from old runs.&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">f_stat</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>  <span class="c"># See if file already exists.</span>
        <span class="c"># If not, an exception is thrown and we GOTO the &quot;except OSError:&quot; below.</span>
        <span class="c"># All code from here to the &quot;except OSError:&quot;</span>
        <span class="c"># is only executed if the file actually exists.</span>
        <span class="n">tries</span> <span class="o">=</span> <span class="n">max_tries</span>
        <span class="k">while</span> <span class="n">tries</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
                <span class="k">print</span> <span class="s">&quot;Removed prior run file {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
                <span class="k">break</span>
            <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                <span class="k">print</span> <span class="s">&quot;Unable to remove stale file {} --- RETRYING in {} secs&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">retry_delay</span><span class="p">)</span>
                <span class="n">tries</span> <span class="o">=</span> <span class="n">tries</span> <span class="o">-</span> <span class="mi">1</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">retry_delay</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;Giving up!&quot;</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span>
    <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&quot;No prior&quot;</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="s">&quot;to remove.&quot;</span>
</div>
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="k">pass</span>
    
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../PyICe.html">
              <img class="logo" src="../../_static/tssop.png" alt="Logo"/>
            </a></p>
<h3><a href="../../PyICe.html">Table Of Contents</a></h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../_autosummary/PyICe.lab_instruments.html">PyICe.lab_instruments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../_autosummary/PyICe.lab_core.html">PyICe.lab_core</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../_autosummary/PyICe.lab_utils.html">PyICe.lab_utils</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../_autosummary/PyICe.LTC_plot.html">PyICe.LTC_plot</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../_autosummary/PyICe.lab_gui.html">PyICe.lab_gui</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../_autosummary/PyICe.lab_interfaces.html">PyICe.lab_interfaces</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../_autosummary/PyICe.twi_instrument.html">PyICe.twi_instrument</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../_autosummary/PyICe.twoWireInterface.html">PyICe.twoWireInterface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../_autosummary/PyICe.spi_instrument.html">PyICe.spi_instrument</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../_autosummary/PyICe.spi_interface.html">PyICe.spi_interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../_autosummary/PyICe.visa_wrappers.html">PyICe.visa_wrappers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../_autosummary/PyICe.xml_registers.html">PyICe.xml_registers</a></li>
</ul>
<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../PyICe.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2017, Linear Technology Corporation.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.3.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.6</a>
      
    </div>

    

    
  </body>
</html>